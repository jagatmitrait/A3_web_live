<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Immunization | Health Worker</title>
    
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Shared Sidebar CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='health_worker_sidebar.css') }}">
    
    <style>
        :root {
            --primary-red: #E63946;
            --primary-dark: #c1121f;
            --bg-light: #f8f9fa;
            --card-bg: #ffffff;
            --text-muted: #6c757d;
            --success: #198754;
            --warning: #ffc107;
            --danger: #dc3545;
        }
        
        * { box-sizing: border-box; }
        body { font-family: 'Inter', sans-serif; background: var(--bg-light); margin: 0; display: flex; min-height: 100vh; }
        
        .main-content { margin-left: 260px; padding: 24px; width: calc(100% - 260px); min-height: 100vh; }
        
        .page-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; padding-bottom: 16px; border-bottom: 2px solid var(--primary-red); }
        .page-header h2 { color: var(--primary-red); font-weight: 700; margin: 0; }
        
        @media (max-width: 768px) { .main-content { margin-left: 0; width: 100%; padding: 16px; } }
        
        /* Stats Row */
        .stats-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 24px; }
        .stat-card { background: var(--card-bg); border-radius: 12px; padding: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); border-left: 4px solid var(--primary-red); }
        .stat-card h4 { color: var(--text-muted); font-size: 14px; font-weight: 500; margin: 0 0 8px 0; }
        .stat-card .value { font-size: 28px; font-weight: 700; color: var(--primary-red); }
        
        /* Content Grid */
        .content-grid { display: grid; grid-template-columns: 1fr 360px; gap: 24px; }
        @media (max-width: 1100px) { .content-grid { grid-template-columns: 1fr; } }
        
        /* Panel */
        .panel { background: var(--card-bg); border-radius: 12px; padding: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); margin-bottom: 20px; }
        .panel h3 { color: var(--primary-red); font-weight: 600; margin: 0 0 16px 0; padding-bottom: 12px; border-bottom: 1px solid #eee; }
        
        /* Filter Bar */
        .filter-bar { display: flex; gap: 12px; margin-bottom: 20px; flex-wrap: wrap; }
        .filter-bar select, .filter-bar input { padding: 8px 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px; }
        .filter-bar select:focus, .filter-bar input:focus { border-color: var(--primary-red); outline: none; box-shadow: 0 0 0 3px rgba(230, 57, 70, 0.15); }
        
        /* Vaccine Card */
        .vaccine-card { background: #fff; border: 1px solid #eee; border-radius: 10px; padding: 14px; margin-bottom: 12px; border-left: 4px solid var(--primary-red); }
        .vaccine-card.overdue { border-left-color: var(--danger); background: #fff5f5; }
        .vaccine-card.due { border-left-color: var(--warning); background: #fffbeb; }
        .vaccine-card.completed { border-left-color: var(--success); background: #f0fdf4; }
        .vaccine-card .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px; }
        .vaccine-card .name { font-weight: 600; }
        .vaccine-card .details { font-size: 13px; color: var(--text-muted); }
        .vaccine-card .uid-badge { font-size: 11px; color: #666; background: #f0f0f0; padding: 2px 8px; border-radius: 4px; }
        .vaccine-card .actions { margin-top: 10px; }
        
        /* Modal */
        .modal-header { background: linear-gradient(135deg, var(--primary-red), var(--primary-dark)); color: white; }
        .modal-header .btn-close { filter: brightness(0) invert(1); }
        
        .empty-state { text-align: center; padding: 40px; color: var(--text-muted); }
        
        /* Child info display */
        .child-info-box { background: #f8f9fa; border: 1px solid #e9ecef; border-radius: 8px; padding: 15px; margin-top: 10px; }
        .child-info-box .label { font-size: 12px; color: var(--text-muted); }
        .child-info-box .value { font-weight: 600; }
        
        /* Instruction alert */
        .instruction-alert { background: #fff3cd; border: 1px solid #ffc107; border-radius: 8px; padding: 12px; margin-bottom: 20px; }
        .instruction-alert i { color: #856404; }
    </style>
</head>
<body>
    {% set active_page = 'immunization' %}
    {% include 'health_worker_sidebar.html' %}
    
    <main class="main-content">
        <div class="page-header">
            <h2><i class="fas fa-syringe me-2"></i>Immunization Dashboard</h2>
            <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#addModal"><i class="fas fa-plus me-1"></i> Add Record</button>
        </div>
        
        <!-- Stats Row -->
        <div class="stats-row">
            <div class="stat-card">
                <h4><i class="fas fa-child me-1"></i> Children Registered</h4>
                <div class="value" id="totalChildren">--</div>
            </div>
            <div class="stat-card" style="border-left-color: var(--success);">
                <h4><i class="fas fa-check-circle me-1"></i> Fully Immunized</h4>
                <div class="value" style="color: var(--success);" id="fullyImmunized">--</div>
            </div>
            <div class="stat-card" style="border-left-color: var(--warning);">
                <h4><i class="fas fa-clock me-1"></i> Due Today</h4>
                <div class="value" style="color: var(--warning);" id="dueToday">--</div>
            </div>
            <div class="stat-card" style="border-left-color: var(--danger);">
                <h4><i class="fas fa-exclamation-triangle me-1"></i> Overdue</h4>
                <div class="value" style="color: var(--danger);" id="overdueCount">--</div>
            </div>
        </div>
        
        <!-- Filter Bar -->
        <div class="filter-bar">
            <select id="filterVillage" onchange="loadRecords()">
                <option value="">All Villages</option>
            </select>
            <select id="filterStatus" onchange="loadRecords()">
                <option value="">All Status</option>
                <option value="due">Due Today</option>
                <option value="overdue">Overdue</option>
                <option value="scheduled">Scheduled</option>
                <option value="completed">Completed</option>
            </select>
            <input type="text" id="searchName" placeholder="Search by name..." onkeyup="loadRecords()">
            <button class="btn btn-outline-secondary btn-sm" onclick="loadAll()"><i class="fas fa-sync-alt"></i></button>
        </div>
        
        <div class="content-grid">
            <div>
                <!-- Due Today Panel -->
                <div class="panel">
                    <h3><i class="fas fa-calendar-day me-2"></i>Due Today</h3>
                    <div id="dueTodayList">
                        <div class="empty-state">Loading...</div>
                    </div>
                </div>
                
                <!-- Overdue Panel -->
                <div class="panel">
                    <h3><i class="fas fa-exclamation-circle me-2"></i>Overdue Cases</h3>
                    <div id="overdueList">
                        <div class="empty-state">Loading...</div>
                    </div>
                </div>
                
                <!-- All Records -->
                <div class="panel">
                    <h3><i class="fas fa-list me-2"></i>All Records</h3>
                    <div id="allRecordsList">
                        <div class="empty-state">Loading...</div>
                    </div>
                </div>
            </div>
            
            <!-- Right Sidebar -->
            <div>
                <!-- Vaccine Schedule -->
                <div class="panel">
                    <h3><i class="fas fa-calendar-alt me-2"></i>Vaccine Schedule</h3>
                    <div class="small">
                        <div class="d-flex justify-content-between py-2 border-bottom">
                            <span>BCG</span>
                            <span class="text-muted">At birth</span>
                        </div>
                        <div class="d-flex justify-content-between py-2 border-bottom">
                            <span>OPV-0</span>
                            <span class="text-muted">At birth</span>
                        </div>
                        <div class="d-flex justify-content-between py-2 border-bottom">
                            <span>Hepatitis B</span>
                            <span class="text-muted">At birth</span>
                        </div>
                        <div class="d-flex justify-content-between py-2 border-bottom">
                            <span>Pentavalent 1,2,3</span>
                            <span class="text-muted">6,10,14 weeks</span>
                        </div>
                        <div class="d-flex justify-content-between py-2 border-bottom">
                            <span>OPV 1,2,3</span>
                            <span class="text-muted">6,10,14 weeks</span>
                        </div>
                        <div class="d-flex justify-content-between py-2 border-bottom">
                            <span>Measles 1</span>
                            <span class="text-muted">9-12 months</span>
                        </div>
                        <div class="d-flex justify-content-between py-2">
                            <span>Measles 2</span>
                            <span class="text-muted">16-24 months</span>
                        </div>
                    </div>
                </div>
                
                <!-- Quick Stats -->
                <div class="panel">
                    <h3><i class="fas fa-chart-bar me-2"></i>This Month</h3>
                    <div class="small">
                        <div class="d-flex justify-content-between py-2 border-bottom">
                            <span>Vaccinations Given</span>
                            <strong class="text-success" id="monthlyGiven">0</strong>
                        </div>
                        <div class="d-flex justify-content-between py-2 border-bottom">
                            <span>Pending</span>
                            <strong id="pendingCount">0</strong>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>
    
    <!-- Add Record Modal -->
    <div class="modal fade" id="addModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-plus me-2"></i>Add Immunization Record</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <!-- Instruction Alert -->
                    <div class="instruction-alert">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>Important:</strong> If the child is not registered, please first go to 
                        <a href="{{ url_for('health_worker_village_directory') }}" class="fw-bold">Village Directory</a> 
                        and register the child as a household member to get their UID.
                    </div>
                    
                    <form id="addForm">
                        <!-- Child Selection Section -->
                        <div class="card mb-3">
                            <div class="card-header bg-light">
                                <strong><i class="fas fa-child me-1"></i> Select Child (Required)</strong>
                            </div>
                            <div class="card-body">
                                <!-- Search by UID -->
                                <div class="row mb-3">
                                    <div class="col-md-8">
                                        <label class="form-label">Search by UID *</label>
                                        <div class="input-group">
                                            <input type="text" class="form-control" id="searchUid" placeholder="Enter child's UID...">
                                            <button type="button" class="btn btn-primary" onclick="searchByUid()">
                                                <i class="fas fa-search"></i> Search
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="text-center text-muted my-2">— OR —</div>
                                
                                <!-- Select from Dropdown -->
                                <div class="mb-3">
                                    <label class="form-label">Select Registered Child *</label>
                                    <select class="form-select" id="childSelect" onchange="onChildSelect()">
                                        <option value="">-- Select a child --</option>
                                    </select>
                                </div>
                                
                                <!-- Selected Child Info -->
                                <div id="childInfoBox" class="child-info-box" style="display: none;">
                                    <div class="row">
                                        <div class="col-4">
                                            <div class="label">UID</div>
                                            <div class="value" id="selectedUid">--</div>
                                        </div>
                                        <div class="col-4">
                                            <div class="label">Name</div>
                                            <div class="value" id="selectedName">--</div>
                                        </div>
                                        <div class="col-4">
                                            <div class="label">Age</div>
                                            <div class="value" id="selectedAge">--</div>
                                        </div>
                                    </div>
                                    <div class="row mt-2">
                                        <div class="col-4">
                                            <div class="label">Gender</div>
                                            <div class="value" id="selectedGender">--</div>
                                        </div>
                                        <div class="col-4">
                                            <div class="label">Village</div>
                                            <div class="value" id="selectedVillage">--</div>
                                        </div>
                                        <div class="col-4">
                                            <div class="label">Guardian</div>
                                            <div class="value" id="selectedGuardian">--</div>
                                        </div>
                                    </div>
                                    <input type="hidden" id="householdMemberId">
                                </div>
                            </div>
                        </div>
                        
                        <!-- Vaccine Details Section -->
                        <div class="card">
                            <div class="card-header bg-light">
                                <strong><i class="fas fa-syringe me-1"></i> Vaccine Details</strong>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">Vaccine *</label>
                                        <select class="form-select" id="vaccineName" required>
                                            <option value="">Select vaccine...</option>
                                            <option>BCG</option>
                                            <option>OPV-0</option>
                                            <option>Hepatitis B</option>
                                            <option>Pentavalent-1</option>
                                            <option>OPV-1</option>
                                            <option>Pentavalent-2</option>
                                            <option>OPV-2</option>
                                            <option>Pentavalent-3</option>
                                            <option>OPV-3</option>
                                            <option>IPV</option>
                                            <option>Measles-1</option>
                                            <option>Measles-2</option>
                                            <option>DPT Booster</option>
                                            <option>OPV Booster</option>
                                        </select>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">Due Date *</label>
                                        <input type="date" class="form-control" id="dueDate" required>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">Given Date (if already administered)</label>
                                        <input type="date" class="form-control" id="givenDate">
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">Session Site</label>
                                        <input type="text" class="form-control" id="sessionSite" placeholder="AWC name, PHC...">
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">Manufacturer</label>
                                        <input type="text" class="form-control" id="manufacturer" placeholder="Vaccine manufacturer...">
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">Batch Number</label>
                                        <input type="text" class="form-control" id="batchNumber" placeholder="Batch/Lot number...">
                                    </div>
                                    <div class="col-md-12 mb-3">
                                        <label class="form-label">Adverse Events / Side Effects</label>
                                        <textarea class="form-control" id="adverseEvents" rows="2" placeholder="Any reactions observed..."></textarea>
                                    </div>
                                    <div class="col-md-12 mb-3">
                                        <label class="form-label">Notes</label>
                                        <textarea class="form-control" id="notes" rows="2"></textarea>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveRecord()"><i class="fas fa-save me-1"></i> Save Record</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Give Vaccine Modal -->
    <div class="modal fade" id="giveModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-syringe me-2"></i>Record Vaccination</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p><strong id="giveChildName"></strong> - <span id="giveVaccineName"></span></p>
                    <input type="hidden" id="giveRecordId">
                    <div class="mb-3">
                        <label class="form-label">Batch Number</label>
                        <input type="text" class="form-control" id="giveBatchNumber">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Manufacturer</label>
                        <input type="text" class="form-control" id="giveManufacturer" placeholder="Vaccine manufacturer...">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Session Site</label>
                        <input type="text" class="form-control" id="giveSessionSite">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Adverse Events / Side Effects</label>
                        <textarea class="form-control" id="giveAdverseEvents" rows="2" placeholder="Any reactions observed..."></textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Notes</label>
                        <textarea class="form-control" id="giveNotes" rows="2"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-success" onclick="confirmGive()"><i class="fas fa-check me-1"></i> Mark as Given</button>
                </div>
            </div>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        var allRecords = [];
        var childrenList = [];
        
        document.addEventListener('DOMContentLoaded', function() {
            loadAll();
            loadChildren();
        });
        
        function loadAll() {
            loadStats();
            loadRecords();
        }
        
        async function loadStats() {
            try {
                var response = await fetch('/api/health-worker/immunization/stats');
                var result = await response.json();
                
                if (result.success) {
                    var s = result.stats;
                    document.getElementById('totalChildren').textContent = s.total_children || 0;
                    document.getElementById('fullyImmunized').textContent = s.fully_immunized || 0;
                    document.getElementById('dueToday').textContent = s.due_today || 0;
                    document.getElementById('overdueCount').textContent = s.overdue || 0;
                    document.getElementById('monthlyGiven').textContent = s.monthly_given || 0;
                    document.getElementById('pendingCount').textContent = (s.due_today || 0) + (s.overdue || 0);
                    
                    // Populate village filter
                    var villageSelect = document.getElementById('filterVillage');
                    villageSelect.innerHTML = '<option value="">All Villages</option>';
                    if (s.villages) {
                        s.villages.forEach(function(v) {
                            var opt = document.createElement('option');
                            opt.value = v;
                            opt.textContent = v;
                            villageSelect.appendChild(opt);
                        });
                    }
                }
            } catch (err) {
                console.error('Error loading stats:', err);
            }
        }
        
        async function loadChildren() {
            try {
                var response = await fetch('/api/health-worker/immunization/children');
                var result = await response.json();
                
                if (result.success) {
                    childrenList = result.children;
                    var select = document.getElementById('childSelect');
                    select.innerHTML = '<option value="">-- Select a child --</option>';
                    
                    childrenList.forEach(function(c) {
                        var opt = document.createElement('option');
                        opt.value = c.id;
                        opt.textContent = c.name + ' (UID: ' + (c.uid || 'N/A') + ') - ' + (c.village || 'Unknown');
                        opt.dataset.child = JSON.stringify(c);
                        select.appendChild(opt);
                    });
                }
            } catch (err) {
                console.error('Error loading children:', err);
            }
        }
        
        async function searchByUid() {
            var uid = document.getElementById('searchUid').value.trim();
            if (!uid) {
                alert('Please enter a UID to search');
                return;
            }
            
            try {
                var response = await fetch('/api/health-worker/immunization/search-uid?uid=' + encodeURIComponent(uid));
                var result = await response.json();
                
                if (result.success) {
                    displayChildInfo(result.child);
                } else {
                    alert(result.error || 'Child not found with this UID');
                }
            } catch (err) {
                alert('Error searching for child');
                console.error(err);
            }
        }
        
        function onChildSelect() {
            var select = document.getElementById('childSelect');
            var selectedOption = select.options[select.selectedIndex];
            
            if (selectedOption.dataset.child) {
                var child = JSON.parse(selectedOption.dataset.child);
                displayChildInfo(child);
            } else {
                document.getElementById('childInfoBox').style.display = 'none';
                document.getElementById('householdMemberId').value = '';
            }
        }
        
        function displayChildInfo(child) {
            document.getElementById('householdMemberId').value = child.id;
            document.getElementById('selectedUid').textContent = child.uid || 'N/A';
            document.getElementById('selectedName').textContent = child.name;
            document.getElementById('selectedAge').textContent = child.age ? child.age + ' years' : '--';
            document.getElementById('selectedGender').textContent = child.gender || '--';
            document.getElementById('selectedVillage').textContent = child.village || '--';
            document.getElementById('selectedGuardian').textContent = child.household_head || '--';
            document.getElementById('childInfoBox').style.display = 'block';
            
            // Update search field with UID
            document.getElementById('searchUid').value = child.uid || '';
            
            // Set dropdown if possible
            var select = document.getElementById('childSelect');
            for (var i = 0; i < select.options.length; i++) {
                if (select.options[i].value == child.id) {
                    select.selectedIndex = i;
                    break;
                }
            }
        }
        
        async function loadRecords() {
            try {
                var status = document.getElementById('filterStatus').value;
                var village = document.getElementById('filterVillage').value;
                var search = document.getElementById('searchName').value;
                
                var url = '/api/health-worker/immunization/list?status=' + status + '&village=' + village + '&search=' + search;
                var response = await fetch(url);
                var result = await response.json();
                
                if (result.success) {
                    allRecords = result.records;
                    renderRecords();
                }
            } catch (err) {
                console.error('Error loading records:', err);
            }
        }
        
        function renderRecords() {
            var dueTodayList = document.getElementById('dueTodayList');
            var overdueList = document.getElementById('overdueList');
            var allRecordsList = document.getElementById('allRecordsList');
            
            var dueHtml = '';
            var overdueHtml = '';
            var allHtml = '';
            
            allRecords.forEach(function(r) {
                var card = createCard(r);
                
                if (r.status === 'due') {
                    dueHtml += card;
                }
                if (r.status === 'overdue') {
                    overdueHtml += card;
                }
                allHtml += card;
            });
            
            dueTodayList.innerHTML = dueHtml || '<div class="empty-state">No vaccinations due today</div>';
            overdueList.innerHTML = overdueHtml || '<div class="empty-state">No overdue vaccinations</div>';
            allRecordsList.innerHTML = allHtml || '<div class="empty-state">No records found. Click "Add Record" to create one.</div>';
        }
        
        function createCard(r) {
            var statusClass = r.status;
            var badgeClass = 'bg-secondary';
            var badgeText = r.status.charAt(0).toUpperCase() + r.status.slice(1);
            
            if (r.status === 'due') {
                badgeClass = 'bg-warning text-dark';
                badgeText = 'Due Today';
            } else if (r.status === 'overdue') {
                badgeClass = 'bg-danger';
                badgeText = 'Overdue ' + r.days_overdue + ' days';
            } else if (r.status === 'completed') {
                badgeClass = 'bg-success';
                badgeText = 'Completed';
            }
            
            var ageText = r.age_months !== null ? r.age_months + ' months' : '';
            var actionBtn = '';
            
            if (r.status !== 'completed') {
                actionBtn = '<button class="btn btn-success btn-sm me-1" onclick="openGiveModal(' + r.id + ', \'' + r.child_name + '\', \'' + r.vaccine_name + '\')"><i class="fas fa-syringe me-1"></i>Give</button>';
            }
            
            return '<div class="vaccine-card ' + statusClass + '">' +
                '<div class="header">' +
                    '<span class="name"><i class="fas fa-baby me-1"></i> ' + r.child_name + '</span>' +
                    '<span class="badge ' + badgeClass + '">' + badgeText + '</span>' +
                '</div>' +
                '<div class="details">' +
                    '<i class="fas fa-map-marker-alt me-1"></i> ' + (r.village || '--') + 
                    ' | Age: ' + (ageText || '--') + 
                    ' | <strong>' + r.vaccine_name + '</strong>' +
                '</div>' +
                '<div class="actions">' +
                    actionBtn +
                    '<button class="btn btn-outline-danger btn-sm" onclick="deleteRecord(' + r.id + ')"><i class="fas fa-trash"></i></button>' +
                '</div>' +
            '</div>';
        }
        
        async function saveRecord() {
            var householdMemberId = document.getElementById('householdMemberId').value;
            var vaccineName = document.getElementById('vaccineName').value;
            var dueDate = document.getElementById('dueDate').value;
            
            if (!householdMemberId) {
                alert('Please select a child first. Use UID search or select from dropdown.');
                return;
            }
            
            if (!vaccineName || !dueDate) {
                alert('Please fill in vaccine and due date');
                return;
            }
            
            var data = {
                household_member_id: parseInt(householdMemberId),
                vaccine_name: vaccineName,
                due_date: dueDate,
                given_date: document.getElementById('givenDate').value || null,
                session_site: document.getElementById('sessionSite').value || null,
                manufacturer: document.getElementById('manufacturer').value || null,
                batch_number: document.getElementById('batchNumber').value || null,
                adverse_events: document.getElementById('adverseEvents').value || null,
                notes: document.getElementById('notes').value || null
            };
            
            try {
                var response = await fetch('/api/health-worker/immunization/add', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                var result = await response.json();
                
                if (result.success) {
                    alert('Record added successfully!');
                    var modal = bootstrap.Modal.getInstance(document.getElementById('addModal'));
                    modal.hide();
                    resetAddForm();
                    loadAll();
                } else {
                    alert('Error: ' + result.error);
                }
            } catch (err) {
                alert('Error saving record');
                console.error(err);
            }
        }
        
        function resetAddForm() {
            document.getElementById('addForm').reset();
            document.getElementById('householdMemberId').value = '';
            document.getElementById('childInfoBox').style.display = 'none';
        }
        
        function openGiveModal(id, childName, vaccineName) {
            document.getElementById('giveRecordId').value = id;
            document.getElementById('giveChildName').textContent = childName;
            document.getElementById('giveVaccineName').textContent = vaccineName;
            var modal = new bootstrap.Modal(document.getElementById('giveModal'));
            modal.show();
        }
        
        async function confirmGive() {
            var id = document.getElementById('giveRecordId').value;
            var data = {
                batch_number: document.getElementById('giveBatchNumber').value,
                manufacturer: document.getElementById('giveManufacturer').value,
                session_site: document.getElementById('giveSessionSite').value,
                adverse_events: document.getElementById('giveAdverseEvents').value,
                notes: document.getElementById('giveNotes').value
            };
            
            try {
                var response = await fetch('/api/health-worker/immunization/give/' + id, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                var result = await response.json();
                
                if (result.success) {
                    alert('Vaccination recorded successfully!');
                    var modal = bootstrap.Modal.getInstance(document.getElementById('giveModal'));
                    modal.hide();
                    loadAll();
                } else {
                    alert('Error: ' + result.error);
                }
            } catch (err) {
                alert('Error recording vaccination');
                console.error(err);
            }
        }
        
        async function deleteRecord(id) {
            if (!confirm('Are you sure you want to delete this record?')) return;
            
            try {
                var response = await fetch('/api/health-worker/immunization/delete/' + id, {
                    method: 'DELETE'
                });
                var result = await response.json();
                
                if (result.success) {
                    loadAll();
                } else {
                    alert('Error: ' + result.error);
                }
            } catch (err) {
                alert('Error deleting record');
                console.error(err);
            }
        }
    </script>
</body>
</html>
