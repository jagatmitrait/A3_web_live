<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analytics & Highlights | Health Worker</title>
    
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Shared Sidebar CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='health_worker_sidebar.css') }}">
    
    <style>
        :root {
            --primary-red: #E63946;
            --primary-dark: #c1121f;
            --bg-light: #f8f9fa;
            --card-bg: #ffffff;
            --text-muted: #6c757d;
            --success: #198754;
            --warning: #ffc107;
            --danger: #dc3545;
        }
        
        * { box-sizing: border-box; }
        body { font-family: 'Inter', sans-serif; background: var(--bg-light); margin: 0; display: flex; min-height: 100vh; }
        
        .main-content { margin-left: 260px; padding: 24px; width: calc(100% - 260px); min-height: 100vh; }
        
        .page-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; padding-bottom: 16px; border-bottom: 2px solid var(--primary-red); }
        .page-header h2 { color: var(--primary-red); font-weight: 700; margin: 0; }
        
        @media (max-width: 768px) { .main-content { margin-left: 0; width: 100%; padding: 16px; } }
        
        /* Stats Row */
        .stats-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 24px; }
        .stat-card { background: var(--card-bg); border-radius: 12px; padding: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); border-left: 4px solid var(--primary-red); }
        .stat-card h4 { color: var(--text-muted); font-size: 14px; font-weight: 500; margin: 0 0 8px 0; }
        .stat-card .value { font-size: 28px; font-weight: 700; color: var(--primary-red); }
        
        /* Content Grid */
        .content-grid { display: grid; grid-template-columns: 1fr 380px; gap: 24px; }
        @media (max-width: 1100px) { .content-grid { grid-template-columns: 1fr; } }
        
        /* Panel */
        .panel { background: var(--card-bg); border-radius: 12px; padding: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); margin-bottom: 20px; }
        .panel h3 { color: var(--primary-red); font-weight: 600; margin: 0 0 16px 0; padding-bottom: 12px; border-bottom: 1px solid #eee; }
        
        /* Charts */
        .chart-container { position: relative; height: 280px; }
        
        /* Table */
        .table thead th { background: linear-gradient(135deg, var(--primary-red), var(--primary-dark)); color: white; font-weight: 600; border: none; padding: 12px; }
        .table tbody td { padding: 12px; vertical-align: middle; }
        .table tbody tr:hover { background: #fff5f5; }
        
        /* Heatmap */
        .heatmap { display: grid; grid-template-columns: repeat(14, 1fr); gap: 4px; }
        .heat-cell { width: 100%; padding-top: 100%; border-radius: 4px; }
        .heat-low { background: #e8f5e9; }
        .heat-medium { background: #c8e6c9; }
        .heat-high { background: #66bb6a; }
        
        /* Filter Bar */
        .filter-bar { display: flex; gap: 12px; margin-bottom: 20px; flex-wrap: wrap; }
        .filter-bar select, .filter-bar input { padding: 8px 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px; }
        .filter-bar select:focus, .filter-bar input:focus { border-color: var(--primary-red); outline: none; box-shadow: 0 0 0 3px rgba(230, 57, 70, 0.15); }
        
        /* Highlight Card */
        .highlight-card { background: linear-gradient(135deg, var(--primary-red), var(--primary-dark)); color: white; border-radius: 12px; padding: 20px; margin-bottom: 20px; }
        .highlight-card h4 { font-size: 14px; opacity: 0.9; margin: 0 0 8px 0; }
        .highlight-card .value { font-size: 32px; font-weight: 700; }
        
        /* Risk Badge */
        .risk-high { background: #dc3545; color: white; }
        .risk-medium { background: #ffc107; color: #333; }
        .risk-low { background: #198754; color: white; }
    </style>
</head>
<body>
    {% set active_page = 'analytics' %}
    {% include 'health_worker_sidebar.html' %}
    
    <main class="main-content">
        <div class="page-header">
            <h2><i class="fas fa-chart-line me-2"></i>Analytics & Highlights</h2>
            <button class="btn btn-outline-secondary btn-sm" onclick="loadAnalytics()"><i class="fas fa-sync-alt me-1"></i> Refresh</button>
        </div>
        
        <!-- Stats Row -->
        <div class="stats-row">
            <div class="stat-card">
                <h4><i class="fas fa-home me-1"></i> Total Households</h4>
                <div class="value" id="totalHouseholds">--</div>
            </div>
            <div class="stat-card" style="border-left-color: var(--danger);">
                <h4><i class="fas fa-exclamation-triangle me-1"></i> High-Risk Individuals</h4>
                <div class="value" style="color: var(--danger);" id="highRisk">--</div>
            </div>
            <div class="stat-card" style="border-left-color: var(--success);">
                <h4><i class="fas fa-check-circle me-1"></i> Monthly Visits</h4>
                <div class="value" style="color: var(--success);" id="monthlyVisits">--</div>
            </div>
            <div class="stat-card" style="border-left-color: #0d6efd;">
                <h4><i class="fas fa-syringe me-1"></i> Immunization Coverage</h4>
                <div class="value" style="color: #0d6efd;" id="immunization">--%</div>
            </div>
        </div>
        
        <!-- Filter Bar -->
        <div class="filter-bar">
            <select id="filterVillage">
                <option value="">All Villages</option>
            </select>
            <select id="filterPeriod">
                <option value="month">This Month</option>
                <option value="quarter">This Quarter</option>
                <option value="year">This Year</option>
            </select>
            <input type="month" id="monthPicker">
        </div>
        
        <div class="content-grid">
            <div>
                <!-- Trend Chart -->
                <div class="panel">
                    <h3><i class="fas fa-chart-area me-2"></i>Visit Trend (Last 12 Months)</h3>
                    <div class="chart-container">
                        <canvas id="trendChart"></canvas>
                    </div>
                </div>
                
                <!-- Risk Distribution -->
                <div class="panel">
                    <h3><i class="fas fa-chart-bar me-2"></i>Risk Distribution</h3>
                    <div class="chart-container">
                        <canvas id="riskChart"></canvas>
                    </div>
                </div>
                
                <!-- High-Risk Table -->
                <div class="panel">
                    <h3><i class="fas fa-users me-2"></i>High-Risk Individuals</h3>
                    <div class="table-responsive">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Village</th>
                                    <th>Condition</th>
                                    <th>Risk Level</th>
                                </tr>
                            </thead>
                            <tbody id="riskTable">
                                <tr><td colspan="4" class="text-center text-muted">Loading...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- Right Sidebar -->
            <div>
                <!-- Highlight Card -->
                <div class="highlight-card">
                    <h4><i class="fas fa-star me-1"></i> Monthly Highlight</h4>
                    <div class="value" id="highlightValue">--</div>
                    <small id="highlightText">tasks completed this month</small>
                </div>
                
                <!-- Activity Heatmap -->
                <div class="panel">
                    <h3><i class="fas fa-th me-2"></i>Activity Heatmap</h3>
                    <div class="d-flex gap-2 mb-2 small text-muted">
                        <span><span class="badge" style="background: #e8f5e9;">&nbsp;&nbsp;</span> Low</span>
                        <span><span class="badge" style="background: #c8e6c9;">&nbsp;&nbsp;</span> Medium</span>
                        <span><span class="badge" style="background: #66bb6a;">&nbsp;&nbsp;</span> High</span>
                    </div>
                    <div id="heatmap" class="heatmap"></div>
                </div>
                
                <!-- Condition Breakdown -->
                <div class="panel">
                    <h3><i class="fas fa-heartbeat me-2"></i>Condition Summary</h3>
                    <div class="small">
                        <div class="d-flex justify-content-between py-2 border-bottom">
                            <span><i class="fas fa-baby text-info me-1"></i> Pregnant Women</span>
                            <strong id="pregnantCount">--</strong>
                        </div>
                        <div class="d-flex justify-content-between py-2 border-bottom">
                            <span><i class="fas fa-child text-warning me-1"></i> Children Under 5</span>
                            <strong id="childrenCount">--</strong>
                        </div>
                        <div class="d-flex justify-content-between py-2 border-bottom">
                            <span><i class="fas fa-user-injured text-danger me-1"></i> NCD Patients</span>
                            <strong id="ncdCount">--</strong>
                        </div>
                        <div class="d-flex justify-content-between py-2">
                            <span><i class="fas fa-user text-secondary me-1"></i> Elderly (60+)</span>
                            <strong id="elderlyCount">--</strong>
                        </div>
                    </div>
                </div>
                
                <!-- Recent Alerts -->
                <div class="panel">
                    <h3><i class="fas fa-bell me-2"></i>Recent Alerts</h3>
                    <div id="alertsList" class="small">
                        <div class="d-flex align-items-center py-2 border-bottom">
                            <i class="fas fa-circle text-danger me-2" style="font-size: 8px;"></i>
                            <span>3 high-risk pregnancies need follow-up</span>
                        </div>
                        <div class="d-flex align-items-center py-2 border-bottom">
                            <i class="fas fa-circle text-warning me-2" style="font-size: 8px;"></i>
                            <span>5 immunizations due this week</span>
                        </div>
                        <div class="d-flex align-items-center py-2">
                            <i class="fas fa-circle text-info me-2" style="font-size: 8px;"></i>
                            <span>12 NCD follow-ups pending</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        var trendChart = null;
        var riskChart = null;
        
        document.addEventListener('DOMContentLoaded', function() {
            loadAnalytics();
        });
        
        async function loadAnalytics() {
            try {
                var response = await fetch('/api/health-worker/analytics');
                var result = await response.json();
                
                if (result.success) {
                    var data = result.analytics;
                    
                    // Update stats
                    document.getElementById('totalHouseholds').textContent = data.total_households || 0;
                    document.getElementById('highRisk').textContent = data.high_risk_count || 0;
                    document.getElementById('monthlyVisits').textContent = data.monthly_visits || 0;
                    document.getElementById('immunization').textContent = (data.immunization_coverage || 0) + '%';
                    
                    // Update highlight
                    document.getElementById('highlightValue').textContent = data.monthly_visits || 0;
                    
                    // Update conditions
                    document.getElementById('pregnantCount').textContent = data.pregnant_women || 0;
                    document.getElementById('childrenCount').textContent = data.children_under_5 || 0;
                    document.getElementById('ncdCount').textContent = data.ncd_patients || 0;
                    document.getElementById('elderlyCount').textContent = data.elderly || 0;
                    
                    // Populate village filter
                    var villageSelect = document.getElementById('filterVillage');
                    if (data.villages && data.villages.length > 0) {
                        data.villages.forEach(function(v) {
                            var opt = document.createElement('option');
                            opt.value = v;
                            opt.textContent = v;
                            villageSelect.appendChild(opt);
                        });
                    }
                    
                    // Render charts
                    renderTrendChart(data.trend_data || []);
                    renderRiskChart(data.risk_distribution || {});
                    
                    // Render high-risk table
                    renderRiskTable(data.high_risk_individuals || []);
                    
                    // Render heatmap
                    renderHeatmap(data.heatmap || []);
                }
            } catch (err) {
                console.error('Error loading analytics:', err);
                // Use demo data if API fails
                useDemoData();
            }
        }
        
        function useDemoData() {
            document.getElementById('totalHouseholds').textContent = '156';
            document.getElementById('highRisk').textContent = '23';
            document.getElementById('monthlyVisits').textContent = '89';
            document.getElementById('immunization').textContent = '78%';
            document.getElementById('highlightValue').textContent = '89';
            document.getElementById('pregnantCount').textContent = '12';
            document.getElementById('childrenCount').textContent = '45';
            document.getElementById('ncdCount').textContent = '28';
            document.getElementById('elderlyCount').textContent = '34';
            
            renderTrendChart([45, 52, 48, 61, 55, 67, 72, 68, 75, 82, 78, 89]);
            renderRiskChart({ low: 120, medium: 45, high: 18, critical: 5 });
            renderRiskTable([
                { name: 'Asha Devi', village: 'Rampur', condition: 'High-Risk Pregnancy', risk: 'high' },
                { name: 'Rima Kumari', village: 'Shivpuri', condition: 'Uncontrolled Diabetes', risk: 'critical' },
                { name: 'Sunita', village: 'Rampur', condition: 'Hypertension', risk: 'medium' }
            ]);
            renderHeatmap([]);
        }
        
        function renderTrendChart(data) {
            var ctx = document.getElementById('trendChart').getContext('2d');
            
            if (trendChart) trendChart.destroy();
            
            var labels = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            if (data.length === 0) data = [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0];
            
            trendChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Visits',
                        data: data,
                        borderColor: '#E63946',
                        backgroundColor: 'rgba(230, 57, 70, 0.1)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: { y: { beginAtZero: true } }
                }
            });
        }
        
        function renderRiskChart(data) {
            var ctx = document.getElementById('riskChart').getContext('2d');
            
            if (riskChart) riskChart.destroy();
            
            riskChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Low', 'Medium', 'High', 'Critical'],
                    datasets: [{
                        label: 'Count',
                        data: [data.low || 0, data.medium || 0, data.high || 0, data.critical || 0],
                        backgroundColor: ['#198754', '#ffc107', '#fd7e14', '#dc3545']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: { y: { beginAtZero: true } }
                }
            });
        }
        
        function renderRiskTable(individuals) {
            var tbody = document.getElementById('riskTable');
            
            if (individuals.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted">No high-risk individuals found</td></tr>';
                return;
            }
            
            var html = '';
            individuals.forEach(function(p) {
                var badgeClass = p.risk === 'critical' ? 'bg-danger' : (p.risk === 'high' ? 'bg-warning text-dark' : 'bg-info');
                html += '<tr>';
                html += '<td><strong>' + (p.name || '--') + '</strong></td>';
                html += '<td>' + (p.village || '--') + '</td>';
                html += '<td>' + (p.condition || '--') + '</td>';
                html += '<td><span class="badge ' + badgeClass + '">' + (p.risk || 'unknown').toUpperCase() + '</span></td>';
                html += '</tr>';
            });
            tbody.innerHTML = html;
        }
        
        function renderHeatmap(data) {
            var container = document.getElementById('heatmap');
            container.innerHTML = '';
            
            // Generate 60 cells
            for (var i = 0; i < 60; i++) {
                var level = data[i] ? data[i].level : ['low', 'medium', 'high'][Math.floor(Math.random() * 3)];
                var cell = document.createElement('div');
                cell.className = 'heat-cell heat-' + level;
                container.appendChild(cell);
            }
        }
    </script>
</body>
</html>