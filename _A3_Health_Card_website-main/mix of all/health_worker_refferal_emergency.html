<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Referral & Emergency | Health Worker</title>
    
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Shared Sidebar CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='health_worker_sidebar.css') }}">
    
    <!-- Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <style>
        :root {
            --primary-red: #E63946;
            --primary-dark: #c1121f;
            --bg-light: #f8f9fa;
            --card-bg: #ffffff;
            --text-muted: #6c757d;
            --success: #198754;
            --warning: #ffc107;
            --danger: #dc3545;
        }
        
        * { box-sizing: border-box; }
        
        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg-light);
            margin: 0;
            display: flex;
            min-height: 100vh;
        }
        
        .main-content {
            margin-left: 260px;
            padding: 24px;
            width: calc(100% - 260px);
            min-height: 100vh;
        }
        
        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 2px solid var(--primary-red);
        }
        
        .page-header h2 {
            color: var(--primary-red);
            font-weight: 700;
            margin: 0;
        }
        
        .stats-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }
        
        .stat-card {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 16px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            border-left: 4px solid var(--primary-red);
        }
        
        .stat-card h4 {
            color: var(--text-muted);
            font-size: 13px;
            font-weight: 500;
            margin: 0 0 6px 0;
        }
        
        .stat-card .value {
            font-size: 24px;
            font-weight: 700;
            color: var(--primary-red);
        }
        
        .content-grid {
            display: grid;
            grid-template-columns: 1fr 360px;
            gap: 24px;
        }
        
        @media (max-width: 1200px) { .content-grid { grid-template-columns: 1fr; } }
        @media (max-width: 768px) { .main-content { margin-left: 0; width: 100%; padding: 16px; } }
        
        .panel {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            margin-bottom: 20px;
        }
        
        .panel h3 {
            color: var(--primary-red);
            font-weight: 600;
            margin: 0 0 16px 0;
            padding-bottom: 12px;
            border-bottom: 1px solid #eee;
        }
        
        .form-label { font-weight: 500; color: var(--text-muted); margin-top: 10px; font-size: 14px; }
        .form-control, .form-select { border-radius: 8px; padding: 10px 14px; border: 1px solid #dee2e6; }
        .form-control:focus, .form-select:focus { border-color: var(--primary-red); box-shadow: 0 0 0 3px rgba(230, 57, 70, 0.15); }
        
        .btn-primary { background: var(--primary-red); border-color: var(--primary-red); padding: 10px 20px; font-weight: 600; border-radius: 8px; }
        .btn-primary:hover { background: var(--primary-dark); border-color: var(--primary-dark); }
        .btn-danger-outline { border: 2px solid var(--danger); color: var(--danger); background: transparent; }
        .btn-danger-outline:hover { background: var(--danger); color: white; }
        
        .table thead th { background: linear-gradient(135deg, var(--primary-red), var(--primary-dark)); color: white; font-weight: 600; border: none; padding: 12px; font-size: 13px; }
        .table tbody td { padding: 12px; vertical-align: middle; font-size: 14px; }
        .table tbody tr:hover { background: #fff5f5; }
        
        .patient-search-container { position: relative; }
        .patient-results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 100;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            display: none;
        }
        .patient-results .patient-item {
            padding: 10px 12px;
            cursor: pointer;
            border-bottom: 1px solid #eee;
        }
        .patient-results .patient-item:hover { background: #f8f9fa; }
        .patient-results .patient-item:last-child { border-bottom: none; }
        
        .selected-patient-info {
            background: #e8f5e9;
            border: 1px solid #c8e6c9;
            border-radius: 8px;
            padding: 10px 12px;
            margin-top: 8px;
            display: none;
        }
        
        .urgency-high { background: #ffebee; border-left: 4px solid var(--danger); }
        .urgency-medium { background: #fff8e1; border-left: 4px solid var(--warning); }
        .urgency-low { background: #e8f5e9; border-left: 4px solid var(--success); }
    </style>
</head>
<body>
    {% set active_page = 'referral' %}
    {% include 'health_worker_sidebar.html' %}
    
    <main class="main-content">
        <div class="page-header">
            <h2><i class="fas fa-ambulance me-2"></i>Referral & Emergency</h2>
            <div class="d-flex gap-2">
                <button class="btn btn-outline-secondary btn-sm" onclick="scrollToSection('formSection')"><i class="fas fa-plus me-1"></i> New Referral</button>
                <button class="btn btn-outline-secondary btn-sm" onclick="scrollToSection('recordsSection')"><i class="fas fa-list me-1"></i> Records</button>
            </div>
        </div>
        
        <!-- Stats Row -->
        <div class="stats-row">
            <div class="stat-card">
                <h4><i class="fas fa-clipboard-list me-1"></i> Total Referrals</h4>
                <div class="value" id="totalCount">0</div>
            </div>
            <div class="stat-card" style="border-left-color: var(--danger);">
                <h4><i class="fas fa-exclamation-triangle me-1"></i> Emergency</h4>
                <div class="value" id="emergencyCount" style="color: var(--danger);">0</div>
            </div>
            <div class="stat-card" style="border-left-color: var(--warning);">
                <h4><i class="fas fa-clock me-1"></i> Pending</h4>
                <div class="value" id="pendingCount" style="color: var(--warning);">0</div>
            </div>
            <div class="stat-card" style="border-left-color: var(--success);">
                <h4><i class="fas fa-check-circle me-1"></i> Completed</h4>
                <div class="value" id="completedCount" style="color: var(--success);">0</div>
            </div>
        </div>
        
        <div class="content-grid">
            <div>
                <!-- Referral Form -->
                <div id="formSection" class="panel">
                    <h3><i class="fas fa-edit me-2"></i>New Referral / Emergency</h3>
                    
                    <!-- Patient Search -->
                    <div class="mb-3">
                        <label class="form-label fw-bold"><i class="fas fa-search me-1"></i> Search Patient</label>
                        <div class="patient-search-container">
                            <input type="text" id="patientSearch" class="form-control" placeholder="Type patient name or UID..." oninput="searchPatients()">
                            <input type="hidden" id="patientId">
                            <div id="patientResults" class="patient-results"></div>
                        </div>
                        <div id="selectedPatientInfo" class="selected-patient-info">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <strong id="selectedPatientName"></strong>
                                    <span class="badge bg-secondary ms-2" id="selectedPatientUid"></span>
                                    <span class="badge bg-info ms-1" id="selectedPatientAge"></span>
                                </div>
                                <button type="button" class="btn btn-sm btn-link text-danger p-0" onclick="clearPatient()">
                                    <i class="fas fa-times"></i> Clear
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <label class="form-label">Urgency Level</label>
                            <select id="urgency" class="form-select">
                                <option value="routine">Routine</option>
                                <option value="urgent">Urgent</option>
                                <option value="emergency">Emergency</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Referred To</label>
                            <select id="referredTo" class="form-select">
                                <option value="PHC">Primary Health Centre (PHC)</option>
                                <option value="CHC">Community Health Centre (CHC)</option>
                                <option value="District Hospital">District Hospital</option>
                                <option value="Private Hospital">Private Hospital</option>
                                <option value="Specialist">Specialist Doctor</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="row mt-2">
                        <div class="col-md-3">
                            <label class="form-label">Heart Rate (bpm)</label>
                            <input type="number" id="heartRate" class="form-control" placeholder="72">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Systolic BP</label>
                            <input type="number" id="systolic" class="form-control" placeholder="120">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Diastolic BP</label>
                            <input type="number" id="diastolic" class="form-control" placeholder="80">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">SpOâ‚‚ (%)</label>
                            <input type="number" id="spo2" class="form-control" placeholder="98">
                        </div>
                    </div>
                    
                    <div class="row mt-2">
                        <div class="col-md-6">
                            <label class="form-label">Consciousness (AVPU)</label>
                            <select id="avpu" class="form-select">
                                <option value="A">A - Alert</option>
                                <option value="V">V - Verbal Response</option>
                                <option value="P">P - Pain Response</option>
                                <option value="U">U - Unresponsive</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Referring Facility</label>
                            <input type="text" id="referringFacility" class="form-control" placeholder="Where patient is referred from...">
                        </div>
                    </div>
                    
                    <div class="row mt-2">
                        <div class="col-md-6">
                            <label class="form-label">Transport Mode</label>
                            <select id="transport" class="form-select">
                                <option value="">Not Required</option>
                                <option value="ambulance">Ambulance</option>
                                <option value="vehicle">Private Vehicle</option>
                                <option value="walk">Walk-in</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Follow-up Date</label>
                            <input type="date" id="followUpDate" class="form-control">
                        </div>
                    </div>
                    
                    <div class="mt-2">
                        <label class="form-label">Reason for Referral</label>
                        <textarea id="reason" class="form-control" rows="2" placeholder="Describe symptoms, diagnosis, reason for referral..."></textarea>
                    </div>
                    
                    <div class="mt-3 d-flex gap-2">
                        <button class="btn btn-primary" onclick="submitReferral()">
                            <i class="fas fa-save me-1"></i> Save Referral
                        </button>
                        <button class="btn btn-outline-secondary" onclick="clearForm()">
                            <i class="fas fa-times me-1"></i> Clear
                        </button>
                    </div>
                </div>
                
                <!-- Records -->
                <div id="recordsSection" class="panel">
                    <h3><i class="fas fa-table me-2"></i>Referral Records</h3>
                    
                    <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
                        <div class="d-flex gap-2">
                            <input type="text" id="searchRecords" class="form-control" style="max-width: 180px;" placeholder="Search..." oninput="renderTable()">
                            <select id="filterStatus" class="form-select" style="max-width: 130px;" onchange="renderTable()">
                                <option value="">All Status</option>
                                <option value="pending">Pending</option>
                                <option value="completed">Completed</option>
                                <option value="cancelled">Cancelled</option>
                            </select>
                            <select id="filterUrgency" class="form-select" style="max-width: 130px;" onchange="renderTable()">
                                <option value="">All Urgency</option>
                                <option value="emergency">Emergency</option>
                                <option value="urgent">Urgent</option>
                                <option value="routine">Routine</option>
                            </select>
                        </div>
                        <div class="d-flex gap-2">
                            <button class="btn btn-outline-secondary btn-sm" onclick="exportCSV()"><i class="fas fa-file-csv"></i></button>
                            <button class="btn btn-outline-secondary btn-sm" onclick="exportJSON()"><i class="fas fa-download"></i></button>
                        </div>
                    </div>
                    
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Patient</th>
                                    <th>Referred To</th>
                                    <th>Urgency</th>
                                    <th>Status</th>
                                    <th>Date</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="tableBody"></tbody>
                        </table>
                    </div>
                    
                    <div id="emptyState" class="text-center text-muted py-4" style="display: none;">
                        <i class="fas fa-ambulance fa-3x mb-3 opacity-50"></i>
                        <p>No referrals recorded yet</p>
                    </div>
                </div>
            </div>
            
            <!-- Right Column -->
            <div>
                <div class="panel">
                    <h3><i class="fas fa-chart-pie me-2"></i>Urgency Distribution</h3>
                    <canvas id="urgencyChart" height="180"></canvas>
                    
                    <div class="mt-3 pt-3 border-top">
                        <div class="row text-center">
                            <div class="col-4">
                                <div class="p-2 rounded" style="background:#ffebee;">
                                    <i class="fas fa-ambulance text-danger"></i>
                                    <div class="fw-bold text-danger" id="chartEmergency">0</div>
                                    <small class="text-muted">Emergency</small>
                                </div>
                            </div>
                            <div class="col-4">
                                <div class="p-2 rounded" style="background:#fff8e1;">
                                    <i class="fas fa-exclamation-circle text-warning"></i>
                                    <div class="fw-bold text-warning" id="chartUrgent">0</div>
                                    <small class="text-muted">Urgent</small>
                                </div>
                            </div>
                            <div class="col-4">
                                <div class="p-2 rounded" style="background:#e8f5e9;">
                                    <i class="fas fa-clock text-success"></i>
                                    <div class="fw-bold text-success" id="chartRoutine">0</div>
                                    <small class="text-muted">Routine</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="panel">
                    <h3><i class="fas fa-info-circle me-2"></i>Urgency Guidelines</h3>
                    <div class="small">
                        <div class="d-flex align-items-start mb-2">
                            <span class="badge bg-danger me-2">Emergency</span>
                            <span>Life-threatening: cardiac arrest, severe bleeding, stroke, eclampsia</span>
                        </div>
                        <div class="d-flex align-items-start mb-2">
                            <span class="badge bg-warning text-dark me-2">Urgent</span>
                            <span>Needs attention within hours: high fever, severe pain, fractures</span>
                        </div>
                        <div class="d-flex align-items-start">
                            <span class="badge bg-success me-2">Routine</span>
                            <span>Scheduled referral: follow-ups, specialist consultations</span>
                        </div>
                    </div>
                </div>
                
                <div class="panel">
                    <h3><i class="fas fa-history me-2"></i>Recent Emergency Cases</h3>
                    <div id="recentEmergencies" style="max-height: 150px; overflow-y: auto;">
                        <small class="text-muted">No emergency cases</small>
                    </div>
                </div>
            </div>
        </div>
    </main>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        let referrals = [];
        let chart = null;
        let searchTimeout;
        let selectedPatient = null;
        
        document.addEventListener('DOMContentLoaded', function() {
            loadReferrals();
        document.addEventListener('click', function(e) {
                const results = document.getElementById('patientResults');
                const search = document.getElementById('patientSearch');
                if (!results.contains(e.target) && e.target !== search) {
                    results.style.display = 'none';
                }
            });
        });
        
        function scrollToSection(id) { document.getElementById(id).scrollIntoView({ behavior: 'smooth' }); }
        
        // Patient Search
        function searchPatients() {
            clearTimeout(searchTimeout);
            const query = document.getElementById('patientSearch').value.trim();
            const resultsDiv = document.getElementById('patientResults');
            
            if (query.length < 2) {
                resultsDiv.style.display = 'none';
                return;
            }
            
            searchTimeout = setTimeout(() => {
                fetch(`/api/health-worker/search-patients?q=${encodeURIComponent(query)}`)
                    .then(r => r.json())
                    .then(res => {
                        if (res.success && res.patients && res.patients.length > 0) {
                            resultsDiv.innerHTML = res.patients.map(p => `
                                <div class="patient-item" onclick="selectPatient(${p.id}, '${escapeHtml(p.name)}', '${p.uid || ''}', ${p.age || 0})">
                                    <strong>${escapeHtml(p.name)}</strong>
                                    ${p.uid ? `<span class="badge bg-secondary ms-2">${p.uid}</span>` : ''}
                                    ${p.age ? `<span class="badge bg-info ms-1">${p.age} yrs</span>` : ''}
                                    <small class="text-muted d-block">${p.email || ''}</small>
                                </div>
                            `).join('');
                            resultsDiv.style.display = 'block';
                        } else {
                            resultsDiv.innerHTML = '<div class="p-2 text-muted">No patients found</div>';
                            resultsDiv.style.display = 'block';
                        }
                    })
                    .catch(err => {
                        console.error('Search error:', err);
                        resultsDiv.style.display = 'none';
                    });
            }, 300);
        }
        
        function selectPatient(id, name, uid, age) {
            selectedPatient = { id, name, uid, age };
            document.getElementById('patientId').value = id;
            document.getElementById('patientSearch').value = '';
            document.getElementById('patientResults').style.display = 'none';
            document.getElementById('selectedPatientInfo').style.display = 'block';
            document.getElementById('selectedPatientName').textContent = name;
            document.getElementById('selectedPatientUid').textContent = uid || 'No UID';
            document.getElementById('selectedPatientAge').textContent = age ? `${age} yrs` : '';
        }
        
        function clearPatient() {
            selectedPatient = null;
            document.getElementById('patientId').value = '';
            document.getElementById('selectedPatientInfo').style.display = 'none';
        }
        
        function clearForm() {
            clearPatient();
            document.getElementById('urgency').value = 'routine';
            document.getElementById('referredTo').value = 'PHC';
            document.getElementById('heartRate').value = '';
            document.getElementById('systolic').value = '';
            document.getElementById('diastolic').value = '';
            document.getElementById('spo2').value = '';
            document.getElementById('avpu').value = 'A';
            document.getElementById('transport').value = 'no';
            document.getElementById('reason').value = '';
        }
        
        // Load referrals from backend
        async function loadReferrals() {
            try {
                const response = await fetch('/api/health-worker/referral/list');
                const result = await response.json();
                
                if (result.success) {
                    referrals = result.referrals || [];
                    renderAll();
                } else {
                    console.error('Load error:', result.error);
                }
            } catch (err) {
                console.error('Load error:', err);
            }
        }
        
        // Submit referral
        async function submitReferral() {
            if (!selectedPatient) {
                alert('Please search and select a patient first.');
                return;
            }
            
            const urgency = document.getElementById('urgency').value;
            const referredTo = document.getElementById('referredTo').value;
            const heartRate = parseInt(document.getElementById('heartRate').value) || null;
            const systolic = parseInt(document.getElementById('systolic').value) || null;
            const diastolic = parseInt(document.getElementById('diastolic').value) || null;
            const spo2 = parseInt(document.getElementById('spo2').value) || null;
            const avpu = document.getElementById('avpu').value;
            const transport = document.getElementById('transport').value;
            const reason = document.getElementById('reason').value.trim();
            
            if (!reason) {
                alert('Please enter reason for referral.');
                return;
            }
            
            const bp = (systolic && diastolic) ? `${systolic}/${diastolic}` : '';
            
            const payload = {
                patient_id: selectedPatient.id,
                patient_name: selectedPatient.name,
                urgency: urgency,
                referring_facility: document.getElementById('referringFacility').value,
                referred_to: referredTo,
                transport_mode: transport,
                follow_up_date: document.getElementById('followUpDate').value || null,
                reason: reason,
                vitals: {
                    heart_rate: heartRate,
                    blood_pressure: bp,
                    spo2: spo2,
                    avpu: avpu
                }
            };
            
            try {
                const response = await fetch('/api/health-worker/referral/save', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('Referral saved successfully! ID: ' + result.referral_id);
                    clearForm();
                    loadReferrals();
                } else {
                    alert('Error: ' + (result.error || 'Failed to save'));
                }
            } catch (err) {
                console.error('Save error:', err);
                alert('Failed to save referral. Please try again.');
            }
        }
        
        // Render table
        function renderTable() {
            const tbody = document.getElementById('tableBody');
            const emptyState = document.getElementById('emptyState');
            const q = document.getElementById('searchRecords').value.toLowerCase();
            const statusFilter = document.getElementById('filterStatus').value;
            const urgencyFilter = document.getElementById('filterUrgency').value;
            
            const filtered = referrals.filter(r => {
                if (statusFilter && r.status !== statusFilter) return false;
                if (urgencyFilter && r.urgency !== urgencyFilter) return false;
                if (!q) return true;
                return (r.patient_name && r.patient_name.toLowerCase().includes(q)) ||
                       (r.reason && r.reason.toLowerCase().includes(q)) ||
                       (r.referral_id && r.referral_id.toLowerCase().includes(q));
            });
            
            if (filtered.length === 0) {
                tbody.innerHTML = '';
                emptyState.style.display = 'block';
                return;
            }
            
            emptyState.style.display = 'none';
            tbody.innerHTML = filtered.map(r => `
                <tr class="${r.urgency === 'emergency' ? 'urgency-high' : r.urgency === 'urgent' ? 'urgency-medium' : ''}">
                    <td>
                        <strong>${escapeHtml(r.patient_name)}</strong>
                        <small class="d-block text-muted">${r.referral_id || ''}</small>
                    </td>
                    <td>${escapeHtml(r.referred_to || '--')}</td>
                    <td>
                        <span class="badge bg-${r.urgency === 'emergency' ? 'danger' : r.urgency === 'urgent' ? 'warning' : 'success'}">
                            ${r.urgency || 'routine'}
                        </span>
                    </td>
                    <td>
                        <span class="badge bg-${r.status === 'completed' ? 'success' : r.status === 'cancelled' ? 'secondary' : 'warning text-dark'}">
                            ${r.status || 'pending'}
                        </span>
                    </td>
                    <td><small>${r.created_at ? new Date(r.created_at).toLocaleDateString() : '--'}</small></td>
                    <td>
                        ${r.status === 'pending' ? `
                            <button class="btn btn-outline-success btn-sm" onclick="updateStatus(${r.id}, 'completed')" title="Mark Complete">
                                <i class="fas fa-check"></i>
                            </button>
                        ` : ''}
                        <button class="btn btn-outline-primary btn-sm" onclick="viewDetails(${r.id})" title="View Details">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="btn btn-outline-danger btn-sm" onclick="deleteReferral(${r.id})" title="Delete">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }
        
        function escapeHtml(s) {
            if (!s) return '';
            return String(s).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
        }
        
        // Render stats
        function renderStats() {
            const total = referrals.length;
            const emergency = referrals.filter(r => r.urgency === 'emergency').length;
            const pending = referrals.filter(r => r.status === 'pending').length;
            const completed = referrals.filter(r => r.status === 'completed').length;
            const urgent = referrals.filter(r => r.urgency === 'urgent').length;
            const routine = referrals.filter(r => r.urgency === 'routine').length;
            
            document.getElementById('totalCount').textContent = total;
            document.getElementById('emergencyCount').textContent = emergency;
            document.getElementById('pendingCount').textContent = pending;
            document.getElementById('completedCount').textContent = completed;
            
            // Chart cards
            document.getElementById('chartEmergency').textContent = emergency;
            document.getElementById('chartUrgent').textContent = urgent;
            document.getElementById('chartRoutine').textContent = routine;
            
            // Recent emergencies
            const recentEmerg = referrals.filter(r => r.urgency === 'emergency').slice(0, 5);
            const emergDiv = document.getElementById('recentEmergencies');
            if (recentEmerg.length === 0) {
                emergDiv.innerHTML = '<small class="text-muted">No emergency cases</small>';
            } else {
                emergDiv.innerHTML = recentEmerg.map(r => `
                    <div class="d-flex justify-content-between align-items-center py-2 border-bottom">
                        <div>
                            <small class="fw-bold">${escapeHtml(r.patient_name)}</small>
                            <small class="d-block text-muted">${escapeHtml(r.reason?.substring(0, 30) || '')}...</small>
                        </div>
                        <span class="badge bg-${r.status === 'completed' ? 'success' : 'danger'}">${r.status}</span>
                    </div>
                `).join('');
            }
        }
        
        // Render chart
        function renderChart() {
            const ctx = document.getElementById('urgencyChart');
            const counts = {
                emergency: referrals.filter(r => r.urgency === 'emergency').length,
                urgent: referrals.filter(r => r.urgency === 'urgent').length,
                routine: referrals.filter(r => r.urgency === 'routine').length
            };
            
            if (chart) chart.destroy();
            
            chart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Emergency', 'Urgent', 'Routine'],
                    datasets: [{
                        data: [counts.emergency, counts.urgent, counts.routine],
                        backgroundColor: ['#dc3545', '#ffc107', '#198754'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { position: 'bottom' }
                    }
                }
            });
        }
        
        // Update status
        async function updateStatus(id, newStatus) {
            try {
                const response = await fetch(`/api/health-worker/referral/${id}/status`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status: newStatus })
                });
                
                const result = await response.json();
                if (result.success) {
                    loadReferrals();
                } else {
                    alert('Error: ' + (result.error || 'Failed to update'));
                }
            } catch (err) {
                console.error('Update error:', err);
                alert('Failed to update status');
            }
        }
        
        // View details
        function viewDetails(id) {
            const r = referrals.find(x => x.id === id);
            if (!r) return;
            
            let vitals = r.vitals || {};
            if (typeof vitals === 'string') {
                try { vitals = JSON.parse(vitals); } catch(e) { vitals = {}; }
            }
            
            alert(`
Referral ID: ${r.referral_id || 'N/A'}
Patient: ${r.patient_name}
Urgency: ${r.urgency}
Referred To: ${r.referred_to}
Status: ${r.status}
Reason: ${r.reason}
HR: ${vitals.heart_rate || 'N/A'} | BP: ${vitals.blood_pressure || 'N/A'} | SpO2: ${vitals.spo2 || 'N/A'}%
Date: ${r.created_at ? new Date(r.created_at).toLocaleString() : 'N/A'}
            `.trim());
        }
        
        // Delete referral
        async function deleteReferral(id) {
            if (!confirm('Are you sure you want to delete this referral?')) return;
            
            try {
                const response = await fetch(`/api/health-worker/referral/${id}/delete`, {
                    method: 'DELETE'
                });
                
                const result = await response.json();
                if (result.success) {
                    loadReferrals();
                } else {
                    alert('Error: ' + (result.error || 'Failed to delete'));
                }
            } catch (err) {
                console.error('Delete error:', err);
                alert('Failed to delete');
            }
        }
        
        // Export functions
        function exportCSV() {
            if (referrals.length === 0) { alert('No records to export'); return; }
            const headers = ['Referral ID', 'Patient', 'Urgency', 'Referred To', 'Reason', 'Status', 'Date'];
            const rows = referrals.map(r => [
                r.referral_id, r.patient_name, r.urgency, r.referred_to, r.reason, r.status, r.created_at
            ].map(v => `"${String(v || '').replace(/"/g, '""')}"`).join(','));
            
            const csv = [headers.join(','), ...rows].join('\n');
            const a = document.createElement('a');
            a.href = URL.createObjectURL(new Blob([csv], { type: 'text/csv' }));
            a.download = 'referrals.csv';
            a.click();
        }
        
        function exportJSON() {
            if (referrals.length === 0) { alert('No records to export'); return; }
            const a = document.createElement('a');
            a.href = URL.createObjectURL(new Blob([JSON.stringify(referrals, null, 2)], { type: 'application/json' }));
            a.download = 'referrals.json';
            a.click();
        }
        
        function renderAll() {
            renderTable();
            renderStats();
            renderChart();
        }
    </script>
</body>
</html>
