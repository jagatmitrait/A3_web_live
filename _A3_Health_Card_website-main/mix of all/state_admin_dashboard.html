<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>State Admin Dashboard | A3 Health Card</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='dashboard_theme.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='theme.css') }}">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --sidebar-width: 280px;
            --header-height: 70px;
            --primary-red: #c62828;
            --primary-red-dark: #8e0000;
            --primary-red-light: #ffcdd2;
            --primary-red-lighter: #ffebee;
            --white: #ffffff;
            --light-gray: #f5f7fa;
            --border-color: #e8eaed;
            --dark-text: #1a1a2e;
            --muted-text: #5f6368;
            --success: #00897b;
            --warning: #f4511e;
            --danger: #c62828;
            --info: #1976d2;
            --shadow-sm: 0 1px 3px rgba(0,0,0,0.08);
            --shadow-md: 0 4px 12px rgba(0,0,0,0.1);
            --shadow-lg: 0 8px 24px rgba(0,0,0,0.12);
            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 16px;
        }
        body { background-color: var(--light-gray); font-family: 'Inter', sans-serif; font-size: 14px; }
        .sidebar { width: var(--sidebar-width); height: 100vh; position: fixed; top: 0; left: 0; background: var(--white); border-right: 1px solid var(--border-color); z-index: 1000; display: flex; flex-direction: column; }
        .sidebar-header { height: var(--header-height); display: flex; align-items: center; padding: 0 1.5rem; background: linear-gradient(135deg, var(--primary-red) 0%, var(--primary-red-dark) 100%); }
        .brand-logo { font-size: 1.25rem; font-weight: 700; color: var(--white); text-decoration: none; display: flex; align-items: center; gap: 12px; }
        .nav-link { padding: 0.875rem 1.5rem; color: var(--muted-text); font-weight: 500; display: flex; align-items: center; gap: 12px; border-left: 3px solid transparent; text-decoration: none; }
        .nav-link:hover, .nav-link.active { color: var(--primary-red); background: var(--primary-red-lighter); border-left-color: var(--primary-red); }
        .nav-link i { width: 20px; text-align: center; }
        .main-content { margin-left: var(--sidebar-width); min-height: 100vh; }
        .top-header { height: var(--header-height); background: var(--white); border-bottom: 1px solid var(--border-color); display: flex; align-items: center; justify-content: space-between; padding: 0 2rem; position: sticky; top: 0; z-index: 900; }
        .content-body { padding: 1.5rem 2rem; }
        .page-section { display: none; }
        .page-section.active { display: block; }
        .kpi-card { background: linear-gradient(135deg, var(--primary-red) 0%, var(--primary-red-dark) 100%); color: var(--white); border-radius: var(--radius-lg); padding: 1.5rem; box-shadow: var(--shadow-md); }
        .kpi-card.success { background: linear-gradient(135deg, #00897b 0%, #00695c 100%); }
        .kpi-card.warning { background: linear-gradient(135deg, #fb8c00 0%, #ef6c00 100%); }
        .kpi-card.danger { background: linear-gradient(135deg, #e53935 0%, #c62828 100%); }
        .kpi-card.info { background: linear-gradient(135deg, #1976d2 0%, #1565c0 100%); }
        .kpi-card.purple { background: linear-gradient(135deg, #7b1fa2 0%, #6a1b9a 100%); }
        .kpi-card.orange { background: linear-gradient(135deg, #ff6f00 0%, #e65100 100%); }
        .kpi-value { font-size: 2rem; font-weight: 700; }
        .kpi-label { font-size: 0.85rem; opacity: 0.9; }
        .card { border: 1px solid var(--border-color); border-radius: var(--radius-lg); box-shadow: var(--shadow-sm); }
        .card-header { background: var(--white); border-bottom: 1px solid var(--border-color); padding: 1rem 1.25rem; font-weight: 600; }
        .table th { background: var(--light-gray); font-weight: 600; font-size: 0.8rem; text-transform: uppercase; }
        .badge-rank { width: 28px; height: 28px; border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; font-weight: 700; }
        .badge-rank.gold { background: #ffd700; color: #333; }
        .badge-rank.silver { background: #c0c0c0; color: #333; }
        .badge-rank.bronze { background: #cd7f32; color: #fff; }
        #stateMap { height: 450px; border-radius: var(--radius-md); }
        .user-info { padding: 1rem; border-top: 1px solid var(--border-color); margin-top: auto; background: #263238; }
        .user-avatar { width: 40px; height: 40px; border-radius: 50%; background: var(--primary-red); color: white; display: flex; align-items: center; justify-content: center; font-weight: 600; }
        .btn-primary { background: var(--primary-red); border-color: var(--primary-red); }
        .btn-primary:hover { background: var(--primary-red-dark); border-color: var(--primary-red-dark); }
    </style>
</head>
<body>
    <!-- Sidebar -->
    <nav class="sidebar">
        <div class="sidebar-header">
            <a href="#" class="brand-logo"><i class="fas fa-landmark"></i> State Admin</a>
        </div>
        <div class="nav-menu py-3" style="overflow-y: auto; flex: 1;">
            <a href="#" class="nav-link active" onclick="showPage('dashboard')"><i class="fas fa-th-large"></i> Dashboard</a>
            <a href="#" class="nav-link" onclick="showPage('districts')"><i class="fas fa-map"></i> Districts</a>
            <a href="#" class="nav-link" onclick="showPage('districtAdmins')"><i class="fas fa-user-tie"></i> District Admins</a>
            <a href="#" class="nav-link" onclick="showPage('blocks')"><i class="fas fa-cubes"></i> Blocks</a>
            <a href="#" class="nav-link" onclick="showPage('facilities')"><i class="fas fa-hospital-alt"></i> Facilities</a>
            <a href="#" class="nav-link" onclick="showPage('emergencies')"><i class="fas fa-ambulance"></i> Emergencies</a>
            <a href="#" class="nav-link" onclick="showPage('surveillance')"><i class="fas fa-virus"></i> Disease Surveillance</a>
            <a href="#" class="nav-link" onclick="showPage('map')"><i class="fas fa-map-marked-alt"></i> Epidemiology Map</a>
            <a href="#" class="nav-link" onclick="showPage('analytics')"><i class="fas fa-chart-bar"></i> Comparative Analytics</a>
            <a href="#" class="nav-link" onclick="showPage('reports')"><i class="fas fa-file-alt"></i> Reports</a>
            <a href="#" class="nav-link" onclick="showPage('resources')"><i class="fas fa-coins"></i> Resources</a>
            <a href="#" class="nav-link" onclick="showPage('adminTeam')"><i class="fas fa-users-cog"></i> Admin Team</a>
            <a href="#" class="nav-link" onclick="showPage('securityCenter')"><i class="fas fa-shield-alt"></i> Security Center</a>
            <a href="#" class="nav-link" onclick="showPage('settings')"><i class="fas fa-cog"></i> Settings</a>
        </div>
        <div class="user-info">
            <div class="d-flex align-items-center gap-3">
                <div class="user-avatar">{{ current_user.full_name[0] if current_user.full_name else 'S' }}</div>
                <div class="text-white">
                    <div class="fw-semibold">{{ current_user.full_name or 'State Admin' }}</div>
                    <small class="opacity-75">{{ current_user.state_name or 'State' }}</small>
                </div>
            </div>
            <a href="{{ url_for('logout') }}" class="btn btn-outline-light btn-sm w-100 mt-3"><i class="fas fa-sign-out-alt me-2"></i>Logout</a>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="main-content">
        <header class="top-header">
            <h4 id="pageTitle"><i class="fas fa-th-large me-2"></i>State Dashboard</h4>
            <div class="d-flex align-items-center gap-3">
                <span class="text-muted" id="currentDate"></span>
            </div>
        </header>

        <div class="content-body">
            <!-- Dashboard Page -->
            <section id="dashboardPage" class="page-section active">
                <div class="row g-4 mb-4">
                    <div class="col-md-3"><div class="kpi-card"><div class="kpi-value" id="kpiDistricts">0</div><div class="kpi-label">Total Districts</div></div></div>
                    <div class="col-md-3"><div class="kpi-card success"><div class="kpi-value" id="kpiBlocks">0</div><div class="kpi-label">Total Blocks</div></div></div>
                    <div class="col-md-3"><div class="kpi-card info"><div class="kpi-value" id="kpiFacilities">0</div><div class="kpi-label">Health Facilities</div></div></div>
                    <div class="col-md-3"><div class="kpi-card purple"><div class="kpi-value" id="kpiWorkers">0</div><div class="kpi-label">Health Workers</div></div></div>
                </div>
                <div class="row g-4 mb-4">
                    <div class="col-md-2"><div class="kpi-card orange"><div class="kpi-value" id="kpiPopulation">0</div><div class="kpi-label">Population</div></div></div>
                    <div class="col-md-2"><div class="kpi-card" style="background:linear-gradient(135deg,#5c6bc0,#3949ab)"><div class="kpi-value" id="kpiHouseholds">0</div><div class="kpi-label">Households</div></div></div>
                    <div class="col-md-2"><div class="kpi-card danger"><div class="kpi-value" id="kpiEmergencies">0</div><div class="kpi-label">Active Emergencies</div></div></div>
                    <div class="col-md-2"><div class="kpi-card" style="background:linear-gradient(135deg,#26a69a,#00897b)"><div class="kpi-value" id="kpiScreenings">0</div><div class="kpi-label">Today's Screenings</div></div></div>
                    <div class="col-md-2"><div class="kpi-card" style="background:linear-gradient(135deg,#9c27b0,#7b1fa2)"><div class="kpi-value" id="kpiClients">0</div><div class="kpi-label">Registered Clients</div></div></div>
                </div>
                <div class="row g-4">
                    <div class="col-md-8">
                        <div class="card"><div class="card-header"><i class="fas fa-trophy me-2"></i>District Performance Ranking</div>
                            <div class="card-body p-0"><div class="table-responsive"><table class="table mb-0">
                                <thead><tr><th>Rank</th><th>District</th><th>Blocks</th><th>Workers</th><th>Households</th><th>Score</th></tr></thead>
                                <tbody id="districtRankingTable"><tr><td colspan="6" class="text-center py-4">Loading...</td></tr></tbody>
                            </table></div></div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card h-100"><div class="card-header"><i class="fas fa-chart-pie me-2"></i>District Distribution</div>
                            <div class="card-body"><canvas id="districtChart" height="200"></canvas></div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Districts Page -->
            <section id="districtsPage" class="page-section">
                <div class="card"><div class="card-header d-flex justify-content-between align-items-center">
                    <span><i class="fas fa-map me-2"></i>All Districts</span>
                </div><div class="card-body p-0"><div class="table-responsive"><table class="table mb-0">
                    <thead><tr><th>District ID</th><th>Name</th><th>Admin</th><th>Blocks</th><th>Facilities</th><th>Workers</th><th>Actions</th></tr></thead>
                    <tbody id="districtsTable"><tr><td colspan="7" class="text-center py-4">Loading...</td></tr></tbody>
                </table></div></div></div>
            </section>

            <!-- District Admins Page -->
            <section id="districtAdminsPage" class="page-section">
                <div class="card mb-4"><div class="card-header"><i class="fas fa-user-plus me-2"></i>Create New District Admin</div>
                    <div class="card-body">
                        <form id="createDistrictAdminForm" onsubmit="createDistrictAdmin(event)">
                            <div class="row g-3">
                                <div class="col-md-4"><label class="form-label">Full Name *</label><input type="text" class="form-control" id="daName" placeholder="Enter full name" required></div>
                                <div class="col-md-4"><label class="form-label">Email *</label><input type="email" class="form-control" id="daEmail" placeholder="admin@example.com" required></div>
                                <div class="col-md-4"><label class="form-label">Mobile *</label><input type="text" class="form-control" id="daMobile" placeholder="9876543210" required></div>
                            </div>
                            <div class="row g-3 mt-2">
                                <div class="col-md-4"><label class="form-label">District Name *</label><input type="text" class="form-control" id="daDistrictName" placeholder="e.g., Jaipur, Jodhpur" required></div>
                                <div class="col-md-4"><label class="form-label">Latitude</label><input type="number" step="0.0001" class="form-control" id="daLatitude" placeholder="e.g., 26.9124"></div>
                                <div class="col-md-4"><label class="form-label">Longitude</label><input type="number" step="0.0001" class="form-control" id="daLongitude" placeholder="e.g., 75.7873"></div>
                            </div>
                            <div class="row g-3 mt-2">
                                <div class="col-md-12"><button type="submit" class="btn btn-primary"><i class="fas fa-plus me-2"></i>Create District Admin</button></div>
                            </div>
                        </form>
                    </div>
                </div>
                <div class="card"><div class="card-header"><i class="fas fa-user-tie me-2"></i>District Admins List</div>
                    <div class="card-body p-0"><div class="table-responsive"><table class="table mb-0">
                        <thead><tr><th>UID</th><th>Name</th><th>Email</th><th>District</th><th>Status</th><th>Actions</th></tr></thead>
                        <tbody id="districtAdminsTable"><tr><td colspan="6" class="text-center py-4">Loading...</td></tr></tbody>
                    </table></div></div>
                </div>
            </section>

            <!-- Blocks Page -->
            <section id="blocksPage" class="page-section">
                <div class="card mb-3"><div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-md-4"><label class="form-label">Filter by District</label>
                            <select class="form-select" id="blockDistrictFilter" onchange="loadBlocks()">
                                <option value="">All Districts</option>
                            </select>
                        </div>
                    </div>
                </div></div>
                <div class="card"><div class="card-header"><i class="fas fa-cubes me-2"></i>All Blocks (<span id="blocksCount">0</span>)</div>
                    <div class="card-body p-0"><div class="table-responsive"><table class="table mb-0">
                        <thead><tr><th>Block ID</th><th>Name</th><th>District</th><th>Admin</th><th>Villages</th><th>Workers</th><th>Facilities</th></tr></thead>
                        <tbody id="blocksTable"><tr><td colspan="7" class="text-center py-4">Loading...</td></tr></tbody>
                    </table></div></div>
                </div>
            </section>

            <!-- Facilities Page -->
            <section id="facilitiesPage" class="page-section">
                <div class="row g-4 mb-4">
                    <div class="col-md-3"><div class="kpi-card"><div class="kpi-value" id="facilityTotal">0</div><div class="kpi-label">Total Facilities</div></div></div>
                    <div class="col-md-3"><div class="kpi-card success"><div class="kpi-value" id="facilityPHC">0</div><div class="kpi-label">PHCs</div></div></div>
                    <div class="col-md-3"><div class="kpi-card info"><div class="kpi-value" id="facilitySub">0</div><div class="kpi-label">Sub-Centers</div></div></div>
                    <div class="col-md-3"><div class="kpi-card purple"><div class="kpi-value" id="facilityCHC">0</div><div class="kpi-label">CHCs</div></div></div>
                </div>
                <div class="card"><div class="card-header"><i class="fas fa-hospital-alt me-2"></i>All Facilities</div>
                    <div class="card-body p-0"><div class="table-responsive"><table class="table mb-0">
                        <thead><tr><th>Facility ID</th><th>Name</th><th>Type</th><th>District</th><th>Block</th><th>In-Charge</th><th>Beds</th></tr></thead>
                        <tbody id="facilitiesTable"><tr><td colspan="7" class="text-center py-4">Loading...</td></tr></tbody>
                    </table></div></div>
                </div>
            </section>

            <!-- Emergencies Page -->
            <section id="emergenciesPage" class="page-section">
                <div class="row g-4 mb-4">
                    <div class="col-md-3"><div class="kpi-card warning"><div class="kpi-value" id="emergActive">0</div><div class="kpi-label">Active</div></div></div>
                    <div class="col-md-3"><div class="kpi-card danger"><div class="kpi-value" id="emergCritical">0</div><div class="kpi-label">Critical</div></div></div>
                    <div class="col-md-3"><div class="kpi-card success"><div class="kpi-value" id="emergResolved">0</div><div class="kpi-label">Resolved</div></div></div>
                    <div class="col-md-3"><div class="kpi-card info"><div class="kpi-value" id="emergTotal">0</div><div class="kpi-label">Total</div></div></div>
                </div>
                <div class="card"><div class="card-header"><i class="fas fa-ambulance me-2"></i>All Emergencies</div>
                    <div class="card-body p-0"><div class="table-responsive"><table class="table mb-0">
                        <thead><tr><th>ID</th><th>Type</th><th>Patient</th><th>District</th><th>Block</th><th>Priority</th><th>Status</th><th>Reported</th></tr></thead>
                        <tbody id="emergenciesTable"><tr><td colspan="8" class="text-center py-4">Loading...</td></tr></tbody>
                    </table></div></div>
                </div>
            </section>

            <!-- Disease Surveillance Page -->
            <section id="surveillancePage" class="page-section">
                <div class="row g-4 mb-4">
                    <div class="col-md-3"><div class="kpi-card info"><div class="kpi-value" id="survTotal">0</div><div class="kpi-label">Total Screenings</div></div></div>
                    <div class="col-md-3"><div class="kpi-card danger"><div class="kpi-value" id="survHigh">0</div><div class="kpi-label">High Risk</div></div></div>
                    <div class="col-md-3"><div class="kpi-card warning"><div class="kpi-value" id="survMedium">0</div><div class="kpi-label">Medium Risk</div></div></div>
                    <div class="col-md-3"><div class="kpi-card success"><div class="kpi-value" id="survLow">0</div><div class="kpi-label">Low Risk</div></div></div>
                </div>
                <div class="row g-4">
                    <div class="col-md-6">
                        <div class="card h-100"><div class="card-header"><i class="fas fa-virus me-2"></i>Top Symptoms</div>
                            <div class="card-body"><canvas id="symptomsChart" height="250"></canvas></div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card h-100"><div class="card-header"><i class="fas fa-chart-line me-2"></i>District-wise Trends</div>
                            <div class="card-body p-0"><div class="table-responsive"><table class="table mb-0">
                                <thead><tr><th>District</th><th>Screenings</th><th>High Risk</th></tr></thead>
                                <tbody id="districtTrendsTable"><tr><td colspan="3" class="text-center py-4">Loading...</td></tr></tbody>
                            </table></div></div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Map Page -->
            <section id="mapPage" class="page-section">
                <div class="card"><div class="card-header"><i class="fas fa-map-marked-alt me-2"></i>State Epidemiology Map</div>
                    <div class="card-body"><div id="stateMap"></div></div>
                </div>
            </section>

            <!-- Analytics Page -->
            <section id="analyticsPage" class="page-section">
                <div class="card mb-4"><div class="card-header"><i class="fas fa-chart-bar me-2"></i>District Comparison</div>
                    <div class="card-body"><canvas id="comparisonChart" height="100"></canvas></div>
                </div>
                <div class="card"><div class="card-header"><i class="fas fa-balance-scale me-2"></i>State Averages</div>
                    <div class="card-body">
                        <div class="row text-center">
                            <div class="col-md-4"><h3 id="avgScreening">0%</h3><p class="text-muted">Avg Screening Rate</p></div>
                            <div class="col-md-4"><h3 id="avgCoverage">0%</h3><p class="text-muted">Avg Coverage</p></div>
                            <div class="col-md-4"><h3 id="totalRanked">0</h3><p class="text-muted">Districts Ranked</p></div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Reports Page -->
            <section id="reportsPage" class="page-section">
                <div class="card mb-4"><div class="card-header"><i class="fas fa-plus me-2"></i>Generate Report</div>
                    <div class="card-body">
                        <form onsubmit="generateReport(event)" class="row g-3">
                            <div class="col-md-4"><label class="form-label">Report Type</label><select class="form-select" id="reportType">
                                <option value="monthly">Monthly Health Report</option>
                                <option value="emergency">Emergency Response Report</option>
                                <option value="disease">Disease Surveillance Report</option>
                            </select></div>
                            <div class="col-md-4"><label class="form-label mt-4"></label><button type="submit" class="btn btn-primary w-100"><i class="fas fa-file-export me-2"></i>Generate</button></div>
                        </form>
                    </div>
                </div>
                <div class="card"><div class="card-header"><i class="fas fa-file-alt me-2"></i>Report Preview</div>
                    <div class="card-body" id="reportPreview"><p class="text-muted text-center py-4">Select a report type and click Generate</p></div>
                </div>
            </section>

            <!-- Resources Page -->
            <section id="resourcesPage" class="page-section">
                <div class="row g-4 mb-4">
                    <div class="col-md-3"><div class="kpi-card"><div class="kpi-value" id="resBudget">₹0</div><div class="kpi-label">State Budget</div></div></div>
                    <div class="col-md-3"><div class="kpi-card success"><div class="kpi-value" id="resAllocated">₹0</div><div class="kpi-label">Allocated</div></div></div>
                    <div class="col-md-3"><div class="kpi-card warning"><div class="kpi-value" id="resUtilized">₹0</div><div class="kpi-label">Utilized</div></div></div>
                    <div class="col-md-3"><div class="kpi-card purple"><div class="kpi-value" id="resPercent">0%</div><div class="kpi-label">Utilization %</div></div></div>
                </div>
                <div class="card"><div class="card-header"><i class="fas fa-coins me-2"></i>District-wise Resources</div>
                    <div class="card-body p-0"><div class="table-responsive"><table class="table mb-0">
                        <thead><tr><th>District</th><th>Allocated</th><th>Utilized</th><th>Utilization %</th></tr></thead>
                        <tbody id="resourcesTable"><tr><td colspan="4" class="text-center py-4">Loading...</td></tr></tbody>
                    </table></div></div>
                </div>
            </section>

            <!-- Settings Page -->
            <section id="settingsPage" class="page-section">
                <div class="card"><div class="card-header"><i class="fas fa-cog me-2"></i>State Settings</div>
                    <div class="card-body">
                        <form class="row g-3">
                            <div class="col-md-6"><label class="form-label">State Name</label><input type="text" class="form-control" value="{{ current_user.state_name or '' }}" disabled></div>
                            <div class="col-md-6"><label class="form-label">State ID</label><input type="text" class="form-control" value="{{ current_user.state_id or '' }}" disabled></div>
                            <div class="col-md-6"><label class="form-label">Center Latitude</label><input type="number" step="0.0001" class="form-control" id="stateLat" value="{{ current_user.state_latitude or '' }}"></div>
                            <div class="col-md-6"><label class="form-label">Center Longitude</label><input type="number" step="0.0001" class="form-control" id="stateLng" value="{{ current_user.state_longitude or '' }}"></div>
                            <div class="col-12"><button type="button" class="btn btn-primary" onclick="alert('Settings saved!')"><i class="fas fa-save me-2"></i>Save Settings</button></div>
                        </form>
                    </div>
                </div>
            </section>

            <!-- Admin Team Page (Phase 15) -->
            <section id="adminTeamPage" class="page-section">
                <div class="row g-4 mb-4">
                    <div class="col-md-3"><div class="kpi-card"><div class="kpi-value" id="stateTeamTotal">0</div><div class="kpi-label">Total Admins</div></div></div>
                    <div class="col-md-3"><div class="kpi-card success"><div class="kpi-value" id="stateTeamActive">0</div><div class="kpi-label">Active</div></div></div>
                    <div class="col-md-3"><div class="kpi-card warning"><div class="kpi-value" id="stateTeamPrimary">0</div><div class="kpi-label">Primary</div></div></div>
                    <div class="col-md-3"><div class="kpi-card purple"><div class="kpi-value" id="stateTeamRoles">0</div><div class="kpi-label">Roles</div></div></div>
                </div>
                <div class="card mb-4"><div class="card-header"><i class="fas fa-info-circle me-2"></i>Current State</div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-4"><strong>State ID:</strong> <span id="stateIdDisplay">{{ current_user.state_id or 'N/A' }}</span></div>
                            <div class="col-md-4"><strong>State Name:</strong> <span id="stateNameDisplay">{{ current_user.state_name or 'N/A' }}</span></div>
                            <div class="col-md-4"><strong>Your Role:</strong> <span class="badge bg-danger">Primary Admin</span></div>
                        </div>
                    </div>
                </div>
                <div class="card"><div class="card-header d-flex justify-content-between"><span><i class="fas fa-users me-2"></i>State Admins</span>
                    <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#addStateAdminModal"><i class="fas fa-user-plus me-1"></i>Add Admin</button></div>
                    <div class="card-body p-0"><div class="table-responsive"><table class="table mb-0">
                        <thead><tr><th>Admin</th><th>Email</th><th>Role</th><th>Status</th><th>Assigned</th><th>Actions</th></tr></thead>
                        <tbody id="stateAdminTeamTable"><tr><td colspan="6" class="text-center py-4">Loading...</td></tr></tbody>
                    </table></div></div>
                </div>
            </section>

            <!-- Security Center Page -->
            <section id="securityCenterPage" class="page-section">
                <div class="row g-4 mb-4">
                    <div class="col-md-2"><div class="kpi-card text-center"><div class="kpi-value" id="secLogins24h">0</div><div class="kpi-label">Logins (24h)</div></div></div>
                    <div class="col-md-2"><div class="kpi-card danger text-center"><div class="kpi-value" id="secFailed24h">0</div><div class="kpi-label">Failed (24h)</div></div></div>
                    <div class="col-md-2"><div class="kpi-card success text-center"><div class="kpi-value" id="secActiveSessions">0</div><div class="kpi-label">Active Sessions</div></div></div>
                    <div class="col-md-2"><div class="kpi-card warning text-center"><div class="kpi-value" id="secBlockedIPs">0</div><div class="kpi-label">Blocked IPs</div></div></div>
                    <div class="col-md-2"><div class="kpi-card info text-center"><div class="kpi-value" id="secApiCalls1h">0</div><div class="kpi-label">API Calls (1h)</div></div></div>
                    <div class="col-md-2"><div class="kpi-card purple text-center"><div class="kpi-value" id="secUniqueDevices">0</div><div class="kpi-label">Devices (7d)</div></div></div>
                </div>
                <div class="card mb-4"><div class="card-header d-flex justify-content-between"><span><i class="fas fa-sign-in-alt me-2"></i>Login History (7 Days)</span><button class="btn btn-sm btn-outline-primary" onclick="loadSecurityCenter()"><i class="fas fa-sync-alt"></i></button></div>
                    <div class="card-body p-0"><div class="table-responsive"><table class="table mb-0">
                        <thead><tr><th>Time</th><th>User</th><th>Status</th><th>IP</th><th>Device</th><th>Reason</th></tr></thead>
                        <tbody id="loginLogsTable"><tr><td colspan="6" class="text-center py-4">Loading...</td></tr></tbody>
                    </table></div></div>
                </div>
                <div class="card mb-4"><div class="card-header"><i class="fas fa-users me-2"></i>Active Sessions</div>
                    <div class="card-body p-0"><div class="table-responsive"><table class="table mb-0">
                        <thead><tr><th>User</th><th>Role</th><th>Status</th><th>IP</th><th>Device</th><th>Last Activity</th><th>Action</th></tr></thead>
                        <tbody id="activeSessionsTable"><tr><td colspan="7" class="text-center py-4">Loading...</td></tr></tbody>
                    </table></div></div>
                </div>
                <div class="card"><div class="card-header"><i class="fas fa-exclamation-triangle me-2 text-danger"></i>Failed Login Attempts</div>
                    <div class="card-body p-0"><div class="table-responsive"><table class="table mb-0">
                        <thead><tr><th>Time</th><th>Email</th><th>IP</th><th>Reason</th><th>Status</th><th>Blocked Until</th></tr></thead>
                        <tbody id="failedAttemptsTable"><tr><td colspan="6" class="text-center py-4">Loading...</td></tr></tbody>
                    </table></div></div>
                </div>
            </section>
        </div>
    </main>

    <!-- District Details Modal -->
    <div class="modal fade" id="districtDetailsModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header" style="background: var(--primary-red); color: white;">
                    <h5 class="modal-title"><i class="fas fa-map me-2"></i><span id="modalDistrictName">District Details</span></h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="districtDetailsContent"><div class="text-center py-4"><i class="fas fa-spinner fa-spin fa-2x"></i></div></div>
            </div>
        </div>
    </div>

    <!-- Edit District Admin Modal -->
    <div class="modal fade" id="editDistrictAdminModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-edit me-2"></i>Edit District Admin</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editDistrictAdminForm">
                        <input type="hidden" id="editAdminId">
                        <div class="mb-3"><label class="form-label">Name</label><input type="text" class="form-control" id="editName"></div>
                        <div class="mb-3"><label class="form-label">Mobile</label><input type="text" class="form-control" id="editMobile"></div>
                        <div class="mb-3"><label class="form-label">Status</label>
                            <select class="form-select" id="editStatus">
                                <option value="true">Active</option>
                                <option value="false">Inactive</option>
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveDistrictAdmin()">Save Changes</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add State Admin Modal -->
    <div class="modal fade" id="addStateAdminModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header" style="background: var(--primary-red); color: white;">
                    <h5 class="modal-title"><i class="fas fa-user-plus me-2"></i>Add Admin to State</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3"><label class="form-label">User ID *</label><input type="number" class="form-control" id="newStateAdminUserId" placeholder="Enter user ID" required></div>
                    <div class="mb-3"><label class="form-label">Role *</label>
                        <select class="form-select" id="newStateAdminRole">
                            <option value="deputy_admin">Deputy Admin</option>
                            <option value="data_entry">Data Entry</option>
                            <option value="viewer">Viewer</option>
                        </select>
                    </div>
                    <div class="mb-3"><label class="form-label">Notes</label><textarea class="form-control" id="newStateAdminNotes" rows="2"></textarea></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="addStateAdmin()"><i class="fas fa-user-plus me-1"></i>Add Admin</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Global state
        let stateMap = null;
        let districtChartInstance = null;
        let symptomsChartInstance = null;
        let comparisonChartInstance = null;

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('currentDate').textContent = new Date().toLocaleDateString('en-IN', {weekday:'long', year:'numeric', month:'long', day:'numeric'});
            loadDashboard();
        });

        // Page navigation
        function showPage(page) {
            document.querySelectorAll('.page-section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
            document.getElementById(page + 'Page').classList.add('active');
            event.target.closest('.nav-link').classList.add('active');
            
            const titles = {
                dashboard: '<i class="fas fa-th-large me-2"></i>State Dashboard',
                districts: '<i class="fas fa-map me-2"></i>District Management',
                districtAdmins: '<i class="fas fa-user-tie me-2"></i>District Admins',
                blocks: '<i class="fas fa-cubes me-2"></i>Blocks Overview',
                facilities: '<i class="fas fa-hospital-alt me-2"></i>Facilities Overview',
                emergencies: '<i class="fas fa-ambulance me-2"></i>Emergency Center',
                surveillance: '<i class="fas fa-virus me-2"></i>Disease Surveillance',
                map: '<i class="fas fa-map-marked-alt me-2"></i>Epidemiology Map',
                analytics: '<i class="fas fa-chart-bar me-2"></i>Comparative Analytics',
                reports: '<i class="fas fa-file-alt me-2"></i>Reports Center',
                resources: '<i class="fas fa-coins me-2"></i>Resource Allocation',
                adminTeam: '<i class="fas fa-users-cog me-2"></i>Admin Team',
                securityCenter: '<i class="fas fa-shield-alt me-2"></i>Security Center',
                settings: '<i class="fas fa-cog me-2"></i>Settings'
            };
            document.getElementById('pageTitle').innerHTML = titles[page] || 'Dashboard';
            
            // Load page data
            if(page === 'dashboard') loadDashboard();
            else if(page === 'districts') loadDistricts();
            else if(page === 'districtAdmins') loadDistrictAdmins();
            else if(page === 'blocks') { loadBlockFilters(); loadBlocks(); }
            else if(page === 'facilities') loadFacilities();
            else if(page === 'emergencies') loadEmergencies();
            else if(page === 'surveillance') loadSurveillance();
            else if(page === 'map') loadMap();
            else if(page === 'analytics') loadAnalytics();
            else if(page === 'resources') loadResources();
            else if(page === 'adminTeam') loadStateAdminTeam();
            else if(page === 'securityCenter') loadSecurityCenter();
        }

        // Dashboard
        function loadDashboard() {
            fetch('/api/state-admin/dashboard-stats')
                .then(r => r.json())
                .then(data => {
                    if(data.success) {
                        const s = data.stats;
                        document.getElementById('kpiDistricts').textContent = s.total_districts || 0;
                        document.getElementById('kpiBlocks').textContent = s.total_blocks || 0;
                        document.getElementById('kpiFacilities').textContent = s.total_facilities || 0;
                        document.getElementById('kpiWorkers').textContent = s.total_health_workers || 0;
                        document.getElementById('kpiPopulation').textContent = (s.total_population || 0).toLocaleString();
                        document.getElementById('kpiHouseholds').textContent = s.total_households || 0;
                        document.getElementById('kpiEmergencies').textContent = s.active_emergencies || 0;
                        document.getElementById('kpiScreenings').textContent = s.todays_screenings || 0;
                        document.getElementById('kpiClients').textContent = s.total_clients || 0;
                    }
                }).catch(e => console.error('Dashboard error:', e));
            
            // Load rankings
            fetch('/api/state-admin/district-ranking')
                .then(r => r.json())
                .then(data => {
                    if(data.success) {
                        const rankings = data.rankings || [];
                        document.getElementById('districtRankingTable').innerHTML = rankings.length ? rankings.slice(0,5).map(d => `
                            <tr>
                                <td><span class="badge-rank ${d.rank===1?'gold':d.rank===2?'silver':d.rank===3?'bronze':''}">${d.rank}</span></td>
                                <td><strong>${d.name}</strong></td>
                                <td>${d.blocks}</td>
                                <td>${d.workers}</td>
                                <td>${d.households}</td>
                                <td><span class="badge bg-primary">${d.score}</span></td>
                            </tr>
                        `).join('') : '<tr><td colspan="6" class="text-center py-4 text-muted">No districts found</td></tr>';
                        
                        // Chart
                        renderDistrictChart(rankings.slice(0,5));
                    }
                });
        }

        function renderDistrictChart(districts) {
            const ctx = document.getElementById('districtChart').getContext('2d');
            if(districtChartInstance) districtChartInstance.destroy();
            districtChartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: { 
                    labels: districts.map(d => d.name), 
                    datasets: [{ data: districts.map(d => d.workers), backgroundColor: ['#c62828', '#00897b', '#ff6f00', '#7b1fa2', '#1976d2'] }] 
                },
                options: { responsive: true, plugins: { legend: { position: 'bottom' } } }
            });
        }

        // Districts
        function loadDistricts() {
            fetch('/api/state-admin/districts')
                .then(r => r.json())
                .then(data => {
                    if(data.success) {
                        document.getElementById('districtsTable').innerHTML = data.districts.length ? data.districts.map(d => `
                            <tr>
                                <td><code>${d.district_id}</code></td>
                                <td><strong>${d.name}</strong></td>
                                <td>${d.admin_name || '<span class="text-muted">Not assigned</span>'}</td>
                                <td>${d.total_blocks}</td>
                                <td>${d.total_facilities}</td>
                                <td>${d.total_workers}</td>
                                <td><button class="btn btn-sm btn-outline-primary" onclick="viewDistrictDetails('${d.district_id}')"><i class="fas fa-eye"></i> View</button></td>
                            </tr>
                        `).join('') : '<tr><td colspan="7" class="text-center py-4 text-muted">No districts found</td></tr>';
                    }
                });
        }

        // District Admins
        function loadDistrictAdmins() {
            fetch('/api/state-admin/district-admins')
                .then(r => r.json())
                .then(data => {
                    if(data.success) {
                        document.getElementById('districtAdminsTable').innerHTML = data.admins.length ? data.admins.map(a => `
                            <tr>
                                <td><code>${a.uid}</code></td>
                                <td><strong>${escapeHtml(a.full_name)}</strong></td>
                                <td>${escapeHtml(a.email)}</td>
                                <td>${escapeHtml(a.district_name || '-')}</td>
                                <td><span class="badge bg-${a.is_active ? 'success' : 'danger'}">${a.is_active ? 'Active' : 'Inactive'}</span></td>
                                <td>
                                    <button class="btn btn-sm btn-outline-primary me-1" onclick="editDistrictAdmin(${a.id}, '${escapeHtml(a.full_name)}', '${escapeHtml(a.mobile || '')}', ${a.is_active})"><i class="fas fa-edit"></i></button>
                                    <button class="btn btn-sm btn-outline-danger" onclick="deleteDistrictAdmin(${a.id}, '${escapeHtml(a.full_name)}')"><i class="fas fa-trash"></i></button>
                                </td>
                            </tr>
                        `).join('') : '<tr><td colspan="6" class="text-center py-4 text-muted">No district admins found</td></tr>';
                    }
                });
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text || '';
            return div.innerHTML;
        }

        function createDistrictAdmin(e) {
            e.preventDefault();
            const data = {
                full_name: document.getElementById('daName').value,
                email: document.getElementById('daEmail').value,
                mobile: document.getElementById('daMobile').value,
                district_name: document.getElementById('daDistrictName').value,
                latitude: document.getElementById('daLatitude').value ? parseFloat(document.getElementById('daLatitude').value) : null,
                longitude: document.getElementById('daLongitude').value ? parseFloat(document.getElementById('daLongitude').value) : null
            };
            fetch('/api/state-admin/district-admins', {
                method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(data)
            }).then(r => r.json()).then(res => {
                if(res.success) {
                    const emailStatus = res.email_sent ? '✅ Email sent successfully!' : '⚠️ Email could not be sent (check SMTP settings)';
                    alert(`District Admin created successfully!\n\nUID: ${res.credentials.uid}\nEmail: ${res.credentials.email}\nPassword: ${res.credentials.password}\nDistrict: ${res.credentials.district_name}\n\n${emailStatus}\n\nPlease save these credentials!`);
                    document.getElementById('createDistrictAdminForm').reset();
                    loadDistrictAdmins();
                } else alert('Error: ' + res.error);
            });
        }

        function editDistrictAdmin(id, name, mobile, isActive) {
            document.getElementById('editAdminId').value = id;
            document.getElementById('editName').value = name;
            document.getElementById('editMobile').value = mobile;
            document.getElementById('editStatus').value = isActive ? 'true' : 'false';
            new bootstrap.Modal(document.getElementById('editDistrictAdminModal')).show();
        }

        function saveDistrictAdmin() {
            const id = document.getElementById('editAdminId').value;
            const data = {
                full_name: document.getElementById('editName').value,
                mobile: document.getElementById('editMobile').value,
                is_active: document.getElementById('editStatus').value === 'true'
            };
            fetch(`/api/state-admin/district-admins/${id}`, {
                method: 'PUT', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(data)
            }).then(r => r.json()).then(res => {
                if(res.success) {
                    bootstrap.Modal.getInstance(document.getElementById('editDistrictAdminModal')).hide();
                    alert('Updated successfully!');
                    loadDistrictAdmins();
                } else alert('Error: ' + res.error);
            });
        }

        function deleteDistrictAdmin(id, name) {
            if(!confirm(`Are you sure you want to delete District Admin "${name}"?`)) return;
            fetch(`/api/state-admin/district-admins/${id}`, { method: 'DELETE' })
                .then(r => r.json())
                .then(res => {
                    if(res.success) { alert(res.message); loadDistrictAdmins(); }
                    else alert('Error: ' + res.error);
                });
        }

        // Blocks
        function loadBlockFilters() {
            fetch('/api/state-admin/districts')
                .then(r => r.json())
                .then(data => {
                    if(data.success) {
                        document.getElementById('blockDistrictFilter').innerHTML = '<option value="">All Districts</option>' + 
                            data.districts.map(d => `<option value="${d.district_id}">${d.name}</option>`).join('');
                    }
                });
        }

        function loadBlocks() {
            const districtId = document.getElementById('blockDistrictFilter')?.value || '';
            fetch(`/api/state-admin/blocks${districtId ? '?district_id=' + districtId : ''}`)
                .then(r => r.json())
                .then(data => {
                    if(data.success) {
                        document.getElementById('blocksCount').textContent = data.total;
                        document.getElementById('blocksTable').innerHTML = data.blocks.length ? data.blocks.map(b => `
                            <tr>
                                <td><code>${b.block_id}</code></td>
                                <td><strong>${b.name}</strong></td>
                                <td>${b.district}</td>
                                <td>${b.admin_name || '-'}</td>
                                <td>${b.total_villages}</td>
                                <td>${b.total_workers}</td>
                                <td>${b.total_facilities}</td>
                            </tr>
                        `).join('') : '<tr><td colspan="7" class="text-center py-4 text-muted">No blocks found</td></tr>';
                    }
                });
        }

        // Facilities
        function loadFacilities() {
            fetch('/api/state-admin/facilities')
                .then(r => r.json())
                .then(data => {
                    if(data.success) {
                        const tc = data.type_counts || {};
                        document.getElementById('facilityTotal').textContent = data.total || 0;
                        document.getElementById('facilityPHC').textContent = tc['PHC'] || 0;
                        document.getElementById('facilitySub').textContent = tc['Sub-Center'] || 0;
                        document.getElementById('facilityCHC').textContent = tc['CHC'] || 0;
                        document.getElementById('facilitiesTable').innerHTML = data.facilities.length ? data.facilities.map(f => `
                            <tr>
                                <td><code>${f.facility_id}</code></td>
                                <td><strong>${f.name}</strong></td>
                                <td><span class="badge bg-secondary">${f.facility_type}</span></td>
                                <td>${f.district || '-'}</td>
                                <td>${f.block_id}</td>
                                <td>${f.in_charge_name || '-'}</td>
                                <td>${f.beds_count || 0}</td>
                            </tr>
                        `).join('') : '<tr><td colspan="7" class="text-center">No facilities found</td></tr>';
                    }
                });
        }

        // Emergencies
        function loadEmergencies() {
            fetch('/api/state-admin/emergencies')
                .then(r => r.json())
                .then(data => {
                    if(data.success) {
                        const s = data.summary;
                        document.getElementById('emergActive').textContent = s.active || 0;
                        document.getElementById('emergCritical').textContent = s.critical || 0;
                        document.getElementById('emergResolved').textContent = s.resolved || 0;
                        document.getElementById('emergTotal').textContent = s.total || 0;
                        document.getElementById('emergenciesTable').innerHTML = data.emergencies.length ? data.emergencies.map(e => `
                            <tr>
                                <td><code>${e.emergency_id}</code></td>
                                <td>${e.emergency_type}</td>
                                <td>${e.patient_name || '-'}</td>
                                <td>${e.district || '-'}</td>
                                <td>${e.block_name || '-'}</td>
                                <td><span class="badge bg-${e.priority==='critical'?'danger':e.priority==='high'?'warning':'secondary'}">${e.priority}</span></td>
                                <td><span class="badge bg-${e.status==='resolved'?'success':e.status==='responding'?'info':'warning'}">${e.status}</span></td>
                                <td>${e.reported_at ? new Date(e.reported_at).toLocaleString() : '-'}</td>
                            </tr>
                        `).join('') : '<tr><td colspan="8" class="text-center">No emergencies</td></tr>';
                    }
                });
        }

        // Surveillance
        function loadSurveillance() {
            fetch('/api/state-admin/disease-surveillance')
                .then(r => r.json())
                .then(data => {
                    if(data.success) {
                        const s = data.summary;
                        document.getElementById('survTotal').textContent = s.total_screenings || 0;
                        document.getElementById('survHigh').textContent = s.high_risk || 0;
                        document.getElementById('survMedium').textContent = s.medium_risk || 0;
                        document.getElementById('survLow').textContent = s.low_risk || 0;
                        
                        // Symptoms chart
                        const symptoms = data.top_symptoms || [];
                        const ctx = document.getElementById('symptomsChart').getContext('2d');
                        if(symptomsChartInstance) symptomsChartInstance.destroy();
                        symptomsChartInstance = new Chart(ctx, {
                            type: 'bar',
                            data: { labels: symptoms.map(s => s.symptom), datasets: [{ label: 'Count', data: symptoms.map(s => s.count), backgroundColor: '#c62828' }] },
                            options: { indexAxis: 'y', responsive: true }
                        });
                        
                        // District trends table
                        document.getElementById('districtTrendsTable').innerHTML = data.district_trends.length ? data.district_trends.map(d => `
                            <tr><td>${d.name}</td><td>${d.screenings}</td><td><span class="badge bg-danger">${d.high_risk}</span></td></tr>
                        `).join('') : '<tr><td colspan="3" class="text-center">No data</td></tr>';
                    }
                });
        }

        // Map
        function loadMap() {
            fetch('/api/state-admin/epidemiology-map')
                .then(r => r.json())
                .then(data => {
                    if(data.success) {
                        const center = data.center;
                        if(!stateMap) {
                            stateMap = L.map('stateMap').setView([center.latitude || 27, center.longitude || 74], center.location_set ? 7 : 5);
                            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(stateMap);
                        } else {
                            stateMap.setView([center.latitude || 27, center.longitude || 74], center.location_set ? 7 : 5);
                        }
                        
                        data.districts.forEach(d => {
                            const color = d.risk_level === 'high' ? '#c62828' : d.risk_level === 'medium' ? '#fb8c00' : '#00897b';
                            L.circleMarker([d.latitude, d.longitude], {
                                radius: 15 + (d.stats.workers / 10),
                                color: color,
                                fillColor: color,
                                fillOpacity: 0.6
                            }).bindPopup(`
                                <strong>${d.name}</strong><br>
                                Risk: ${d.risk_level}<br>
                                Blocks: ${d.stats.blocks}<br>
                                Workers: ${d.stats.workers}<br>
                                Households: ${d.stats.households}<br>
                                High Risk HH: ${d.stats.high_risk}
                            `).addTo(stateMap);
                        });
                    }
                });
        }

        // Analytics
        function loadAnalytics() {
            fetch('/api/state-admin/comparative-analytics')
                .then(r => r.json())
                .then(data => {
                    if(data.success) {
                        const avg = data.state_averages;
                        document.getElementById('avgScreening').textContent = (avg.avg_screening_rate || 0) + '%';
                        document.getElementById('avgCoverage').textContent = (avg.avg_coverage || 0) + '%';
                        document.getElementById('totalRanked').textContent = data.analytics.length;
                        
                        const analytics = data.analytics;
                        const ctx = document.getElementById('comparisonChart').getContext('2d');
                        if(comparisonChartInstance) comparisonChartInstance.destroy();
                        comparisonChartInstance = new Chart(ctx, {
                            type: 'bar',
                            data: {
                                labels: analytics.map(a => a.name),
                                datasets: [
                                    { label: 'Workers', data: analytics.map(a => a.workers), backgroundColor: '#c62828' },
                                    { label: 'Households', data: analytics.map(a => a.households), backgroundColor: '#00897b' }
                                ]
                            },
                            options: { responsive: true, scales: { y: { beginAtZero: true } } }
                        });
                    }
                });
        }

        // Reports
        function generateReport(e) {
            e.preventDefault();
            const type = document.getElementById('reportType').value;
            fetch(`/api/state-admin/reports?type=${type}`)
                .then(r => r.json())
                .then(data => {
                    if(data.success) {
                        const r = data.report;
                        let html = `<h5>${r.title}</h5><p class="text-muted">${r.state || ''} - ${r.period || ''}</p>`;
                        if(r.summary) {
                            html += '<div class="row g-3">';
                            for(const [key, val] of Object.entries(r.summary)) {
                                html += `<div class="col-md-3"><div class="card bg-light"><div class="card-body text-center"><h4>${val}</h4><small>${key.replace(/_/g, ' ')}</small></div></div></div>`;
                            }
                            html += '</div>';
                        }
                        document.getElementById('reportPreview').innerHTML = html;
                    }
                });
        }

        // Resources
        function loadResources() {
            fetch('/api/state-admin/resource-stats')
                .then(r => r.json())
                .then(data => {
                    if(data.success) {
                        const b = data.state_budget;
                        document.getElementById('resBudget').textContent = '₹' + (b.total || 0).toLocaleString();
                        document.getElementById('resAllocated').textContent = '₹' + (b.allocated_to_districts || 0).toLocaleString();
                        document.getElementById('resUtilized').textContent = '₹' + (b.utilized || 0).toLocaleString();
                        document.getElementById('resPercent').textContent = (b.utilization_percent || 0) + '%';
                        document.getElementById('resourcesTable').innerHTML = data.district_resources.length ? data.district_resources.map(r => `
                            <tr>
                                <td><strong>${r.name}</strong></td>
                                <td>₹${(r.allocated || 0).toLocaleString()}</td>
                                <td>₹${(r.utilized || 0).toLocaleString()}</td>
                                <td>
                                    <div class="progress" style="height: 20px;">
                                        <div class="progress-bar" style="width: ${r.utilization_percent}%">${r.utilization_percent}%</div>
                                    </div>
                                </td>
                            </tr>
                        `).join('') : '<tr><td colspan="4" class="text-center">No data</td></tr>';
                    }
                });
        }

        // View District Details
        function viewDistrictDetails(districtId) {
            document.getElementById('districtDetailsContent').innerHTML = '<div class="text-center py-4"><i class="fas fa-spinner fa-spin fa-2x"></i></div>';
            new bootstrap.Modal(document.getElementById('districtDetailsModal')).show();
            
            fetch(`/api/state-admin/district-details/${districtId}`)
                .then(r => r.json())
                .then(data => {
                    if(data.success) {
                        document.getElementById('modalDistrictName').textContent = data.district.name;
                        document.getElementById('districtDetailsContent').innerHTML = `
                            <div class="row g-4 mb-4">
                                <div class="col-md-4"><div class="card bg-primary text-white"><div class="card-body text-center"><h3>${data.stats.total_blocks}</h3><small>Blocks</small></div></div></div>
                                <div class="col-md-4"><div class="card bg-success text-white"><div class="card-body text-center"><h3>${data.stats.total_facilities}</h3><small>Facilities</small></div></div></div>
                                <div class="col-md-4"><div class="card bg-info text-white"><div class="card-body text-center"><h3>${data.stats.total_workers}</h3><small>Workers</small></div></div></div>
                            </div>
                            <div class="row g-4 mb-4">
                                <div class="col-md-6">
                                    <h6><i class="fas fa-user-tie me-2"></i>District Admin</h6>
                                    ${data.district.admin ? `
                                        <p class="mb-1"><strong>${data.district.admin.name}</strong></p>
                                        <p class="text-muted mb-0">${data.district.admin.email} ${data.district.admin.mobile ? '• ' + data.district.admin.mobile : ''}</p>
                                    ` : '<p class="text-muted">Not assigned</p>'}
                                </div>
                                <div class="col-md-6">
                                    <h6><i class="fas fa-chart-pie me-2"></i>Worker Types</h6>
                                    ${Object.entries(data.worker_types).map(([k,v]) => `<span class="badge bg-secondary me-1">${k}: ${v}</span>`).join('') || '<span class="text-muted">No workers</span>'}
                                </div>
                            </div>
                            <h6><i class="fas fa-cubes me-2"></i>Blocks</h6>
                            <div class="table-responsive"><table class="table table-sm">
                                <thead><tr><th>Block ID</th><th>Name</th><th>Villages</th><th>Population</th></tr></thead>
                                <tbody>
                                    ${data.blocks.map(b => `<tr><td><code>${b.block_id}</code></td><td>${b.name}</td><td>${b.total_villages}</td><td>${b.total_population}</td></tr>`).join('')}
                                </tbody>
                            </table></div>
                        `;
                    } else {
                        document.getElementById('districtDetailsContent').innerHTML = '<div class="alert alert-danger">Error loading details</div>';
                    }
                });
        }

        // ==================== PHASE 12: INVENTORY & ASSETS ====================
        async function loadInventorySummary() {
            try {
                const res = await fetch('/api/admin/inventory-summary');
                const data = await res.json();
                if (data.success) console.log('State Inventory Summary:', data);
            } catch (e) { console.error('Inventory error:', e); }
        }
        loadInventorySummary();

        // ==================== ADMIN TEAM MANAGEMENT (Phase 15) ====================
        async function loadStateAdminTeam() {
            const stateId = document.getElementById('stateIdDisplay')?.textContent || '';
            document.getElementById('stateAdminTeamTable').innerHTML = '<tr><td colspan="6" class="text-center py-4"><i class="fas fa-spinner fa-spin"></i> Loading...</td></tr>';
            try {
                const response = await fetch(`/api/admin/entity-admins/state/${encodeURIComponent(stateId)}`);
                const data = await response.json();
                if (data.success) {
                    document.getElementById('stateTeamTotal').textContent = data.count || 0;
                    document.getElementById('stateTeamActive').textContent = data.count || 0;
                    document.getElementById('stateTeamPrimary').textContent = data.admins?.filter(a => a.is_primary).length || 0;
                    const rolesRes = await fetch('/api/admin/roles'); const rolesData = await rolesRes.json();
                    document.getElementById('stateTeamRoles').textContent = rolesData.roles?.length || 0;
                    if (data.admins?.length) {
                        document.getElementById('stateAdminTeamTable').innerHTML = data.admins.map(a => `
                            <tr><td><strong>${a.name || 'Unknown'}</strong></td><td>${a.email || 'N/A'}</td>
                            <td>${a.is_primary ? '<span class="badge bg-danger">Primary</span>' : `<span class="badge bg-secondary">${a.role_name || 'Admin'}</span>`}</td>
                            <td><span class="badge bg-success">Active</span></td><td>${a.assigned_at || 'N/A'}</td>
                            <td>${!a.is_primary ? `<button class="btn btn-sm btn-outline-danger" onclick="removeStateAdmin(${a.id})"><i class="fas fa-trash"></i></button>` : '<span class="badge bg-light text-muted">Protected</span>'}</td></tr>
                        `).join('');
                    } else {
                        document.getElementById('stateAdminTeamTable').innerHTML = '<tr><td colspan="6" class="text-center py-4 text-muted">No admins assigned.</td></tr>';
                    }
                }
            } catch (e) { console.error(e); document.getElementById('stateAdminTeamTable').innerHTML = '<tr><td colspan="6" class="text-center text-danger">Error</td></tr>'; }
        }
        async function addStateAdmin() {
            const userId = document.getElementById('newStateAdminUserId')?.value;
            const role = document.getElementById('newStateAdminRole')?.value;
            const notes = document.getElementById('newStateAdminNotes')?.value;
            const stateId = document.getElementById('stateIdDisplay')?.textContent || '';
            const stateName = document.getElementById('stateNameDisplay')?.textContent || '';
            if (!userId) { alert('Please enter a user ID'); return; }
            try {
                const res = await fetch('/api/admin/assignments', { method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ user_id: parseInt(userId), entity_type: 'state', entity_id: stateId, entity_name: stateName, role_name: role, notes: notes, is_primary: false }) });
                const data = await res.json();
                if (data.success) { alert('Admin added!'); bootstrap.Modal.getInstance(document.getElementById('addStateAdminModal'))?.hide(); loadStateAdminTeam(); }
                else alert('Error: ' + (data.error || 'Unknown'));
            } catch (e) { alert('Error'); }
        }
        async function removeStateAdmin(assignmentId) {
            if (!confirm('Remove this admin?')) return;
            try { const res = await fetch(`/api/admin/assignments/${assignmentId}`, { method: 'DELETE' }); const data = await res.json();
                if (data.success) { alert('Removed'); loadStateAdminTeam(); } else alert('Error: ' + data.error);
            } catch (e) { alert('Error'); }
        }
        
        // Security Center
        async function loadSecurityCenter() {
            try {
                const [summaryRes, logsRes, sessionsRes, failedRes] = await Promise.all([
                    fetch('/api/admin/security/summary'),
                    fetch('/api/admin/security/login-logs?days=7&per_page=20'),
                    fetch('/api/admin/security/sessions?status=active&per_page=15'),
                    fetch('/api/admin/security/failed-attempts?days=7&per_page=15')
                ]);
                const summary = await summaryRes.json();
                if (summary.success) {
                    const s = summary.summary;
                    document.getElementById('secLogins24h').textContent = s.logins_24h || 0;
                    document.getElementById('secFailed24h').textContent = s.failed_24h || 0;
                    document.getElementById('secActiveSessions').textContent = s.active_sessions || 0;
                    document.getElementById('secBlockedIPs').textContent = s.blocked_ips || 0;
                    document.getElementById('secApiCalls1h').textContent = s.api_calls_1h || 0;
                    document.getElementById('secUniqueDevices').textContent = s.unique_devices_7d || 0;
                }
                const logs = await logsRes.json();
                document.getElementById('loginLogsTable').innerHTML = logs.success && logs.logs.length ? logs.logs.map(l => `
                    <tr><td class="small">${l.created_at ? new Date(l.created_at).toLocaleString() : '-'}</td><td>${l.user_name || l.email || '-'}</td>
                    <td><span class="badge ${l.status === 'success' ? 'bg-success' : 'bg-danger'}">${l.status}</span></td>
                    <td><small>${l.ip_address || '-'}</small></td><td>${l.browser || '-'}</td><td>${l.failure_reason || '-'}</td></tr>
                `).join('') : '<tr><td colspan="6" class="text-center text-muted py-4">No login logs found</td></tr>';
                const sessions = await sessionsRes.json();
                document.getElementById('activeSessionsTable').innerHTML = sessions.success && sessions.sessions.length ? sessions.sessions.map(s => `
                    <tr><td>${s.user_name || 'Unknown'}</td><td><span class="badge bg-secondary">${s.user_type || '-'}</span></td>
                    <td><span class="badge bg-success">${s.status}</span></td><td><small>${s.ip_address || '-'}</small></td><td>${s.browser || '-'}</td>
                    <td class="small">${s.last_activity ? new Date(s.last_activity).toLocaleString() : '-'}</td>
                    <td><button class="btn btn-sm btn-outline-danger" onclick="terminateSession('${s.session_id}')"><i class="fas fa-times"></i></button></td></tr>
                `).join('') : '<tr><td colspan="7" class="text-center text-muted py-4">No active sessions found</td></tr>';
                const failed = await failedRes.json();
                document.getElementById('failedAttemptsTable').innerHTML = failed.success && failed.attempts.length ? failed.attempts.map(a => `
                    <tr class="${a.is_blocked ? 'table-danger' : ''}"><td class="small">${a.created_at ? new Date(a.created_at).toLocaleString() : '-'}</td>
                    <td>${a.email || '-'}</td><td><small>${a.ip_address || '-'}</small></td><td>${a.failure_reason || '-'}</td>
                    <td>${a.is_blocked ? '<span class="badge bg-danger">Blocked</span>' : '<span class="badge bg-warning">Warning</span>'}</td>
                    <td class="small">${a.blocked_until ? new Date(a.blocked_until).toLocaleString() : '-'}</td></tr>
                `).join('') : '<tr><td colspan="6" class="text-center text-muted py-4">No failed attempts found</td></tr>';
            } catch (e) { console.error('Error loading security center:', e); }
        }
        async function terminateSession(sessionId) {
            if (!confirm('Terminate this session?')) return;
            try {
                const res = await fetch(`/api/admin/security/sessions/${sessionId}/terminate`, { method: 'POST', headers: { 'Content-Type': 'application/json' } });
                const data = await res.json();
                if (data.success) { alert('Session terminated'); loadSecurityCenter(); } else alert('Error: ' + (data.error || 'Unknown'));
            } catch (e) { console.error(e); alert('Error terminating session'); }
        }
    </script>
</body>
</html>
