<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Village Directory | Health Worker</title>
    
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Shared Sidebar CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='health_worker_sidebar.css') }}">
    
    <style>
        :root {
            --primary-red: #E63946;
            --primary-dark: #c1121f;
            --bg-light: #f8f9fa;
            --card-bg: #ffffff;
            --text-muted: #6c757d;
            --success: #198754;
            --warning: #ffc107;
            --danger: #dc3545;
        }
        
        * { box-sizing: border-box; }
        body { font-family: 'Inter', sans-serif; background: var(--bg-light); margin: 0; display: flex; min-height: 100vh; }
        
        .main-content { margin-left: 260px; padding: 24px; width: calc(100% - 260px); min-height: 100vh; }
        
        .page-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; padding-bottom: 16px; border-bottom: 2px solid var(--primary-red); }
        .page-header h2 { color: var(--primary-red); font-weight: 700; margin: 0; }
        
        @media (max-width: 768px) { .main-content { margin-left: 0; width: 100%; padding: 16px; } }
        
        .stats-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 16px; margin-bottom: 24px; }
        .stat-card { background: var(--card-bg); border-radius: 12px; padding: 16px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); border-left: 4px solid var(--primary-red); }
        .stat-card h4 { color: var(--text-muted); font-size: 13px; font-weight: 500; margin: 0 0 6px 0; }
        .stat-card .value { font-size: 24px; font-weight: 700; color: var(--primary-red); }
        
        .content-grid { display: grid; grid-template-columns: 1fr 360px; gap: 24px; }
        @media (max-width: 1100px) { .content-grid { grid-template-columns: 1fr; } }
        
        .panel { background: var(--card-bg); border-radius: 12px; padding: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); margin-bottom: 20px; }
        .panel h3 { color: var(--primary-red); font-weight: 600; margin: 0 0 16px 0; padding-bottom: 12px; border-bottom: 1px solid #eee; }
        
        .form-label { font-weight: 500; color: var(--text-muted); margin-top: 10px; font-size: 14px; }
        .form-control, .form-select { border-radius: 8px; padding: 10px 14px; }
        .form-control:focus, .form-select:focus { border-color: var(--primary-red); box-shadow: 0 0 0 3px rgba(230, 57, 70, 0.15); }
        
        .btn-primary { background: var(--primary-red); border-color: var(--primary-red); padding: 10px 20px; font-weight: 600; border-radius: 8px; }
        .btn-primary:hover { background: var(--primary-dark); border-color: var(--primary-dark); }
        
        .table thead th { background: linear-gradient(135deg, var(--primary-red), var(--primary-dark)); color: white; font-weight: 600; border: none; padding: 12px; font-size: 13px; }
        .table tbody td { padding: 12px; vertical-align: middle; font-size: 14px; }
        .table tbody tr:hover { background: #fff5f5; }
        
        .risk-high { border-left: 4px solid var(--danger); }
        .risk-medium { border-left: 4px solid var(--warning); }
        .risk-low { border-left: 4px solid var(--success); }
        
        .member-card { background: #f8f9fa; border-radius: 8px; padding: 12px; margin-bottom: 10px; border-left: 3px solid var(--primary-red); }
        .member-card.linked { border-left-color: var(--success); background: #f0fff4; }
        
        .health-flag { display: inline-block; padding: 2px 8px; border-radius: 4px; font-size: 11px; margin-right: 4px; margin-bottom: 2px; }
        .flag-pregnant { background: #e8f5e9; color: #2e7d32; }
        .flag-ncd { background: #fff3e0; color: #ef6c00; }
        .flag-child { background: #e3f2fd; color: #1976d2; }
        .flag-elderly { background: #fce4ec; color: #c2185b; }
        .flag-risk { background: #ffebee; color: #c62828; }
        .flag-linked { background: #e8f5e9; color: #198754; font-weight: 600; }
        
        .action-btn { padding: 6px 10px; margin: 0 2px; border-radius: 6px; }
        
        .client-search-results { max-height: 200px; overflow-y: auto; border: 1px solid #dee2e6; border-radius: 8px; margin-top: 8px; }
        .client-search-item { padding: 10px 12px; cursor: pointer; border-bottom: 1px solid #eee; }
        .client-search-item:hover { background: #fff5f5; }
        
        .nav-tabs .nav-link { color: var(--text-muted); }
        .nav-tabs .nav-link.active { color: var(--primary-red); border-color: var(--primary-red) var(--primary-red) #fff; }
    </style>
</head>
<body>
    {% set active_page = 'directory' %}
    {% include 'health_worker_sidebar.html' %}
    
    <main class="main-content">
        <div class="page-header">
            <h2><i class="fas fa-map-marked-alt me-2"></i>Village & Household Directory</h2>
            <button class="btn btn-primary btn-sm" onclick="scrollToForm()"><i class="fas fa-plus me-1"></i> Add Household</button>
        </div>
        
        <!-- Stats -->
        <div class="stats-row">
            <div class="stat-card">
                <h4><i class="fas fa-home me-1"></i> Total Households</h4>
                <div class="value" id="totalHouseholds">0</div>
            </div>
            <div class="stat-card">
                <h4><i class="fas fa-users me-1"></i> Total Members</h4>
                <div class="value" id="totalMembers">0</div>
            </div>
            <div class="stat-card" style="border-left-color: #198754;">
                <h4><i class="fas fa-map-marker-alt me-1"></i> Villages</h4>
                <div class="value" id="totalVillages" style="color: #198754;">0</div>
            </div>
            <div class="stat-card" style="border-left-color: var(--danger);">
                <h4><i class="fas fa-exclamation-triangle me-1"></i> High Risk</h4>
                <div class="value" id="highRiskCount" style="color: var(--danger);">0</div>
            </div>
            <div class="stat-card" style="border-left-color: #e91e63;">
                <h4><i class="fas fa-baby me-1"></i> Pregnant</h4>
                <div class="value" id="pregnantCount" style="color: #e91e63;">0</div>
            </div>
        </div>
        
        <div class="content-grid">
            <div>
                <!-- Add/Edit Household Form -->
                <div id="formSection" class="panel">
                    <h3 id="formTitle"><i class="fas fa-edit me-2"></i>Add Household</h3>
                    <input type="hidden" id="editingId">
                    
                    <div class="row">
                        <div class="col-md-6">
                            <label class="form-label">Head of Household *</label>
                            <input type="text" id="headName" class="form-control" placeholder="Full name">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Village *</label>
                            <input type="text" id="village" class="form-control" placeholder="Village name">
                        </div>
                    </div>
                    
                    <div class="row mt-2">
                        <div class="col-md-6">
                            <label class="form-label">Address / House No</label>
                            <input type="text" id="address" class="form-control" placeholder="House number, street">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Phone</label>
                            <input type="text" id="phone" class="form-control" placeholder="Mobile number">
                        </div>
                    </div>
                    
                    <div class="row mt-2">
                        <div class="col-md-4">
                            <label class="form-label">Risk Level</label>
                            <select id="riskLevel" class="form-select">
                                <option value="low">Low</option>
                                <option value="medium">Medium</option>
                                <option value="high">High</option>
                            </select>
                        </div>
                        <div class="col-md-8">
                            <label class="form-label">Health Flags</label>
                            <div class="d-flex flex-wrap gap-2 mt-1">
                                <div class="form-check">
                                    <input type="checkbox" id="hasPregnant" class="form-check-input">
                                    <label class="form-check-label" for="hasPregnant">Pregnant Woman</label>
                                </div>
                                <div class="form-check">
                                    <input type="checkbox" id="hasChild" class="form-check-input">
                                    <label class="form-check-label" for="hasChild">Child Under 5</label>
                                </div>
                                <div class="form-check">
                                    <input type="checkbox" id="hasElderly" class="form-check-input">
                                    <label class="form-check-label" for="hasElderly">Elderly (60+)</label>
                                </div>
                                <div class="form-check">
                                    <input type="checkbox" id="hasNCD" class="form-check-input">
                                    <label class="form-check-label" for="hasNCD">NCD Patient</label>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Collapsible Sections for Phase 2 Fields -->
                    <div class="accordion mt-3" id="socioEconomicAccordion">
                        <!-- Social Category -->
                        <div class="accordion-item">
                            <h2 class="accordion-header">
                                <button class="accordion-button collapsed py-2" type="button" data-bs-toggle="collapse" data-bs-target="#socialCategory">
                                    <i class="fas fa-users me-2 text-primary"></i> Social Category (Optional)
                                </button>
                            </h2>
                            <div id="socialCategory" class="accordion-collapse collapse" data-bs-parent="#socioEconomicAccordion">
                                <div class="accordion-body">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <label class="form-label small">Caste/Tribe/Ethnicity</label>
                                            <select id="casteTribe" class="form-select form-select-sm">
                                                <option value="">-- Select --</option>
                                                <option value="General">General</option>
                                                <option value="SC">Scheduled Caste (SC)</option>
                                                <option value="ST">Scheduled Tribe (ST)</option>
                                                <option value="OBC">Other Backward Class (OBC)</option>
                                                <option value="EWS">Economically Weaker Section (EWS)</option>
                                                <option value="Other">Other</option>
                                            </select>
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label small">Religion</label>
                                            <select id="religion" class="form-select form-select-sm">
                                                <option value="">-- Select --</option>
                                                <option value="Hindu">Hindu</option>
                                                <option value="Muslim">Muslim</option>
                                                <option value="Christian">Christian</option>
                                                <option value="Sikh">Sikh</option>
                                                <option value="Buddhist">Buddhist</option>
                                                <option value="Jain">Jain</option>
                                                <option value="Other">Other</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Employment & Income -->
                        <div class="accordion-item">
                            <h2 class="accordion-header">
                                <button class="accordion-button collapsed py-2" type="button" data-bs-toggle="collapse" data-bs-target="#employmentIncome">
                                    <i class="fas fa-briefcase me-2 text-success"></i> Employment & Income
                                </button>
                            </h2>
                            <div id="employmentIncome" class="accordion-collapse collapse" data-bs-parent="#socioEconomicAccordion">
                                <div class="accordion-body">
                                    <div class="row g-2">
                                        <div class="col-md-6">
                                            <label class="form-label small">Occupation</label>
                                            <input type="text" id="occupation" class="form-control form-control-sm" placeholder="Primary occupation">
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label small">Employer Type</label>
                                            <select id="employerType" class="form-select form-select-sm">
                                                <option value="">-- Select --</option>
                                                <option value="Government">Government</option>
                                                <option value="Private">Private</option>
                                                <option value="Self-employed">Self-employed</option>
                                                <option value="Daily Wage">Daily Wage</option>
                                                <option value="Agriculture">Agriculture</option>
                                                <option value="Unemployed">Unemployed</option>
                                                <option value="Retired">Retired</option>
                                            </select>
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label small">Income Category</label>
                                            <select id="incomeCategory" class="form-select form-select-sm">
                                                <option value="">-- Select --</option>
                                                <option value="BPL">Below Poverty Line (BPL)</option>
                                                <option value="APL">Above Poverty Line (APL)</option>
                                                <option value="EWS">Economically Weaker Section</option>
                                                <option value="Middle">Middle Income</option>
                                                <option value="High">High Income</option>
                                            </select>
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label small">Poverty Index / Score</label>
                                            <input type="text" id="povertyIndex" class="form-control form-control-sm" placeholder="e.g., 0-25">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Education & Welfare -->
                        <div class="accordion-item">
                            <h2 class="accordion-header">
                                <button class="accordion-button collapsed py-2" type="button" data-bs-toggle="collapse" data-bs-target="#educationWelfare">
                                    <i class="fas fa-graduation-cap me-2 text-info"></i> Education & Welfare
                                </button>
                            </h2>
                            <div id="educationWelfare" class="accordion-collapse collapse" data-bs-parent="#socioEconomicAccordion">
                                <div class="accordion-body">
                                    <div class="row g-2">
                                        <div class="col-md-4">
                                            <label class="form-label small">Education Level</label>
                                            <select id="educationLevel" class="form-select form-select-sm">
                                                <option value="">-- Select --</option>
                                                <option value="Illiterate">Illiterate</option>
                                                <option value="Primary">Primary (1-5)</option>
                                                <option value="Middle">Middle (6-8)</option>
                                                <option value="Secondary">Secondary (9-10)</option>
                                                <option value="Higher Secondary">Higher Secondary (11-12)</option>
                                                <option value="Graduate">Graduate</option>
                                                <option value="Post Graduate">Post Graduate</option>
                                            </select>
                                        </div>
                                        <div class="col-md-4">
                                            <label class="form-label small">Ration Card Number</label>
                                            <input type="text" id="rationCardNumber" class="form-control form-control-sm" placeholder="Card number">
                                        </div>
                                        <div class="col-md-4">
                                            <label class="form-label small">Ration Card Type</label>
                                            <select id="rationCardType" class="form-select form-select-sm">
                                                <option value="">-- Select --</option>
                                                <option value="AAY">AAY (Antyodaya)</option>
                                                <option value="PHH">PHH (Priority)</option>
                                                <option value="BPL">BPL</option>
                                                <option value="APL">APL</option>
                                                <option value="None">No Ration Card</option>
                                            </select>
                                        </div>
                                        <div class="col-md-8">
                                            <label class="form-label small">Welfare Schemes Enrolled</label>
                                            <input type="text" id="welfareSchemes" class="form-control form-control-sm" placeholder="e.g., PM-JAY, MGNREGA, Ujjwala">
                                        </div>
                                        <div class="col-md-4">
                                            <label class="form-label small">Disability Certificate</label>
                                            <input type="text" id="disabilityCertificate" class="form-control form-control-sm" placeholder="Certificate No.">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Housing & Utilities -->
                        <div class="accordion-item">
                            <h2 class="accordion-header">
                                <button class="accordion-button collapsed py-2" type="button" data-bs-toggle="collapse" data-bs-target="#housingUtilities">
                                    <i class="fas fa-home me-2 text-warning"></i> Housing & Utilities
                                </button>
                            </h2>
                            <div id="housingUtilities" class="accordion-collapse collapse" data-bs-parent="#socioEconomicAccordion">
                                <div class="accordion-body">
                                    <div class="row g-2">
                                        <div class="col-md-4">
                                            <label class="form-label small">Housing Type</label>
                                            <select id="housingType" class="form-select form-select-sm">
                                                <option value="">-- Select --</option>
                                                <option value="Pucca">Pucca (Permanent)</option>
                                                <option value="Semi-pucca">Semi-pucca</option>
                                                <option value="Kaccha">Kaccha (Temporary)</option>
                                                <option value="Hut">Hut/Jhuggi</option>
                                                <option value="Homeless">Homeless</option>
                                            </select>
                                        </div>
                                        <div class="col-md-4">
                                            <label class="form-label small">Ownership Status</label>
                                            <select id="ownershipStatus" class="form-select form-select-sm">
                                                <option value="">-- Select --</option>
                                                <option value="Owned">Owned</option>
                                                <option value="Rented">Rented</option>
                                                <option value="Government">Government Allotted</option>
                                                <option value="Ancestral">Ancestral</option>
                                                <option value="Homeless">Homeless</option>
                                            </select>
                                        </div>
                                        <div class="col-md-4">
                                            <label class="form-label small">Water Source</label>
                                            <select id="waterSource" class="form-select form-select-sm">
                                                <option value="">-- Select --</option>
                                                <option value="Piped">Piped Water</option>
                                                <option value="Hand Pump">Hand Pump</option>
                                                <option value="Bore Well">Bore Well</option>
                                                <option value="Well">Open Well</option>
                                                <option value="River/Pond">River/Pond</option>
                                                <option value="Tanker">Water Tanker</option>
                                            </select>
                                        </div>
                                        <div class="col-md-4">
                                            <label class="form-label small">Sanitation Facility</label>
                                            <select id="sanitationFacility" class="form-select form-select-sm">
                                                <option value="">-- Select --</option>
                                                <option value="Flush Toilet">Flush Toilet</option>
                                                <option value="Pit Latrine">Pit Latrine</option>
                                                <option value="Community">Community Toilet</option>
                                                <option value="Open">Open Defecation</option>
                                            </select>
                                        </div>
                                        <div class="col-md-4">
                                            <label class="form-label small">Cooking Fuel</label>
                                            <select id="cookingFuel" class="form-select form-select-sm">
                                                <option value="">-- Select --</option>
                                                <option value="LPG">LPG Gas</option>
                                                <option value="Wood">Wood/Firewood</option>
                                                <option value="Cow Dung">Cow Dung</option>
                                                <option value="Kerosene">Kerosene</option>
                                                <option value="Electric">Electric/Induction</option>
                                                <option value="Biogas">Biogas</option>
                                            </select>
                                        </div>
                                        <div class="col-md-4">
                                            <label class="form-label small">Availability</label>
                                            <div class="d-flex gap-3 mt-1">
                                                <div class="form-check">
                                                    <input type="checkbox" id="electricityAvailable" class="form-check-input">
                                                    <label class="form-check-label small" for="electricityAvailable">Electricity</label>
                                                </div>
                                                <div class="form-check">
                                                    <input type="checkbox" id="internetAvailable" class="form-check-input">
                                                    <label class="form-check-label small" for="internetAvailable">Internet</label>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-3 d-flex gap-2">
                        <button class="btn btn-primary" id="saveBtn" onclick="saveHousehold()">
                            <i class="fas fa-save me-1"></i> Save Household
                        </button>
                        <button class="btn btn-outline-secondary" onclick="clearForm()">
                            <i class="fas fa-times me-1"></i> Clear
                        </button>
                    </div>
                </div>
                
                <!-- Households Table -->
                <div class="panel">
                    <h3><i class="fas fa-table me-2"></i>Household Directory</h3>
                    
                    <div class="d-flex gap-2 mb-3 flex-wrap">
                        <input type="text" id="search" class="form-control" style="max-width: 200px;" placeholder="Search..." oninput="renderTable()">
                        <select id="filterRisk" class="form-select" style="max-width: 130px;" onchange="renderTable()">
                            <option value="">All Risk</option>
                            <option value="high">High Risk</option>
                            <option value="medium">Medium</option>
                            <option value="low">Low</option>
                        </select>
                        <select id="filterVillage" class="form-select" style="max-width: 150px;" onchange="renderTable()">
                            <option value="">All Villages</option>
                        </select>
                        <button class="btn btn-outline-secondary btn-sm" onclick="loadHouseholds()" title="Refresh">
                            <i class="fas fa-sync-alt"></i>
                        </button>
                    </div>
                    
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Household</th>
                                    <th>Village</th>
                                    <th>Members</th>
                                    <th>Risk</th>
                                    <th>Flags</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="tableBody"></tbody>
                        </table>
                    </div>
                    
                    <div id="emptyState" class="text-center text-muted py-4" style="display: none;">
                        <i class="fas fa-home fa-3x mb-3 opacity-50"></i>
                        <p>No households recorded</p>
                    </div>
                </div>
            </div>
            
            <!-- Right Column -->
            <div>
                <div class="panel">
                    <h3><i class="fas fa-chart-pie me-2"></i>Village Distribution</h3>
                    <canvas id="villageChart" height="180"></canvas>
                </div>
                
                <div class="panel">
                    <h3><i class="fas fa-heartbeat me-2"></i>Health Summary</h3>
                    <div class="small">
                        <div class="d-flex justify-content-between py-2 border-bottom">
                            <span><i class="fas fa-baby text-danger me-2"></i>Pregnant Women</span>
                            <strong id="summaryPregnant">0</strong>
                        </div>
                        <div class="d-flex justify-content-between py-2 border-bottom">
                            <span><i class="fas fa-child text-primary me-2"></i>Children Under 5</span>
                            <strong id="summaryChild">0</strong>
                        </div>
                        <div class="d-flex justify-content-between py-2 border-bottom">
                            <span><i class="fas fa-user-clock text-warning me-2"></i>Elderly (60+)</span>
                            <strong id="summaryElderly">0</strong>
                        </div>
                        <div class="d-flex justify-content-between py-2">
                            <span><i class="fas fa-notes-medical text-info me-2"></i>NCD Patients</span>
                            <strong id="summaryNCD">0</strong>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>
    
    <!-- Member Modal -->
    <div class="modal fade" id="memberModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header" style="background: linear-gradient(135deg, var(--primary-red), var(--primary-dark)); color: white;">
                    <h5 class="modal-title"><i class="fas fa-users me-2"></i><span id="modalHouseholdName">Household Members</span></h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="membersList"></div>
                    
                    <hr>
                    
                    <!-- Tabs for Add Member / Link Client -->
                    <ul class="nav nav-tabs" role="tablist">
                        <li class="nav-item">
                            <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#addNewTab">
                                <i class="fas fa-user-plus me-1"></i> Add New Member
                            </button>
                        </li>
                        <li class="nav-item">
                            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#linkClientTab">
                                <i class="fas fa-link me-1"></i> Link Existing Client
                            </button>
                        </li>
                    </ul>
                    
                    <div class="tab-content pt-3">
                        <!-- Add New Member Tab -->
                        <div class="tab-pane fade show active" id="addNewTab">
                            <input type="hidden" id="currentHouseholdId">
                            
                            <div class="row">
                                <div class="col-md-4">
                                    <label class="form-label">Name *</label>
                                    <input type="text" id="memberName" class="form-control" placeholder="Full name">
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label">Age</label>
                                    <input type="number" id="memberAge" class="form-control" placeholder="Years" min="0" max="120">
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">Gender</label>
                                    <select id="memberGender" class="form-select">
                                        <option value="Male">Male</option>
                                        <option value="Female">Female</option>
                                        <option value="Other">Other</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">Relation</label>
                                    <select id="memberRelation" class="form-select">
                                        <option value="Head">Head</option>
                                        <option value="Spouse">Spouse</option>
                                        <option value="Child">Child</option>
                                        <option value="Parent">Parent</option>
                                        <option value="Other">Other</option>
                                    </select>
                                </div>
                            </div>
                            
                            <!-- Login Credentials Section -->
                            <div class="row mt-3">
                                <div class="col-12">
                                    <div class="alert alert-info py-2 mb-2">
                                        <i class="fas fa-user-shield me-1"></i>
                                        <strong>Login Credentials</strong> - Member will be registered as a client with these credentials
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">Email *</label>
                                    <input type="email" id="memberEmail" class="form-control" placeholder="email@example.com">
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">Password *</label>
                                    <input type="text" id="memberPassword" class="form-control" placeholder="Enter a password">
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">Phone Number</label>
                                    <input type="text" id="memberPhone" class="form-control" placeholder="Mobile (optional)">
                                </div>
                            </div>
                            
                            <div class="row mt-2">
                                <div class="col-md-12">
                                    <label class="form-label">Health Conditions</label>
                                    <div class="d-flex flex-wrap gap-3">
                                        <div class="form-check">
                                            <input type="checkbox" id="memberPregnant" class="form-check-input">
                                            <label class="form-check-label" for="memberPregnant">Pregnant</label>
                                        </div>
                                        <div class="form-check">
                                            <input type="checkbox" id="memberNCD" class="form-check-input">
                                            <label class="form-check-label" for="memberNCD">Has NCD</label>
                                        </div>
                                        <div class="form-check">
                                            <input type="checkbox" id="memberHighRisk" class="form-check-input">
                                            <label class="form-check-label" for="memberHighRisk">High Risk</label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="mt-3">
                                <button class="btn btn-primary" onclick="addMember()">
                                    <i class="fas fa-user-plus me-1"></i> Add Member & Create Account
                                </button>
                            </div>
                        </div>
                        
                        <!-- Link Existing Client Tab -->
                        <div class="tab-pane fade" id="linkClientTab">
                            <div class="mb-3">
                                <label class="form-label">Search for Registered Client</label>
                                <input type="text" id="clientSearchInput" class="form-control" placeholder="Type name, email, or UID..." oninput="searchClients()">
                                <div id="clientSearchResults" class="client-search-results" style="display: none;"></div>
                            </div>
                            <div id="selectedClientInfo" style="display: none;" class="alert alert-success">
                                <strong>Selected:</strong> <span id="selectedClientName"></span>
                                <input type="hidden" id="selectedClientId">
                                <button class="btn btn-sm btn-success float-end" onclick="linkSelectedClient()">
                                    <i class="fas fa-link me-1"></i> Link to Household
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Register Client Modal - REMOVED (merged into Add Member form) -->
    
    <!-- Client Created Success Modal -->
    <div class="modal fade" id="clientCreatedModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title"><i class="fas fa-check-circle me-2"></i>Client Account Created</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>A new client account has been created:</p>
                    <div class="bg-light p-3 rounded">
                        <p class="mb-1"><strong>Name:</strong> <span id="newClientName"></span></p>
                        <p class="mb-1"><strong>Email:</strong> <span id="newClientEmail"></span></p>
                        <p class="mb-1"><strong>UID:</strong> <span id="newClientUID"></span></p>
                        <p class="mb-0"><strong>Password:</strong> <span id="newClientPassword" class="text-danger"></span></p>
                    </div>
                    <div class="alert alert-warning mt-3 mb-0">
                        <i class="fas fa-exclamation-triangle me-1"></i>
                        Please share these credentials with the client so they can log in.
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <script>
        // State
        let households = [];
        let chart = null;
        let memberModal, clientCreatedModal;
        let searchTimeout = null;
        
        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            memberModal = new bootstrap.Modal(document.getElementById('memberModal'));
            clientCreatedModal = new bootstrap.Modal(document.getElementById('clientCreatedModal'));
            loadHouseholds();
        });
        
        function scrollToForm() {
            clearForm();
            document.getElementById('formSection').scrollIntoView({ behavior: 'smooth' });
            document.getElementById('headName').focus();
        }
        
        function clearForm() {
            document.getElementById('editingId').value = '';
            document.getElementById('headName').value = '';
            document.getElementById('village').value = '';
            document.getElementById('address').value = '';
            document.getElementById('phone').value = '';
            document.getElementById('riskLevel').value = 'low';
            document.getElementById('hasPregnant').checked = false;
            document.getElementById('hasChild').checked = false;
            document.getElementById('hasElderly').checked = false;
            document.getElementById('hasNCD').checked = false;
            // Clear Phase 2 fields
            document.getElementById('casteTribe').value = '';
            document.getElementById('religion').value = '';
            document.getElementById('occupation').value = '';
            document.getElementById('employerType').value = '';
            document.getElementById('incomeCategory').value = '';
            document.getElementById('povertyIndex').value = '';
            document.getElementById('educationLevel').value = '';
            document.getElementById('rationCardNumber').value = '';
            document.getElementById('rationCardType').value = '';
            document.getElementById('welfareSchemes').value = '';
            document.getElementById('disabilityCertificate').value = '';
            document.getElementById('housingType').value = '';
            document.getElementById('ownershipStatus').value = '';
            document.getElementById('waterSource').value = '';
            document.getElementById('sanitationFacility').value = '';
            document.getElementById('cookingFuel').value = '';
            document.getElementById('electricityAvailable').checked = false;
            document.getElementById('internetAvailable').checked = false;
            document.getElementById('formTitle').innerHTML = '<i class="fas fa-edit me-2"></i>Add Household';
            document.getElementById('saveBtn').innerHTML = '<i class="fas fa-save me-1"></i> Save Household';
        }
        
        // Load households
        async function loadHouseholds() {
            try {
                const response = await fetch('/api/health-worker/households');
                const result = await response.json();
                if (result.households) {
                    households = result.households;
                    renderAll();
                    updateVillageFilter();
                }
            } catch (err) {
                console.error('Load error:', err);
                alert('Failed to load households');
            }
        }
        
        // Save household
        async function saveHousehold() {
            const headName = document.getElementById('headName').value.trim();
            const village = document.getElementById('village').value.trim();
            if (!headName || !village) { alert('Please enter head name and village.'); return; }
            
            const editingId = document.getElementById('editingId').value;
            const payload = {
                id: editingId || null,
                head_name: headName,
                village: village,
                address: document.getElementById('address').value.trim(),
                phone: document.getElementById('phone').value.trim(),
                risk_level: document.getElementById('riskLevel').value,
                has_pregnant_woman: document.getElementById('hasPregnant').checked,
                has_child_under_5: document.getElementById('hasChild').checked,
                has_elderly: document.getElementById('hasElderly').checked,
                has_ncd_patient: document.getElementById('hasNCD').checked,
                // Phase 2: Socio-Economic Fields
                caste_tribe_ethnicity: document.getElementById('casteTribe').value,
                religion: document.getElementById('religion').value,
                occupation: document.getElementById('occupation').value.trim(),
                employer_type: document.getElementById('employerType').value,
                income_category: document.getElementById('incomeCategory').value,
                poverty_index: document.getElementById('povertyIndex').value.trim(),
                education_level: document.getElementById('educationLevel').value,
                ration_card_number: document.getElementById('rationCardNumber').value.trim(),
                ration_card_type: document.getElementById('rationCardType').value,
                welfare_schemes: document.getElementById('welfareSchemes').value.trim(),
                disability_certificate: document.getElementById('disabilityCertificate').value.trim(),
                housing_type: document.getElementById('housingType').value,
                ownership_status: document.getElementById('ownershipStatus').value,
                water_source: document.getElementById('waterSource').value,
                sanitation_facility: document.getElementById('sanitationFacility').value,
                cooking_fuel: document.getElementById('cookingFuel').value,
                electricity_available: document.getElementById('electricityAvailable').checked,
                internet_available: document.getElementById('internetAvailable').checked
            };
            
            try {
                const response = await fetch('/api/health-worker/household/save', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const result = await response.json();
                if (result.success) {
                    alert(editingId ? 'Household updated!' : 'Household saved!');
                    clearForm();
                    loadHouseholds();
                } else {
                    alert('Error: ' + (result.error || 'Failed to save'));
                }
            } catch (err) {
                console.error('Save error:', err);
                alert('Failed to save household.');
            }
        }
        
        // Edit household
        function editHousehold(id) {
            const h = households.find(function(h) { return h.id === id; });
            if (!h) { alert('Household not found'); return; }
            
            document.getElementById('editingId').value = h.id;
            document.getElementById('headName').value = h.head_name || '';
            document.getElementById('village').value = h.village || '';
            document.getElementById('address').value = h.address || '';
            document.getElementById('phone').value = h.phone || '';
            document.getElementById('riskLevel').value = h.risk_level || 'low';
            document.getElementById('hasPregnant').checked = h.has_pregnant_woman || false;
            document.getElementById('hasChild').checked = h.has_child_under_5 || false;
            document.getElementById('hasElderly').checked = h.has_elderly || false;
            document.getElementById('hasNCD').checked = h.has_ncd_patient || false;
            
            document.getElementById('formTitle').innerHTML = '<i class="fas fa-edit me-2"></i>Edit Household';
            document.getElementById('saveBtn').innerHTML = '<i class="fas fa-save me-1"></i> Update Household';
            document.getElementById('formSection').scrollIntoView({ behavior: 'smooth' });
        }
        
        // View household
        async function viewHousehold(id) {
            try {
                const response = await fetch('/api/health-worker/household/' + id);
                const result = await response.json();
                if (result.success && result.household) {
                    const h = result.household;
                    document.getElementById('modalHouseholdName').textContent = h.head_name + ' - ' + h.village;
                    document.getElementById('currentHouseholdId').value = id;
                    renderMembersList(h.members || []);
                    clearMemberForm();
                    clearClientSearch();
                    memberModal.show();
                } else {
                    alert('Failed to load household');
                }
            } catch (err) {
                console.error('Error:', err);
                alert('Failed to load household.');
            }
        }
        
        function renderMembersList(members) {
            const membersList = document.getElementById('membersList');
            if (members.length === 0) {
                membersList.innerHTML = '<p class="text-muted text-center py-3">No members added yet</p>';
                return;
            }
            
            let html = '';
            for (let i = 0; i < members.length; i++) {
                const m = members[i];
                const isLinked = m.user_id && m.linked_client;
                
                html += '<div class="member-card ' + (isLinked ? 'linked' : '') + '">';
                html += '<div class="d-flex justify-content-between align-items-start">';
                html += '<div style="flex: 1;">';
                html += '<strong>' + escapeHtml(m.name) + '</strong>';
                if (m.uid) html += ' <span class="badge bg-secondary">' + m.uid + '</span>';
                if (isLinked) html += ' <span class="health-flag flag-linked"><i class="fas fa-link"></i> Linked</span>';
                
                html += '<div class="text-muted small">';
                if (m.age) html += m.age + ' yrs ';
                if (m.gender) html += ' ' + m.gender + ' ';
                if (m.relation) html += ' ' + m.relation;
                html += '</div>';
                
                if (isLinked) {
                    html += '<div class="small text-success mt-1"><i class="fas fa-user-check me-1"></i>Client: ' + escapeHtml(m.linked_client.email) + '</div>';
                }
                
                html += '<div class="mt-1">';
                if (m.is_pregnant) html += '<span class="health-flag flag-pregnant"><i class="fas fa-baby"></i> Pregnant</span>';
                if (m.has_ncd) html += '<span class="health-flag flag-ncd"><i class="fas fa-heartbeat"></i> NCD</span>';
                if (m.is_high_risk) html += '<span class="health-flag flag-risk"><i class="fas fa-exclamation-triangle"></i> High Risk</span>';
                html += '</div></div>';
                
                // Actions - All members are now auto-registered, so no Register button needed
                html += '<div class="btn-group-vertical btn-group-sm">';
                if (isLinked) {
                    html += '<button class="btn btn-outline-warning btn-sm" onclick="unlinkClient(' + m.id + ')" title="Unlink"><i class="fas fa-unlink"></i></button>';
                }
                html += '<button class="btn btn-outline-danger btn-sm" onclick="deleteMember(' + m.id + ')" title="Delete"><i class="fas fa-trash"></i></button>';
                html += '</div></div></div>';
            }
            membersList.innerHTML = html;
        }
        
        function clearMemberForm() {
            document.getElementById('memberName').value = '';
            document.getElementById('memberAge').value = '';
            document.getElementById('memberGender').value = 'Male';
            document.getElementById('memberRelation').value = 'Head';
            document.getElementById('memberEmail').value = '';
            document.getElementById('memberPassword').value = '';
            document.getElementById('memberPhone').value = '';
            document.getElementById('memberPregnant').checked = false;
            document.getElementById('memberNCD').checked = false;
            document.getElementById('memberHighRisk').checked = false;
        }
        
        function clearClientSearch() {
            document.getElementById('clientSearchInput').value = '';
            document.getElementById('clientSearchResults').style.display = 'none';
            document.getElementById('selectedClientInfo').style.display = 'none';
            document.getElementById('selectedClientId').value = '';
        }
        
        // Show register form
        function showRegisterForm(memberId, memberName) {
            document.getElementById('registerMemberId').value = memberId;
            document.getElementById('registerMemberName').value = memberName;
            document.getElementById('registerEmail').value = '';
            document.getElementById('registerPassword').value = '';
            document.getElementById('registerPhone').value = '';
            registerClientModal.show();
        }
        
        // Submit register client
        async function submitRegisterClient() {
            const memberId = document.getElementById('registerMemberId').value;
            const email = document.getElementById('registerEmail').value.trim();
            const password = document.getElementById('registerPassword').value.trim();
            const phone = document.getElementById('registerPhone').value.trim();
            
            if (!email || !password) {
                alert('Please enter both email and password.');
                return;
            }
            
            try {
                const response = await fetch('/api/health-worker/household-member/' + memberId + '/register-as-client', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email: email, password: password, phone: phone })
                });
                
                const result = await response.json();
                
                if (result.success && result.client) {
                    registerClientModal.hide();
                    
                    // Show success modal
                    document.getElementById('newClientName').textContent = result.client.name;
                    document.getElementById('newClientEmail').textContent = result.client.email;
                    document.getElementById('newClientUID').textContent = result.client.uid;
                    document.getElementById('newClientPassword').textContent = result.client.password;
                    clientCreatedModal.show();
                    
                    // Refresh
                    const householdId = document.getElementById('currentHouseholdId').value;
                    viewHousehold(householdId);
                    loadHouseholds();
                } else {
                    alert('Error: ' + (result.error || 'Failed to register'));
                }
            } catch (err) {
                console.error('Register error:', err);
                alert('Failed to register client.');
            }
        }
        
        // Search clients
        function searchClients() {
            clearTimeout(searchTimeout);
            const query = document.getElementById('clientSearchInput').value.trim();
            const resultsDiv = document.getElementById('clientSearchResults');
            
            if (query.length < 2) { resultsDiv.style.display = 'none'; return; }
            
            searchTimeout = setTimeout(async function() {
                try {
                    const response = await fetch('/api/health-worker/search-patients?q=' + encodeURIComponent(query));
                    const result = await response.json();
                    
                    if (result.success && result.patients && result.patients.length > 0) {
                        let html = '';
                        for (let i = 0; i < result.patients.length; i++) {
                            const p = result.patients[i];
                            html += '<div class="client-search-item" onclick="selectClient(' + p.id + ', \'' + escapeHtml(p.name).replace(/'/g, "\\'") + '\', \'' + escapeHtml(p.email || '').replace(/'/g, "\\'") + '\')">';
                            html += '<strong>' + escapeHtml(p.name) + '</strong>';
                            if (p.uid) html += ' <span class="badge bg-secondary">' + p.uid + '</span>';
                            html += '<div class="small text-muted">' + (p.email || '') + '</div></div>';
                        }
                        resultsDiv.innerHTML = html;
                        resultsDiv.style.display = 'block';
                    } else {
                        resultsDiv.innerHTML = '<div class="client-search-item text-muted">No clients found</div>';
                        resultsDiv.style.display = 'block';
                    }
                } catch (err) {
                    console.error('Search error:', err);
                }
            }, 300);
        }
        
        function selectClient(id, name, email) {
            document.getElementById('selectedClientId').value = id;
            document.getElementById('selectedClientName').textContent = name + ' (' + email + ')';
            document.getElementById('selectedClientInfo').style.display = 'block';
            document.getElementById('clientSearchResults').style.display = 'none';
        }
        
        // Link existing client to household
        async function linkSelectedClient() {
            const userId = document.getElementById('selectedClientId').value;
            const householdId = document.getElementById('currentHouseholdId').value;
            if (!userId) { alert('Please select a client'); return; }
            
            const clientText = document.getElementById('selectedClientName').textContent;
            const name = clientText.split(' (')[0];
            
            try {
                // Use the link-existing-client API endpoint (designed for existing clients)
                const response = await fetch('/api/health-worker/household/' + householdId + '/link-existing-client', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ user_id: parseInt(userId) })
                });
                const result = await response.json();
                
                if (result.success) {
                    alert('Client linked successfully!');
                    clearClientSearch();
                    viewHousehold(householdId);
                    loadHouseholds();
                } else {
                    alert('Error: ' + (result.error || 'Failed to link client'));
                }
            } catch (err) {
                console.error('Link error:', err);
                alert('Failed to link client.');
            }
        }
        
        // Unlink
        async function unlinkClient(memberId) {
            if (!confirm('Unlink this client?')) return;
            try {
                const response = await fetch('/api/health-worker/household-member/' + memberId + '/unlink-client', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: '{}'
                });
                const result = await response.json();
                if (result.success) {
                    const householdId = document.getElementById('currentHouseholdId').value;
                    viewHousehold(householdId);
                    loadHouseholds();
                } else {
                    alert('Error: ' + (result.error || 'Failed'));
                }
            } catch (err) {
                console.error('Unlink error:', err);
            }
        }
        
        // Add member AND create client account
        async function addMember() {
            const householdId = document.getElementById('currentHouseholdId').value;
            const name = document.getElementById('memberName').value.trim();
            const email = document.getElementById('memberEmail').value.trim();
            const password = document.getElementById('memberPassword').value.trim();
            
            if (!name) { alert('Please enter member name.'); return; }
            if (!email) { alert('Please enter email address.'); return; }
            if (!password) { alert('Please enter password.'); return; }
            
            const ageVal = document.getElementById('memberAge').value;
            const payload = {
                name: name,
                email: email,
                password: password,
                phone: document.getElementById('memberPhone').value.trim(),
                age: ageVal ? parseInt(ageVal) : null,
                gender: document.getElementById('memberGender').value,
                relation: document.getElementById('memberRelation').value,
                is_pregnant: document.getElementById('memberPregnant').checked,
                has_ncd: document.getElementById('memberNCD').checked,
                is_high_risk: document.getElementById('memberHighRisk').checked
            };
            
            try {
                const response = await fetch('/api/health-worker/household/' + householdId + '/member', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const result = await response.json();
                if (result.success && result.client) {
                    // Show success modal with client credentials
                    document.getElementById('newClientName').textContent = result.client.name;
                    document.getElementById('newClientEmail').textContent = result.client.email;
                    document.getElementById('newClientUID').textContent = result.client.uid;
                    document.getElementById('newClientPassword').textContent = result.client.password;
                    clientCreatedModal.show();
                    
                    clearMemberForm();
                    viewHousehold(householdId);
                    loadHouseholds();
                } else {
                    alert('Error: ' + (result.error || 'Failed'));
                }
            } catch (err) {
                console.error('Add error:', err);
                alert('Failed to add member.');
            }
        }
        
        // Delete member
        async function deleteMember(id) {
            if (!confirm('Delete this member?')) return;
            try {
                const response = await fetch('/api/health-worker/household-member/' + id, { method: 'DELETE' });
                const result = await response.json();
                if (result.success) {
                    const householdId = document.getElementById('currentHouseholdId').value;
                    viewHousehold(householdId);
                    loadHouseholds();
                } else {
                    alert('Error: ' + (result.error || 'Failed'));
                }
            } catch (err) {
                console.error('Delete error:', err);
            }
        }
        
        // Delete household
        async function deleteHousehold(id) {
            if (!confirm('Delete this household?')) return;
            try {
                const response = await fetch('/api/health-worker/household/' + id + '/delete', { method: 'DELETE' });
                const result = await response.json();
                if (result.success) loadHouseholds();
                else alert('Error: ' + (result.error || 'Failed'));
            } catch (err) {
                console.error('Delete error:', err);
            }
        }
        
        // Render table
        function renderTable() {
            const tbody = document.getElementById('tableBody');
            const empty = document.getElementById('emptyState');
            const q = document.getElementById('search').value.toLowerCase();
            const riskFilter = document.getElementById('filterRisk').value;
            const villageFilter = document.getElementById('filterVillage').value;
            
            const filtered = households.filter(function(h) {
                if (riskFilter && h.risk_level !== riskFilter) return false;
                if (villageFilter && h.village !== villageFilter) return false;
                if (!q) return true;
                return (h.head_name && h.head_name.toLowerCase().indexOf(q) >= 0) ||
                       (h.village && h.village.toLowerCase().indexOf(q) >= 0);
            });
            
            if (filtered.length === 0) {
                tbody.innerHTML = '';
                empty.style.display = 'block';
                return;
            }
            
            empty.style.display = 'none';
            let html = '';
            for (let i = 0; i < filtered.length; i++) {
                const h = filtered[i];
                const count = h.members ? h.members.length : (h.total_members || 0);
                const riskClass = h.risk_level === 'high' ? 'danger' : (h.risk_level === 'medium' ? 'warning' : 'success');
                
                html += '<tr class="risk-' + (h.risk_level || 'low') + '">';
                html += '<td><strong>' + escapeHtml(h.head_name) + '</strong><small class="d-block text-muted">' + (h.household_id || '') + '</small></td>';
                html += '<td>' + escapeHtml(h.village) + '</td>';
                html += '<td><span class="badge bg-secondary">' + count + '</span></td>';
                html += '<td><span class="badge bg-' + riskClass + '">' + (h.risk_level || 'low') + '</span></td>';
                html += '<td class="small">';
                if (h.has_pregnant_woman) html += '<span class="health-flag flag-pregnant"><i class="fas fa-baby"></i></span>';
                if (h.has_child_under_5) html += '<span class="health-flag flag-child"><i class="fas fa-child"></i></span>';
                if (h.has_elderly) html += '<span class="health-flag flag-elderly"><i class="fas fa-user-clock"></i></span>';
                if (h.has_ncd_patient) html += '<span class="health-flag flag-ncd"><i class="fas fa-heartbeat"></i></span>';
                html += '</td><td>';
                html += '<button class="btn btn-outline-primary btn-sm action-btn" onclick="viewHousehold(' + h.id + ')"><i class="fas fa-users"></i></button>';
                html += '<button class="btn btn-outline-warning btn-sm action-btn" onclick="editHousehold(' + h.id + ')"><i class="fas fa-edit"></i></button>';
                html += '<button class="btn btn-outline-danger btn-sm action-btn" onclick="deleteHousehold(' + h.id + ')"><i class="fas fa-trash"></i></button>';
                html += '</td></tr>';
            }
            tbody.innerHTML = html;
        }
        
        function escapeHtml(s) {
            if (!s) return '';
            return String(s).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
        }
        
        function updateVillageFilter() {
            const villages = [];
            for (let i = 0; i < households.length; i++) {
                if (households[i].village && villages.indexOf(households[i].village) < 0) villages.push(households[i].village);
            }
            villages.sort();
            let html = '<option value="">All Villages</option>';
            for (let i = 0; i < villages.length; i++) {
                html += '<option value="' + escapeHtml(villages[i]) + '">' + escapeHtml(villages[i]) + '</option>';
            }
            document.getElementById('filterVillage').innerHTML = html;
        }
        
        function renderStats() {
            let totalMembers = 0, highRisk = 0, pregnant = 0, child = 0, elderly = 0, ncd = 0;
            const villagesSet = {};
            for (let i = 0; i < households.length; i++) {
                const h = households[i];
                totalMembers += h.members ? h.members.length : (h.total_members || 0);
                if (h.village) villagesSet[h.village] = true;
                if (h.risk_level === 'high') highRisk++;
                if (h.has_pregnant_woman) pregnant++;
                if (h.has_child_under_5) child++;
                if (h.has_elderly) elderly++;
                if (h.has_ncd_patient) ncd++;
            }
            document.getElementById('totalHouseholds').textContent = households.length;
            document.getElementById('totalMembers').textContent = totalMembers;
            document.getElementById('totalVillages').textContent = Object.keys(villagesSet).length;
            document.getElementById('highRiskCount').textContent = highRisk;
            document.getElementById('pregnantCount').textContent = pregnant;
            document.getElementById('summaryPregnant').textContent = pregnant;
            document.getElementById('summaryChild').textContent = child;
            document.getElementById('summaryElderly').textContent = elderly;
            document.getElementById('summaryNCD').textContent = ncd;
        }
        
        function renderChart() {
            const ctx = document.getElementById('villageChart');
            const villages = {};
            for (let i = 0; i < households.length; i++) {
                if (households[i].village) villages[households[i].village] = (villages[households[i].village] || 0) + 1;
            }
            if (chart) chart.destroy();
            chart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(villages),
                    datasets: [{ data: Object.values(villages), backgroundColor: ['#E63946', '#198754', '#0d6efd', '#ffc107', '#6c757d'], borderWidth: 0 }]
                },
                options: { responsive: true, plugins: { legend: { position: 'bottom' } } }
            });
        }
        
        function renderAll() { renderTable(); renderStats(); renderChart(); }
    </script>
</body>
</html>