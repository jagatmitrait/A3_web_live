<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Block Admin Dashboard | A3 Health Card</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='dashboard_theme.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='theme.css') }}">
    <!-- Leaflet.js for GIS Map -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        :root {
            --sidebar-width: 280px;
            --header-height: 70px;
            --primary-red: #c62828;
            --primary-red-dark: #8e0000;
            --primary-red-light: #ffcdd2;
            --primary-red-lighter: #ffebee;
            --white: #ffffff;
            --light-gray: #f5f7fa;
            --border-color: #e8eaed;
            --dark-text: #1a1a2e;
            --muted-text: #5f6368;
            --success: #00897b;
            --success-light: #e0f2f1;
            --warning: #f4511e;
            --warning-light: #fbe9e7;
            --info: #1976d2;
            --info-light: #e3f2fd;
            --shadow-sm: 0 1px 3px rgba(0,0,0,0.08);
            --shadow-md: 0 4px 12px rgba(0,0,0,0.1);
            --shadow-lg: 0 8px 24px rgba(0,0,0,0.12);
            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 16px;
        }
        
        * {
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        
        body {
            background-color: var(--light-gray);
            font-family: 'Inter', 'Segoe UI', system-ui, -apple-system, sans-serif;
            overflow-x: hidden;
            color: var(--dark-text);
            font-size: 14px;
            line-height: 1.6;
        }

        /* Modern Sidebar */
        .sidebar {
            width: var(--sidebar-width);
            height: 100vh;
            position: fixed;
            top: 0;
            left: 0;
            background: var(--white);
            border-right: 1px solid var(--border-color);
            z-index: 1000;
            display: flex;
            flex-direction: column;
            box-shadow: var(--shadow-sm);
        }

        .sidebar-header {
            height: var(--header-height);
            display: flex;
            align-items: center;
            padding: 0 1.5rem;
            border-bottom: 1px solid var(--border-color);
            background: linear-gradient(135deg, var(--primary-red) 0%, var(--primary-red-dark) 100%);
        }

        .brand-logo {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--white);
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 12px;
            letter-spacing: -0.5px;
        }

        .brand-logo i {
            color: var(--white);
            font-size: 1.4rem;
        }

        .nav-link {
            padding: 0.875rem 1.5rem;
            color: var(--muted-text);
            font-weight: 500;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 12px;
            transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            border-left: 3px solid transparent;
            text-decoration: none;
        }

        .nav-link:hover {
            color: var(--primary-red);
            background: var(--primary-red-lighter);
            border-left-color: var(--primary-red);
            transform: translateY(-2px);
            box-shadow: 0 2px 8px rgba(198, 40, 40, 0.1);
        }

        .nav-link.active {
            color: var(--primary-red);
            background: var(--primary-red-lighter);
            border-left-color: var(--primary-red);
            font-weight: 600;
        }

        .nav-link i {
            width: 20px;
            text-align: center;
            font-size: 1rem;
            opacity: 0.7;
            transition: all 0.3s ease;
        }

        .nav-link:hover i,
        .nav-link.active i {
            color: var(--primary-red);
            opacity: 1;
        }

        /* Sidebar Collapse Toggle */
        .sidebar-toggle {
            position: absolute;
            top: 50%;
            right: -12px;
            transform: translateY(-50%);
            width: 24px;
            height: 24px;
            background: var(--white);
            border: 1px solid var(--border-color);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: var(--shadow-sm);
            z-index: 1001;
            transition: all 0.3s ease;
        }

        .sidebar-toggle:hover {
            background: var(--primary-red);
            color: white;
            border-color: var(--primary-red);
        }

        .sidebar-toggle i {
            font-size: 10px;
            transition: transform 0.3s ease;
        }

        /* Collapsed Sidebar */
        .sidebar.collapsed {
            width: 70px;
        }

        .sidebar.collapsed .brand-logo span,
        .sidebar.collapsed .nav-link span,
        .sidebar.collapsed .user-info .fw-bold,
        .sidebar.collapsed .user-info .small {
            display: none;
        }

        .sidebar.collapsed .nav-link {
            justify-content: center;
            padding: 0.875rem 0;
            margin: 2px 4px;
        }

        .sidebar.collapsed .nav-link i {
            font-size: 1.2rem;
        }

        .sidebar.collapsed .sidebar-header {
            padding: 0 0.5rem;
            justify-content: center;
        }

        .sidebar.collapsed .sidebar-toggle i {
            transform: rotate(180deg);
        }

        .sidebar.collapsed .user-info {
            padding: 1rem 0.5rem;
        }

        .sidebar.collapsed .user-info .d-flex {
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
        }

        .sidebar.collapsed + .main-content {
            margin-left: 70px;
        }

        /* Smooth transition for main content */
        .main-content {
            transition: margin-left 0.3s ease;
        }

        /* User info in sidebar */
        .user-info {
            padding: 1rem 1.25rem;
            border-top: 1px solid var(--border-color);
            margin-top: auto;
            background: linear-gradient(135deg, #37474f 0%, #263238 100%);
        }

        .user-avatar {
            width: 42px;
            height: 42px;
            border-radius: 50%;
            background: var(--primary-red);
            color: var(--white);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 0.9rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }

        /* Main Content */
        .main-content {
            margin-left: var(--sidebar-width);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .top-header {
            height: var(--header-height);
            background: var(--white);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 2rem;
            position: sticky;
            top: 0;
            z-index: 900;
            box-shadow: var(--shadow-sm);
        }

        .top-header h4 {
            color: var(--dark-text);
            font-weight: 700;
            font-size: 1.25rem;
            letter-spacing: -0.5px;
        }

        .content-body {
            padding: 1.5rem 2rem;
            flex: 1;
        }

        /* KPI Cards */
        .kpi-card {
            background: linear-gradient(135deg, var(--primary-red) 0%, var(--primary-red-dark) 100%);
            color: var(--white);
            border-radius: var(--radius-lg);
            padding: 1.5rem;
            box-shadow: var(--shadow-md);
            height: 100%;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .kpi-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
        }

        .kpi-card.success { background: linear-gradient(135deg, #00897b 0%, #00695c 100%); }
        .kpi-card.warning { background: linear-gradient(135deg, #fb8c00 0%, #ef6c00 100%); }
        .kpi-card.info { background: linear-gradient(135deg, #1976d2 0%, #1565c0 100%); }
        .kpi-card.purple { background: linear-gradient(135deg, #7b1fa2 0%, #6a1b9a 100%); }
        .kpi-card.cyan { background: linear-gradient(135deg, #0097a7 0%, #00838f 100%); }

        .kpi-value {
            font-size: 2.5rem;
            font-weight: 700;
            letter-spacing: -1px;
        }

        .kpi-label {
            font-size: 0.85rem;
            opacity: 0.9;
            font-weight: 500;
        }

        .kpi-detail {
            font-size: 0.75rem;
            opacity: 0.8;
            margin-top: 0.5rem;
        }

        .kpi-badge {
            background: rgba(255,255,255,0.2);
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: 600;
        }

        /* Enhanced Cards */
        .card {
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-sm);
            transition: box-shadow 0.3s;
        }

        .card:hover {
            box-shadow: var(--shadow-md);
        }

        .card-header {
            background: var(--white) !important;
            border-bottom: 1px solid var(--border-color);
            padding: 1rem 1.25rem;
        }

        .card-header h6 {
            font-weight: 700;
            font-size: 0.95rem;
            color: var(--dark-text);
            letter-spacing: -0.3px;
        }

        .card-header h6 i {
            color: var(--primary-red);
            margin-right: 8px;
        }

        /* Modern Buttons */
        .btn {
            font-weight: 600;
            font-size: 0.8rem;
            border-radius: var(--radius-sm);
            padding: 0.5rem 1rem;
            transition: all 0.2s ease;
            letter-spacing: 0.2px;
        }

        .btn-danger {
            background: var(--primary-red);
            border-color: var(--primary-red);
            box-shadow: 0 2px 4px rgba(198, 40, 40, 0.25);
        }

        .btn-danger:hover {
            background: var(--primary-red-dark);
            border-color: var(--primary-red-dark);
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(198, 40, 40, 0.3);
        }

        .btn-outline-danger {
            color: #b71c1c;
            border-color: #b71c1c;
            background: transparent;
            border-width: 2px;
            font-weight: 700;
        }

        .btn-outline-danger:hover {
            background: #b71c1c;
            border-color: #b71c1c;
            color: #fff;
        }

        /* Progress bars */
        .progress {
            border-radius: 10px;
            background: rgba(255,255,255,0.2);
            height: 6px;
        }

        .progress-bar {
            border-radius: 10px;
            background: rgba(255,255,255,0.8);
        }

        /* Quick Stats */
        .quick-stat {
            text-align: center;
            padding: 0.5rem;
            background: rgba(255,255,255,0.1);
            border-radius: var(--radius-sm);
        }

        .quick-stat-value {
            font-size: 1.1rem;
            font-weight: 700;
        }

        .quick-stat-label {
            font-size: 0.65rem;
            opacity: 0.8;
        }

        /* Responsive */
        @media (max-width: 992px) {
            .sidebar {
                transform: translateX(-100%);
            }
            .main-content {
                margin-left: 0;
            }
        }

        /* Loading animation */
        .kpi-loading {
            animation: pulse 1.5s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Refresh indicator */
        .refresh-btn {
            background: rgba(255,255,255,0.1);
            border: none;
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .refresh-btn:hover {
            background: rgba(255,255,255,0.2);
        }

        .refresh-btn.spinning i {
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        /* Content Pages */
        .content-page {
            display: none;
            animation: fadeIn 0.3s ease;
        }
        .content-page.active {
            display: block;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(8px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Map Container */
        #geoHealthMap {
            height: 500px;
            width: 100%;
            border-radius: var(--radius-lg);
        }

        /* Map Legend */
        .map-legend {
            background: var(--white);
            border-radius: var(--radius-sm);
            padding: 0.75rem;
            box-shadow: var(--shadow-md);
        }
        .map-legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.75rem;
            margin-bottom: 0.25rem;
        }
        .legend-marker {
            width: 14px;
            height: 14px;
            border-radius: 50%;
            border: 2px solid white;
            box-shadow: 0 1px 3px rgba(0,0,0,0.3);
        }
        .legend-marker.high { background: #dc3545; }
        .legend-marker.moderate { background: #fd7e14; }
        .legend-marker.stable { background: #28a745; }

        /* Indicator Layer Toggles */
        .layer-toggle {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 0.5rem 0.75rem;
            background: var(--light-gray);
            border-radius: var(--radius-sm);
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.8rem;
        }
        .layer-toggle:hover {
            background: var(--primary-red-lighter);
        }
        .layer-toggle.active {
            background: var(--primary-red);
            color: white;
        }
        .layer-toggle i {
            font-size: 0.9rem;
        }

        /* Village Popup */
        .village-popup {
            min-width: 280px;
        }
        .village-popup h6 {
            color: var(--primary-red);
            font-weight: 700;
            margin-bottom: 0.5rem;
        }
        .village-popup .stat-row {
            display: flex;
            justify-content: space-between;
            padding: 0.35rem 0;
            border-bottom: 1px solid var(--border-color);
            font-size: 0.8rem;
        }
        .village-popup .stat-row:last-child {
            border-bottom: none;
        }
        .village-popup .stat-label {
            color: var(--muted-text);
        }
        .village-popup .stat-value {
            font-weight: 600;
        }

        /* AI Engine Cards */
        .ai-engine-card {
            background: white;
            border-radius: 12px;
            padding: 1rem;
            box-shadow: var(--shadow-sm);
            transition: transform 0.2s;
        }
        .ai-engine-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }
        .ai-engine-status {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            font-size: 0.7rem;
            padding: 2px 8px;
            border-radius: 12px;
        }
        .ai-engine-status.active { background: #d4edda; color: #155724; }
        .ai-engine-status.processing { background: #fff3cd; color: #856404; }
        .ai-engine-status.idle { background: #e9ecef; color: #6c757d; }

        /* Alert Cards */
        .alert-card {
            background: white;
            border-radius: 12px;
            box-shadow: var(--shadow-sm);
            overflow: hidden;
            transition: transform 0.2s;
        }
        .alert-card:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow-md);
        }
        .alert-severity-bar {
            height: 4px;
            width: 100%;
        }
        .alert-severity-bar.critical { background: linear-gradient(90deg, #dc3545, #ff6b6b); }
        .alert-severity-bar.high { background: linear-gradient(90deg, #fd7e14, #ffb366); }
        .alert-severity-bar.medium { background: linear-gradient(90deg, #17a2b8, #5bc0de); }
        .alert-severity-bar.low { background: linear-gradient(90deg, #28a745, #6dd47e); }
        
        .alert-badge {
            font-size: 0.65rem;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: 600;
        }
        .alert-badge.critical { background: #dc3545; color: white; }
        .alert-badge.high { background: #fd7e14; color: white; }
        .alert-badge.medium { background: #17a2b8; color: white; }
        .alert-badge.low { background: #28a745; color: white; }
        .alert-badge.new { background: #dc3545; color: white; }
        .alert-badge.acknowledged { background: #6c757d; color: white; }
        .alert-badge.in_progress { background: #17a2b8; color: white; }

        .affected-list {
            max-height: 100px;
            overflow-y: auto;
            font-size: 0.8rem;
        }
        .task-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        .task-list li {
            padding: 4px 0;
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .task-list li::before {
            content: '☐';
            color: var(--primary-red);
        }

        /* Task Cards */
        .task-card {
            background: white;
            border-radius: 12px;
            box-shadow: var(--shadow-sm);
            overflow: hidden;
            transition: all 0.2s;
            border-left: 4px solid #6c757d;
        }
        .task-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }
        .task-card.priority-critical { border-left-color: #dc3545; }
        .task-card.priority-high { border-left-color: #fd7e14; }
        .task-card.priority-medium { border-left-color: #17a2b8; }
        .task-card.priority-routine { border-left-color: #6c757d; }
        
        .task-card.status-overdue { background: #fff5f5; }
        .task-card.status-completed { opacity: 0.7; }
        
        .priority-badge {
            font-size: 0.65rem;
            padding: 2px 8px;
            border-radius: 4px;
            font-weight: 600;
            text-transform: uppercase;
        }
        .priority-badge.critical { background: #dc3545; color: white; }
        .priority-badge.high { background: #fd7e14; color: white; }
        .priority-badge.medium { background: #17a2b8; color: white; }
        .priority-badge.routine { background: #6c757d; color: white; }
        
        .status-badge {
            font-size: 0.65rem;
            padding: 2px 6px;
            border-radius: 4px;
        }
        .status-badge.pending { background: #fff3cd; color: #856404; }
        .status-badge.in_progress { background: #cce5ff; color: #004085; }
        .status-badge.completed { background: #d4edda; color: #155724; }
        .status-badge.overdue { background: #f8d7da; color: #721c24; }

        .deadline-text { font-size: 0.75rem; }
        .deadline-text.overdue { color: #dc3545; font-weight: bold; }
        .deadline-text.today { color: #fd7e14; font-weight: bold; }
        .deadline-text.upcoming { color: #28a745; }

        .auto-badge {
            font-size: 0.6rem;
            background: linear-gradient(135deg, #6f42c1, #e83e8c);
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
        }
    </style>
</head>
<body>

    <!-- Sidebar -->
    <aside class="sidebar">
        <div class="sidebar-header">
            <a href="#" class="brand-logo">
                <i class="fas fa-building"></i> <span>Block Admin</span>
            </a>
        </div>
        <div class="nav-menu py-3" style="overflow-y: auto; flex: 1;">
            <nav class="nav flex-column">
            <a href="#" class="nav-link active" data-page="dashboard">
                <i class="fas fa-tachometer-alt"></i> <span>Dashboard</span>
            </a>
            <a href="#" class="nav-link" data-page="ai-alerts">
                <i class="fas fa-robot"></i> <span>AI Alerts Center</span>
            </a>
            <a href="#" class="nav-link" data-page="task-engine">
                <i class="fas fa-tasks"></i> <span>Task Engine</span>
            </a>
            <a href="#" class="nav-link" data-page="workforce">
                <i class="fas fa-users-cog"></i> <span>ASHA/ANM Workforce</span>
            </a>
            <a href="#" class="nav-link" data-page="supplies">
                <i class="fas fa-boxes"></i> <span>Supply Chain</span>
            </a>
            <a href="#" class="nav-link" data-page="outreach">
                <i class="fas fa-bullhorn"></i> <span>Outreach Intelligence</span>
            </a>
            <a href="#" class="nav-link" data-page="performance">
                <i class="fas fa-chart-pie"></i> <span>Block Performance</span>
            </a>
            <a href="#" class="nav-link" data-page="phc-compare">
                <i class="fas fa-hospital"></i> <span>PHC Comparison</span>
            </a>
            <a href="#" class="nav-link" data-page="communication">
                <i class="fas fa-broadcast-tower"></i> <span>Broadcast Center</span>
            </a>
            <a href="#" class="nav-link" data-page="emergency-response">
                <i class="fas fa-ambulance"></i> <span>Emergency Response</span>
            </a>
            <a href="#" class="nav-link" data-page="reports">
                <i class="fas fa-chart-bar"></i> <span>Reports</span>
            </a>
            <a href="#" class="nav-link" data-page="admin-team">
                <i class="fas fa-users-cog"></i> <span>Admin Team</span>
            </a>
            <a href="#" class="nav-link" data-page="security-center">
                <i class="fas fa-shield-alt"></i> <span>Security Center</span>
            </a>
            <a href="#" class="nav-link" data-page="admin-controls">
                <i class="fas fa-cogs"></i> <span>Admin Controls</span>
            </a>
            </nav>
        </div>
        <!-- Sidebar Toggle Button -->
        <div class="sidebar-toggle" id="sidebarToggle" title="Toggle Sidebar">
            <i class="fas fa-chevron-left"></i>
        </div>
        <div class="user-info">
            <div class="d-flex align-items-center gap-3">
                <div class="user-avatar">
                    {{ user.first_name[0] if user.first_name else 'B' }}{{ user.last_name[0] if user.last_name else 'A' }}
                </div>
                <div class="text-white">
                    <div class="fw-semibold">{{ user.full_name }}</div>
                    <small class="opacity-75">Block Admin</small>
                    <div class="small opacity-50" style="font-size: 0.7rem;">UID: {{ user.uid }}</div>
                </div>
            </div>
            <a href="{{ url_for('logout') }}" class="btn btn-outline-light btn-sm w-100 mt-3"><i class="fas fa-sign-out-alt me-2"></i>Logout</a>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
        <!-- Top Header -->
        <header class="top-header">
            <h4 class="mb-0 fw-bold">Block Health Dashboard</h4>
            <div class="d-flex align-items-center gap-3">
                <div class="text-end d-none d-sm-block">
                    <div class="small text-muted" id="currentDate"></div>
                    <div class="fw-bold text-danger">Block Admin Portal</div>
                </div>
                <button class="btn btn-light rounded-circle position-relative" id="refreshBtn" title="Refresh Data">
                    <i class="fas fa-sync-alt"></i>
                </button>
                <a href="{{ url_for('logout') }}" class="btn btn-outline-danger d-flex align-items-center gap-2">
                    <i class="fas fa-sign-out-alt"></i>
                    <span class="d-none d-md-inline">Logout</span>
                </a>
            </div>
        </header>

        <!-- Content Body -->
        <div class="content-body">
            
            <!-- DASHBOARD PAGE -->
            <div id="dashboard-page" class="content-page active">
            <!-- KPI Section Header -->
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-white border-0 py-3 d-flex justify-content-between align-items-center">
                    <h6 class="mb-0 fw-bold"><i class="fas fa-heartbeat me-2 text-danger"></i>Block Health KPIs</h6>
                    <div class="d-flex align-items-center gap-2">
                        <span class="badge bg-success"><i class="fas fa-circle me-1" style="font-size: 0.5rem;"></i> Live</span>
                        <small class="text-muted" id="lastUpdated">Last updated: Just now</small>
                    </div>
                </div>
                <div class="card-body">
                    
                    <!-- Row 1: 3 KPIs -->
                    <div class="row g-3 mb-3">
                        <!-- KPI 1: Population Coverage -->
                        <div class="col-md-4">
                            <div class="kpi-card">
                                <div class="d-flex justify-content-between align-items-start mb-3">
                                    <div>
                                        <div class="kpi-label">Population Coverage</div>
                                        <div class="kpi-value" id="kpiPopulation">--</div>
                                    </div>
                                    <i class="fas fa-users fa-2x opacity-50"></i>
                                </div>
                                <div class="kpi-detail">
                                    <span id="kpiPopEnrolled">--</span> of <span id="kpiPopEligible">--</span> eligible enrolled
                                </div>
                                <div class="progress mt-2">
                                    <div class="progress-bar" role="progressbar" id="kpiPopProgress" style="width: 0%"></div>
                                </div>
                                <div class="d-flex justify-content-between mt-2">
                                    <span class="kpi-badge"><i class="fas fa-bullseye me-1"></i>Target: 85%</span>
                                    <span class="kpi-badge" id="kpiPopTrend"><i class="fas fa-arrow-up me-1"></i>+0%</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- KPI 2: Active Field Teams -->
                        <div class="col-md-4">
                            <div class="kpi-card success">
                                <div class="d-flex justify-content-between align-items-start mb-3">
                                    <div>
                                        <div class="kpi-label">Active Field Teams Today</div>
                                        <div class="kpi-value"><span id="kpiFieldTeams">--</span><span class="fs-5">/<span id="kpiFieldTeamsTotal">--</span></span></div>
                                    </div>
                                    <i class="fas fa-user-nurse fa-2x opacity-50"></i>
                                </div>
                                <div class="row g-2 mt-2">
                                    <div class="col-6">
                                        <div class="quick-stat">
                                            <div class="quick-stat-value" id="kpiAshaOnline">--</div>
                                            <div class="quick-stat-label">ASHAs Online</div>
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <div class="quick-stat">
                                            <div class="quick-stat-value" id="kpiAnmOnline">--</div>
                                            <div class="quick-stat-label">ANMs Online</div>
                                        </div>
                                    </div>
                                </div>
                                <div class="kpi-detail mt-2">
                                    <i class="fas fa-clock me-1"></i>Last sync: <span id="kpiLastSync">--</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- KPI 3: AI-Flagged High-Risk Patients -->
                        <div class="col-md-4">
                            <div class="kpi-card warning">
                                <div class="d-flex justify-content-between align-items-start mb-3">
                                    <div>
                                        <div class="kpi-label">AI-Flagged High-Risk Patients</div>
                                        <div class="kpi-value" id="kpiHighRisk">--</div>
                                    </div>
                                    <i class="fas fa-brain fa-2x opacity-50"></i>
                                </div>
                                <div class="row g-2 mt-2">
                                    <div class="col-6">
                                        <div class="quick-stat">
                                            <div class="quick-stat-value" id="kpiHypertension">--</div>
                                            <div class="quick-stat-label">Hypertension</div>
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <div class="quick-stat">
                                            <div class="quick-stat-value" id="kpiDiabetes">--</div>
                                            <div class="quick-stat-label">Diabetes</div>
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <div class="quick-stat">
                                            <div class="quick-stat-value" id="kpiPregnancy">--</div>
                                            <div class="quick-stat-label">Pregnancy Risk</div>
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <div class="quick-stat">
                                            <div class="quick-stat-value" id="kpiTB">--</div>
                                            <div class="quick-stat-label">TB Suspects</div>
                                        </div>
                                    </div>
                                </div>
                                <div class="kpi-detail mt-2">
                                    <span class="kpi-badge"><i class="fas fa-plus me-1"></i><span id="kpiNewToday">--</span> new today</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Row 2: 3 KPIs -->
                    <div class="row g-3">
                        <!-- KPI 4: Supply Stock Index -->
                        <div class="col-md-4">
                            <div class="kpi-card info">
                                <div class="d-flex justify-content-between align-items-start mb-3">
                                    <div>
                                        <div class="kpi-label">Supply Stock Index</div>
                                        <div class="kpi-value" id="kpiSupplyIndex">--</div>
                                    </div>
                                    <i class="fas fa-boxes fa-2x opacity-50"></i>
                                </div>
                                <div class="row g-2 mt-2">
                                    <div class="col-4">
                                        <div class="quick-stat">
                                            <div class="quick-stat-value" id="kpiVaccines">--</div>
                                            <div class="quick-stat-label">Vaccines</div>
                                        </div>
                                    </div>
                                    <div class="col-4">
                                        <div class="quick-stat">
                                            <div class="quick-stat-value" id="kpiMedicines">--</div>
                                            <div class="quick-stat-label">Medicines</div>
                                        </div>
                                    </div>
                                    <div class="col-4">
                                        <div class="quick-stat">
                                            <div class="quick-stat-value" id="kpiTestkits">--</div>
                                            <div class="quick-stat-label">Test Kits</div>
                                        </div>
                                    </div>
                                </div>
                                <div class="kpi-detail mt-2">
                                    <span class="kpi-badge bg-danger"><i class="fas fa-exclamation me-1"></i><span id="kpiCritical">--</span> critical items</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- KPI 5: Immunization Defaulters -->
                        <div class="col-md-4">
                            <div class="kpi-card purple">
                                <div class="d-flex justify-content-between align-items-start mb-3">
                                    <div>
                                        <div class="kpi-label">Immunization Defaulters</div>
                                        <div class="kpi-value" id="kpiDefaulters">--</div>
                                    </div>
                                    <i class="fas fa-syringe fa-2x opacity-50"></i>
                                </div>
                                <div class="row g-2 mt-2">
                                    <div class="col-3">
                                        <div class="quick-stat">
                                            <div class="quick-stat-value" id="kpiBCG">--</div>
                                            <div class="quick-stat-label">BCG</div>
                                        </div>
                                    </div>
                                    <div class="col-3">
                                        <div class="quick-stat">
                                            <div class="quick-stat-value" id="kpiOPV">--</div>
                                            <div class="quick-stat-label">OPV</div>
                                        </div>
                                    </div>
                                    <div class="col-3">
                                        <div class="quick-stat">
                                            <div class="quick-stat-value" id="kpiDPT">--</div>
                                            <div class="quick-stat-label">DPT</div>
                                        </div>
                                    </div>
                                    <div class="col-3">
                                        <div class="quick-stat">
                                            <div class="quick-stat-value" id="kpiMeasles">--</div>
                                            <div class="quick-stat-label">Measles</div>
                                        </div>
                                    </div>
                                </div>
                                <div class="kpi-detail mt-2">
                                    <span class="kpi-badge"><i class="fas fa-clock me-1"></i><span id="kpiOverdue">--</span> overdue >7 days</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- KPI 6: Emergency Alerts (24hr) -->
                        <div class="col-md-4">
                            <div class="kpi-card cyan">
                                <div class="d-flex justify-content-between align-items-start mb-3">
                                    <div>
                                        <div class="kpi-label">Emergency Alerts (24hr)</div>
                                        <div class="kpi-value" id="kpiEmergency">--</div>
                                    </div>
                                    <i class="fas fa-ambulance fa-2x opacity-50"></i>
                                </div>
                                <div class="row g-2 mt-2">
                                    <div class="col-4">
                                        <div class="quick-stat">
                                            <div class="quick-stat-value" id="kpiFalls">--</div>
                                            <div class="quick-stat-label">Falls</div>
                                        </div>
                                    </div>
                                    <div class="col-4">
                                        <div class="quick-stat">
                                            <div class="quick-stat-value" id="kpiSevere">--</div>
                                            <div class="quick-stat-label">Severe</div>
                                        </div>
                                    </div>
                                    <div class="col-4">
                                        <div class="quick-stat">
                                            <div class="quick-stat-value" id="kpiMaternal">--</div>
                                            <div class="quick-stat-label">Maternal</div>
                                        </div>
                                    </div>
                                </div>
                                <div class="d-flex justify-content-between mt-2">
                                    <span class="kpi-badge bg-success"><i class="fas fa-check me-1"></i><span id="kpiResolved">--</span> resolved</span>
                                    <span class="kpi-badge bg-warning text-dark"><i class="fas fa-clock me-1"></i><span id="kpiPending">--</span> pending</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                </div>
            </div>
            
            <!-- GEO-HEALTH MAP SECTION (on same dashboard) -->
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-white border-0 py-3">
                    <h6 class="mb-0 fw-bold"><i class="fas fa-map-marked-alt text-danger me-2"></i>Geo-Health Heatmap</h6>
                    <small class="text-muted">Real-time GIS map showing village-wise health status and risk indicators</small>
                </div>
                <div class="card-body">
                    <!-- Summary Stats Row -->
                    <div class="row g-2 mb-3">
                        <div class="col">
                            <div class="text-center p-2 rounded" style="background: #f5f5f5;">
                                <div class="h5 fw-bold text-danger mb-0" id="mapTotalVillages">--</div>
                                <small class="text-muted">Villages</small>
                            </div>
                        </div>
                        <div class="col">
                            <div class="text-center p-2 rounded" style="background: #ffebee;">
                                <div class="h5 fw-bold mb-0" style="color: #dc3545;" id="mapHighRisk">--</div>
                                <small class="text-muted">High Risk</small>
                            </div>
                        </div>
                        <div class="col">
                            <div class="text-center p-2 rounded" style="background: #fff3e0;">
                                <div class="h5 fw-bold mb-0" style="color: #fd7e14;" id="mapModerateRisk">--</div>
                                <small class="text-muted">Moderate</small>
                            </div>
                        </div>
                        <div class="col">
                            <div class="text-center p-2 rounded" style="background: #e8f5e9;">
                                <div class="h5 fw-bold mb-0" style="color: #28a745;" id="mapStableVillages">--</div>
                                <small class="text-muted">Stable</small>
                            </div>
                        </div>
                        <div class="col">
                            <div class="text-center p-2 rounded" style="background: #e3f2fd;">
                                <div class="h5 fw-bold text-info mb-0" id="mapAIAlerts">--</div>
                                <small class="text-muted">AI Alerts</small>
                            </div>
                        </div>
                        <div class="col">
                            <div class="text-center p-2 rounded" style="background: #f3e5f5;">
                                <div class="h5 fw-bold mb-0" style="color: #9c27b0;" id="kpiTotalClients">--</div>
                                <small class="text-muted">Registered Clients</small>
                            </div>
                        </div>
                    </div>

                    <!-- Layer Toggles & Legend Row -->
                    <div class="d-flex flex-wrap justify-content-between align-items-center mb-3 gap-2">
                        <div class="d-flex flex-wrap gap-1">
                            <button class="layer-toggle active btn-sm" data-layer="maternal"><i class="fas fa-baby"></i> Maternal</button>
                            <button class="layer-toggle active btn-sm" data-layer="tb"><i class="fas fa-lungs"></i> TB</button>
                            <button class="layer-toggle active btn-sm" data-layer="fever"><i class="fas fa-thermometer-half"></i> Fever</button>
                            <button class="layer-toggle active btn-sm" data-layer="immunization"><i class="fas fa-syringe"></i> Immun.</button>
                            <button class="layer-toggle active btn-sm" data-layer="waterborne"><i class="fas fa-tint"></i> Water</button>
                        </div>
                        <div class="d-flex align-items-center gap-2">
                            <div class="map-legend d-flex gap-2">
                                <span class="d-flex align-items-center gap-1"><div class="legend-marker high"></div> High</span>
                                <span class="d-flex align-items-center gap-1"><div class="legend-marker moderate"></div> Moderate</span>
                                <span class="d-flex align-items-center gap-1"><div class="legend-marker stable"></div> Stable</span>
                            </div>
                            <button class="btn btn-sm btn-outline-danger" id="refreshMapBtn"><i class="fas fa-sync-alt"></i></button>
                        </div>
                    </div>

                    <!-- Map Container -->
                    <div id="geoHealthMap"></div>
                </div>
            </div>
            
            </div><!-- End Dashboard Page -->

            <!-- AI ALERTS COMMAND CENTER PAGE -->
            <div id="ai-alerts-page" class="content-page">
                <div class="mb-4">
                    <h5 class="fw-bold mb-1"><i class="fas fa-robot text-danger me-2"></i>AI Alerts Command Center</h5>
                    <p class="text-muted mb-0">Real-time health intelligence powered by 5 AI engines</p>
                </div>

                <!-- AI Engines Status -->
                <div class="row g-3 mb-4" id="aiEnginesContainer">
                    <!-- AI Engine cards will be rendered here -->
                </div>

                <!-- Alert Summary & Filters -->
                <div class="card border-0 shadow-sm mb-4">
                    <div class="card-header bg-white border-0 py-3 d-flex flex-wrap justify-content-between align-items-center gap-2">
                        <div>
                            <h6 class="mb-0 fw-bold"><i class="fas fa-bell text-danger me-2"></i>Active Alerts</h6>
                            <small class="text-muted"><span id="alertTotalCount">--</span> alerts • <span id="alertCriticalCount" class="text-danger fw-bold">--</span> critical</small>
                        </div>
                        <div class="d-flex flex-wrap gap-2">
                            <!-- Severity Filters -->
                            <div class="btn-group btn-group-sm" role="group">
                                <button type="button" class="btn btn-outline-secondary active" data-severity="all">All</button>
                                <button type="button" class="btn btn-outline-danger" data-severity="critical">Critical</button>
                                <button type="button" class="btn btn-outline-warning" data-severity="high">High</button>
                                <button type="button" class="btn btn-outline-info" data-severity="medium">Medium</button>
                            </div>
                            <button class="btn btn-sm btn-outline-danger" id="refreshAlertsBtn">
                                <i class="fas fa-sync-alt me-1"></i>Refresh
                            </button>
                        </div>
                    </div>
                    <div class="card-body p-2">
                        <!-- Alert Type Tabs -->
                        <div class="d-flex flex-wrap gap-1 mb-3 p-2 bg-light rounded" id="alertTypeTabs">
                            <button class="btn btn-sm btn-danger active" data-type="all">
                                <i class="fas fa-list me-1"></i>All Alerts
                            </button>
                            <!-- Alert type buttons will be added dynamically -->
                        </div>
                    </div>
                </div>

                <!-- Alerts List -->
                <div id="alertsListContainer" class="row g-3">
                    <!-- Alert cards will be rendered here -->
                </div>
            </div><!-- End AI Alerts Page -->

            <!-- TASK ENGINE PAGE -->
            <div id="task-engine-page" class="content-page">
                <div class="d-flex flex-wrap justify-content-between align-items-center mb-4">
                    <div>
                        <h5 class="fw-bold mb-1"><i class="fas fa-tasks text-danger me-2"></i>AI-Powered Task Engine</h5>
                        <p class="text-muted mb-0">Block-level command center for task creation and assignment</p>
                    </div>
                    <button class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#createTaskModal">
                        <i class="fas fa-plus me-2"></i>Create New Task
                    </button>
                </div>

                <!-- Task Summary Cards -->
                <div class="row g-3 mb-4">
                    <div class="col-6 col-md-3 col-lg">
                        <div class="card border-0 shadow-sm text-center py-3" style="border-left: 4px solid #dc3545 !important;">
                            <div class="h4 fw-bold text-danger mb-0" id="taskTotalCount">--</div>
                            <small class="text-muted">Total Tasks</small>
                        </div>
                    </div>
                    <div class="col-6 col-md-3 col-lg">
                        <div class="card border-0 shadow-sm text-center py-3" style="background:#ffebee;">
                            <div class="h4 fw-bold mb-0" style="color:#dc3545;" id="taskOverdueCount">--</div>
                            <small class="text-muted">Overdue</small>
                        </div>
                    </div>
                    <div class="col-6 col-md-3 col-lg">
                        <div class="card border-0 shadow-sm text-center py-3" style="background:#fff3e0;">
                            <div class="h4 fw-bold mb-0" style="color:#fd7e14;" id="taskPendingCount">--</div>
                            <small class="text-muted">Pending</small>
                        </div>
                    </div>
                    <div class="col-6 col-md-3 col-lg">
                        <div class="card border-0 shadow-sm text-center py-3" style="background:#e3f2fd;">
                            <div class="h4 fw-bold text-info mb-0" id="taskInProgressCount">--</div>
                            <small class="text-muted">In Progress</small>
                        </div>
                    </div>
                    <div class="col-6 col-md-3 col-lg">
                        <div class="card border-0 shadow-sm text-center py-3" style="background:#e8f5e9;">
                            <div class="h4 fw-bold mb-0" style="color:#28a745;" id="taskCompletedCount">--</div>
                            <small class="text-muted">Completed</small>
                        </div>
                    </div>
                </div>

                <!-- Filters -->
                <div class="card border-0 shadow-sm mb-4">
                    <div class="card-body py-3">
                        <div class="d-flex flex-wrap gap-3 align-items-center">
                            <div>
                                <label class="form-label mb-1 small fw-bold">Priority</label>
                                <div class="btn-group btn-group-sm" id="taskPriorityFilter">
                                    <button class="btn btn-outline-secondary active" data-priority="all">All</button>
                                    <button class="btn btn-outline-danger" data-priority="critical">Critical</button>
                                    <button class="btn btn-outline-warning" data-priority="high">High</button>
                                    <button class="btn btn-outline-info" data-priority="medium">Medium</button>
                                    <button class="btn btn-outline-secondary" data-priority="routine">Routine</button>
                                </div>
                            </div>
                            <div>
                                <label class="form-label mb-1 small fw-bold">Status</label>
                                <div class="btn-group btn-group-sm" id="taskStatusFilter">
                                    <button class="btn btn-outline-secondary active" data-status="all">All</button>
                                    <button class="btn btn-outline-danger" data-status="overdue">Overdue</button>
                                    <button class="btn btn-outline-warning" data-status="pending">Pending</button>
                                    <button class="btn btn-outline-primary" data-status="in_progress">In Progress</button>
                                    <button class="btn btn-outline-success" data-status="completed">Completed</button>
                                </div>
                            </div>
                            <div>
                                <label class="form-label mb-1 small fw-bold">Source</label>
                                <div class="btn-group btn-group-sm" id="taskSourceFilter">
                                    <button class="btn btn-outline-secondary active" data-source="all">All</button>
                                    <button class="btn btn-outline-info" data-source="auto">AI Generated</button>
                                    <button class="btn btn-outline-primary" data-source="manual">Manual</button>
                                </div>
                            </div>
                            <button class="btn btn-sm btn-outline-danger ms-auto" id="refreshTasksBtn">
                                <i class="fas fa-sync-alt me-1"></i>Refresh
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Tasks List -->
                <div id="tasksListContainer" class="row g-3">
                    <!-- Task cards will be rendered here -->
                </div>
            </div><!-- End Task Engine Page -->

            <!-- WORKFORCE DASHBOARD PAGE -->
            <div id="workforce-page" class="content-page">
                <div class="d-flex flex-wrap justify-content-between align-items-center mb-4">
                    <div>
                        <h5 class="fw-bold mb-1"><i class="fas fa-users-cog text-danger me-2"></i>ASHA/ANM Workforce Dashboard</h5>
                        <p class="text-muted mb-0">Real-time monitoring of field health workers</p>
                    </div>
                    <button class="btn btn-outline-danger btn-sm" id="refreshWorkforceBtn">
                        <i class="fas fa-sync-alt me-1"></i>Refresh
                    </button>
                </div>

                <!-- Key Metrics -->
                <div class="row g-3 mb-4">
                    <div class="col-6 col-md-4 col-lg">
                        <div class="card border-0 shadow-sm text-center py-3" style="background:linear-gradient(135deg,#28a745,#20c997);">
                            <div class="h3 fw-bold text-white mb-0" id="wfActiveToday">--</div>
                            <small class="text-white-50">Active Today</small>
                        </div>
                    </div>
                    <div class="col-6 col-md-4 col-lg">
                        <div class="card border-0 shadow-sm text-center py-3" style="background:linear-gradient(135deg,#17a2b8,#6610f2);">
                            <div class="h3 fw-bold text-white mb-0" id="wfVisitsToday">--</div>
                            <small class="text-white-50">Visits Today</small>
                        </div>
                    </div>
                    <div class="col-6 col-md-4 col-lg">
                        <div class="card border-0 shadow-sm text-center py-3">
                            <div class="h3 fw-bold text-primary mb-0" id="wfAvgCoverage">--%</div>
                            <small class="text-muted">Avg Coverage</small>
                        </div>
                    </div>
                    <div class="col-6 col-md-4 col-lg">
                        <div class="card border-0 shadow-sm text-center py-3">
                            <div class="h3 fw-bold text-info mb-0" id="wfAvgVisitTime">-- min</div>
                            <small class="text-muted">Avg Visit Time</small>
                        </div>
                    </div>
                    <div class="col-6 col-md-4 col-lg">
                        <div class="card border-0 shadow-sm text-center py-3" style="background:#fff3e0;">
                            <div class="h3 fw-bold mb-0" style="color:#fd7e14;" id="wfMissed">--</div>
                            <small class="text-muted">Missed HH</small>
                        </div>
                    </div>
                    <div class="col-6 col-md-4 col-lg">
                        <div class="card border-0 shadow-sm text-center py-3" style="background:#d4edda;">
                            <div class="h3 fw-bold text-success mb-0" id="wfHighPerf">--</div>
                            <small class="text-muted">High Performers</small>
                        </div>
                    </div>
                    <div class="col-6 col-md-4 col-lg">
                        <div class="card border-0 shadow-sm text-center py-3" style="background:#f8d7da;">
                            <div class="h3 fw-bold text-danger mb-0" id="wfNeedsSupport">--</div>
                            <small class="text-muted">Needs Support</small>
                        </div>
                    </div>
                </div>

                <!-- Worker List -->
                <div class="card border-0 shadow-sm">
                    <div class="card-header bg-white border-0 py-3 d-flex justify-content-between align-items-center">
                        <h6 class="mb-0 fw-bold"><i class="fas fa-id-card text-danger me-2"></i>Field Workers</h6>
                        <div class="btn-group btn-group-sm" id="wfFilterGroup">
                            <button class="btn btn-outline-secondary active" data-filter="all">All</button>
                            <button class="btn btn-outline-success" data-filter="high">⭐ High Performers</button>
                            <button class="btn btn-outline-danger" data-filter="needs_support">⚠️ Needs Support</button>
                        </div>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover mb-0" id="workersTable">
                                <thead class="table-light">
                                    <tr>
                                        <th>Worker</th>
                                        <th>Status</th>
                                        <th>Visits Today</th>
                                        <th>Coverage</th>
                                        <th>Performance</th>
                                        <th>Pending</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="workersTableBody">
                                    <!-- Workers will be rendered here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div><!-- End Workforce Page -->

            <!-- SUPPLY CHAIN INTELLIGENCE PAGE -->
            <div id="supplies-page" class="content-page">
                <div class="d-flex flex-wrap justify-content-between align-items-center mb-4">
                    <div>
                        <h5 class="fw-bold mb-1"><i class="fas fa-boxes text-danger me-2"></i>Supply Chain Intelligence</h5>
                        <p class="text-muted mb-0">PHC/Sub-Center stock tracking with AI predictions</p>
                    </div>
                    <button class="btn btn-outline-danger btn-sm" id="refreshSupplyBtn">
                        <i class="fas fa-sync-alt me-1"></i>Refresh
                    </button>
                </div>

                <!-- Summary Metrics -->
                <div class="row g-3 mb-4">
                    <div class="col-6 col-md-4 col-lg-2">
                        <div class="card border-0 shadow-sm text-center py-3" style="background:#f8d7da;">
                            <div class="h4 fw-bold text-danger mb-0" id="scCritical">--</div>
                            <small class="text-muted">🚨 Critical</small>
                        </div>
                    </div>
                    <div class="col-6 col-md-4 col-lg-2">
                        <div class="card border-0 shadow-sm text-center py-3" style="background:#fff3cd;">
                            <div class="h4 fw-bold mb-0" style="color:#fd7e14;" id="scLow">--</div>
                            <small class="text-muted">⚠️ Low Stock</small>
                        </div>
                    </div>
                    <div class="col-6 col-md-4 col-lg-2">
                        <div class="card border-0 shadow-sm text-center py-3" style="background:#cce5ff;">
                            <div class="h4 fw-bold text-primary mb-0" id="scOverstock">--</div>
                            <small class="text-muted">📦 Overstock</small>
                        </div>
                    </div>
                    <div class="col-6 col-md-4 col-lg-2">
                        <div class="card border-0 shadow-sm text-center py-3" style="background:#ffeeba;">
                            <div class="h4 fw-bold mb-0" style="color:#856404;" id="scExpiring">--</div>
                            <small class="text-muted">⏰ Expiring Soon</small>
                        </div>
                    </div>
                    <div class="col-6 col-md-4 col-lg-2">
                        <div class="card border-0 shadow-sm text-center py-3" style="background:#721c24;color:white;">
                            <div class="h4 fw-bold mb-0" id="scExpired">--</div>
                            <small class="text-white-50">❌ Expired</small>
                        </div>
                    </div>
                    <div class="col-6 col-md-4 col-lg-2">
                        <div class="card border-0 shadow-sm text-center py-3">
                            <div class="h4 fw-bold text-info mb-0" id="scAlerts">--</div>
                            <small class="text-muted">🔔 Alerts</small>
                        </div>
                    </div>
                </div>

                <div class="row g-4">
                    <!-- Left: Alerts Panel -->
                    <div class="col-lg-4">
                        <div class="card border-0 shadow-sm h-100">
                            <div class="card-header bg-danger text-white py-2">
                                <h6 class="mb-0"><i class="fas fa-bell me-2"></i>AI Predictions & Alerts</h6>
                            </div>
                            <div class="card-body p-0" style="max-height:400px;overflow-y:auto;" id="scAlertsContainer">
                                <!-- Alerts will be rendered here -->
                            </div>
                        </div>
                    </div>

                    <!-- Right: Stock Dashboard -->
                    <div class="col-lg-8">
                        <!-- Category Tabs -->
                        <div class="card border-0 shadow-sm mb-3">
                            <div class="card-header bg-white py-2">
                                <div class="d-flex flex-wrap gap-1" id="stockCategoryTabs">
                                    <button class="btn btn-sm btn-danger active" data-category="all">All</button>
                                    <!-- Category tabs will be added here -->
                                </div>
                            </div>
                            <div class="card-body py-2">
                                <div class="d-flex gap-2 flex-wrap">
                                    <select class="form-select form-select-sm" style="width:auto;" id="scFacilityFilter">
                                        <option value="all">All Facilities</option>
                                    </select>
                                    <select class="form-select form-select-sm" style="width:auto;" id="scStatusFilter">
                                        <option value="all">All Status</option>
                                        <option value="critical">Critical Only</option>
                                        <option value="low">Low Stock</option>
                                        <option value="overstock">Overstock</option>
                                        <option value="adequate">Adequate</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- Stock Table -->
                        <div class="card border-0 shadow-sm">
                            <div class="card-body p-0">
                                <div class="table-responsive" style="max-height:350px;">
                                    <table class="table table-hover table-sm mb-0">
                                        <thead class="table-light sticky-top">
                                            <tr>
                                                <th>Item</th>
                                                <th>Facility</th>
                                                <th>Stock</th>
                                                <th>Status</th>
                                                <th>Days Left</th>
                                                <th>Expiry</th>
                                            </tr>
                                        </thead>
                                        <tbody id="stockTableBody">
                                            <!-- Stock items will be rendered here -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Demand Forecast -->
                <div class="card border-0 shadow-sm mt-4">
                    <div class="card-header bg-white py-2">
                        <h6 class="mb-0"><i class="fas fa-chart-line text-danger me-2"></i>4-Week Demand Forecast</h6>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-sm mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th>Period</th>
                                        <th>🌡️ Fever Cases</th>
                                        <th>🤰 ANC Visits</th>
                                        <th>💉 Immunization</th>
                                        <th>📈 Trend</th>
                                    </tr>
                                </thead>
                                <tbody id="demandForecastBody">
                                    <!-- Forecast data will be rendered here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div><!-- End Supply Chain Page -->

            <!-- OUTREACH INTELLIGENCE PAGE -->
            <div id="outreach-page" class="content-page">
                <div class="d-flex flex-wrap justify-content-between align-items-center mb-4">
                    <div>
                        <h5 class="fw-bold mb-1"><i class="fas fa-bullhorn text-danger me-2"></i>Outreach Intelligence</h5>
                        <p class="text-muted mb-0">Camp planning, coverage tracking & AI-driven insights</p>
                    </div>
                    <button class="btn btn-outline-danger btn-sm" id="refreshOutreachBtn">
                        <i class="fas fa-sync-alt me-1"></i>Refresh
                    </button>
                </div>

                <!-- Summary Metrics -->
                <div class="row g-3 mb-4">
                    <div class="col-6 col-md-4 col-lg-2">
                        <div class="card border-0 shadow-sm text-center py-3" style="background:linear-gradient(135deg,#17a2b8,#20c997);">
                            <div class="h4 fw-bold text-white mb-0" id="orUpcomingCamps">--</div>
                            <small class="text-white-50">📅 Upcoming Camps</small>
                        </div>
                    </div>
                    <div class="col-6 col-md-4 col-lg-2">
                        <div class="card border-0 shadow-sm text-center py-3" style="background:#d4edda;">
                            <div class="h4 fw-bold text-success mb-0" id="orVillagesCovered">--</div>
                            <small class="text-muted">✅ Villages (30d)</small>
                        </div>
                    </div>
                    <div class="col-6 col-md-4 col-lg-2">
                        <div class="card border-0 shadow-sm text-center py-3" style="background:#f8d7da;">
                            <div class="h4 fw-bold text-danger mb-0" id="orNotVisited">--</div>
                            <small class="text-muted">⚠️ Not Visited 14d+</small>
                        </div>
                    </div>
                    <div class="col-6 col-md-4 col-lg-2">
                        <div class="card border-0 shadow-sm text-center py-3">
                            <div class="h4 fw-bold text-primary mb-0" id="orHouseholdCoverage">--%</div>
                            <small class="text-muted">🏠 HH Coverage</small>
                        </div>
                    </div>
                    <div class="col-6 col-md-4 col-lg-2">
                        <div class="card border-0 shadow-sm text-center py-3" style="background:#fff3cd;">
                            <div class="h4 fw-bold mb-0" style="color:#856404;" id="orCompliance">--%</div>
                            <small class="text-muted">📋 Report Compliance</small>
                        </div>
                    </div>
                    <div class="col-6 col-md-4 col-lg-2">
                        <div class="card border-0 shadow-sm text-center py-3" style="background:linear-gradient(135deg,#6f42c1,#e83e8c);color:white;">
                            <div class="h4 fw-bold mb-0" id="orAISuggestions">--</div>
                            <small class="text-white-50">🤖 AI Insights</small>
                        </div>
                    </div>
                </div>

                <div class="row g-4">
                    <!-- Left Column -->
                    <div class="col-lg-8">
                        <!-- Upcoming Camps -->
                        <div class="card border-0 shadow-sm mb-4">
                            <div class="card-header bg-white py-2 d-flex justify-content-between align-items-center">
                                <h6 class="mb-0 fw-bold"><i class="fas fa-calendar-alt text-danger me-2"></i>Upcoming Outreach Camps</h6>
                                <button class="btn btn-sm btn-danger"><i class="fas fa-plus me-1"></i>Schedule</button>
                            </div>
                            <div class="card-body p-0">
                                <div class="table-responsive" style="max-height:250px;">
                                    <table class="table table-hover table-sm mb-0">
                                        <thead class="table-light sticky-top">
                                            <tr><th>Camp</th><th>Village</th><th>Date</th><th>Team</th><th>Expected</th><th>Status</th></tr>
                                        </thead>
                                        <tbody id="upcomingCampsBody"></tbody>
                                    </table>
                                </div>
                            </div>
                        </div>

                        <!-- 30 Days Coverage -->
                        <div class="card border-0 shadow-sm mb-4">
                            <div class="card-header bg-white py-2">
                                <h6 class="mb-0 fw-bold"><i class="fas fa-map-marked-alt text-danger me-2"></i>Last 30 Days Village Coverage</h6>
                            </div>
                            <div class="card-body p-0">
                                <div class="table-responsive" style="max-height:250px;">
                                    <table class="table table-hover table-sm mb-0">
                                        <thead class="table-light sticky-top">
                                            <tr><th>Village</th><th>HH Coverage</th><th>Visits</th><th>Last Visit</th><th>Status</th></tr>
                                        </thead>
                                        <tbody id="coverageTableBody"></tbody>
                                    </table>
                                </div>
                            </div>
                        </div>

                        <!-- Camp Performance Review -->
                        <div class="card border-0 shadow-sm">
                            <div class="card-header bg-white py-2">
                                <h6 class="mb-0 fw-bold"><i class="fas fa-chart-line text-danger me-2"></i>Medical Camp Performance Review</h6>
                            </div>
                            <div class="card-body p-0">
                                <div class="table-responsive">
                                    <table class="table table-sm mb-0">
                                        <thead class="table-light">
                                            <tr><th>Camp</th><th>Village</th><th>Date</th><th>Attendance</th><th>Services</th><th>Score</th></tr>
                                        </thead>
                                        <tbody id="campPerformanceBody"></tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Right Column: AI Suggestions -->
                    <div class="col-lg-4">
                        <!-- Focus Areas -->
                        <div class="card border-0 shadow-sm mb-3">
                            <div class="card-header bg-danger text-white py-2">
                                <h6 class="mb-0"><i class="fas fa-crosshairs me-2"></i>Focus Area Hotspots</h6>
                            </div>
                            <div class="card-body p-0" id="focusAreasContainer" style="max-height:180px;overflow-y:auto;"></div>
                        </div>

                        <!-- Supply Drops -->
                        <div class="card border-0 shadow-sm mb-3">
                            <div class="card-header bg-warning py-2">
                                <h6 class="mb-0"><i class="fas fa-parachute-box me-2"></i>Supply Drops Required</h6>
                            </div>
                            <div class="card-body p-0" id="supplyDropsContainer" style="max-height:150px;overflow-y:auto;"></div>
                        </div>

                        <!-- Health Awareness -->
                        <div class="card border-0 shadow-sm mb-3">
                            <div class="card-header bg-info text-white py-2">
                                <h6 class="mb-0"><i class="fas fa-bullhorn me-2"></i>Health Awareness Needs</h6>
                            </div>
                            <div class="card-body p-0" id="awarenessContainer" style="max-height:150px;overflow-y:auto;"></div>
                        </div>

                        <!-- Rising Risk -->
                        <div class="card border-0 shadow-sm">
                            <div class="card-header text-white py-2" style="background:linear-gradient(135deg,#dc3545,#fd7e14);">
                                <h6 class="mb-0"><i class="fas fa-exclamation-triangle me-2"></i>Rising Risk Predictions</h6>
                            </div>
                            <div class="card-body p-0" id="risingRiskContainer" style="max-height:180px;overflow-y:auto;"></div>
                        </div>
                    </div>
                </div>

                <!-- Digital Report Compliance -->
                <div class="card border-0 shadow-sm mt-4">
                    <div class="card-header bg-white py-2">
                        <h6 class="mb-0 fw-bold"><i class="fas fa-file-alt text-danger me-2"></i>Digital Report Compliance</h6>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-sm mb-0">
                                <thead class="table-light">
                                    <tr><th>Worker</th><th>Role</th><th>Due</th><th>Submitted</th><th>Compliance</th><th>Last Submit</th></tr>
                                </thead>
                                <tbody id="complianceTableBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div><!-- End Outreach Page -->

            <!-- BLOCK PERFORMANCE DASHBOARD PAGE -->
            <div id="performance-page" class="content-page">
                <div class="d-flex flex-wrap justify-content-between align-items-center mb-4">
                    <div>
                        <h5 class="fw-bold mb-1"><i class="fas fa-chart-pie text-danger me-2"></i>Block Performance Dashboard</h5>
                        <p class="text-muted mb-0">Comprehensive health performance indicators</p>
                    </div>
                    <button class="btn btn-outline-danger btn-sm" id="refreshPerformanceBtn">
                        <i class="fas fa-sync-alt me-1"></i>Refresh
                    </button>
                </div>

                <!-- KPI Score Cards -->
                <div class="row g-3 mb-4">
                    <div class="col-6 col-md-4 col-lg">
                        <div class="card border-0 shadow-sm text-center py-3" style="background:linear-gradient(135deg,#dc3545,#ff6b6b);">
                            <div class="h2 fw-bold text-white mb-0" id="kpiHealthIndex">--</div>
                            <small class="text-white-50">🏥 Block Health Index</small>
                            <div class="mt-1"><span class="badge bg-light text-dark" id="kpiHealthTrend">--</span></div>
                        </div>
                    </div>
                    <div class="col-6 col-md-4 col-lg">
                        <div class="card border-0 shadow-sm text-center py-3" style="background:#ffe0e6;">
                            <div class="h3 fw-bold mb-0" style="color:#e83e8c;" id="kpiMaternal">--</div>
                            <small class="text-muted">🤰 Maternal Health</small>
                        </div>
                    </div>
                    <div class="col-6 col-md-4 col-lg">
                        <div class="card border-0 shadow-sm text-center py-3" style="background:#e0f7fa;">
                            <div class="h3 fw-bold mb-0" style="color:#00acc1;" id="kpiChild">--</div>
                            <small class="text-muted">👶 Child Health</small>
                        </div>
                    </div>
                    <div class="col-6 col-md-4 col-lg">
                        <div class="card border-0 shadow-sm text-center py-3" style="background:#fff3e0;">
                            <div class="h3 fw-bold mb-0" style="color:#ff9800;" id="kpiDisease">--</div>
                            <small class="text-muted">🦠 Disease Burden</small>
                        </div>
                    </div>
                    <div class="col-6 col-md-4 col-lg">
                        <div class="card border-0 shadow-sm text-center py-3" style="background:#e8f5e9;">
                            <div class="h3 fw-bold mb-0" style="color:#4caf50;" id="kpiOutreach">--</div>
                            <small class="text-muted">📣 Outreach Efficiency</small>
                        </div>
                    </div>
                    <div class="col-6 col-md-4 col-lg">
                        <div class="card border-0 shadow-sm text-center py-3" style="background:#e3f2fd;">
                            <div class="h3 fw-bold mb-0" style="color:#2196f3;" id="kpiMedicine">--</div>
                            <small class="text-muted">💊 Medicine Supply</small>
                        </div>
                    </div>
                    <div class="col-6 col-md-4 col-lg">
                        <div class="card border-0 shadow-sm text-center py-3" style="background:#f3e5f5;">
                            <div class="h3 fw-bold mb-0" style="color:#9c27b0;" id="kpiImmunization">--</div>
                            <small class="text-muted">💉 Immunization</small>
                        </div>
                    </div>
                </div>

                <!-- Performance Trend Chart -->
                <div class="card border-0 shadow-sm mb-4">
                    <div class="card-header bg-white py-2 d-flex justify-content-between align-items-center">
                        <h6 class="mb-0 fw-bold"><i class="fas fa-chart-line text-danger me-2"></i>Performance Trends</h6>
                        <div class="btn-group btn-group-sm" id="perfPeriodSelector">
                            <button class="btn btn-outline-danger active" data-period="7d">7 Days</button>
                            <button class="btn btn-outline-danger" data-period="30d">30 Days</button>
                            <button class="btn btn-outline-danger" data-period="quarterly">Quarterly</button>
                            <button class="btn btn-outline-danger" data-period="yearly">Yearly</button>
                        </div>
                    </div>
                    <div class="card-body">
                        <canvas id="performanceChart" height="300"></canvas>
                    </div>
                </div>

                <!-- Performance Breakdown -->
                <div class="row g-3">
                    <div class="col-md-4">
                        <div class="card border-0 shadow-sm h-100">
                            <div class="card-header bg-danger text-white py-2">
                                <h6 class="mb-0"><i class="fas fa-baby me-2"></i>Maternal Health Breakdown</h6>
                            </div>
                            <div class="card-body" id="maternalBreakdown">
                                <!-- Will be rendered -->
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card border-0 shadow-sm h-100">
                            <div class="card-header bg-info text-white py-2">
                                <h6 class="mb-0"><i class="fas fa-child me-2"></i>Child Health Breakdown</h6>
                            </div>
                            <div class="card-body" id="childBreakdown">
                                <!-- Will be rendered -->
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card border-0 shadow-sm h-100">
                            <div class="card-header bg-success text-white py-2">
                                <h6 class="mb-0"><i class="fas fa-bullhorn me-2"></i>Outreach Breakdown</h6>
                            </div>
                            <div class="card-body" id="outreachBreakdown">
                                <!-- Will be rendered -->
                            </div>
                        </div>
                    </div>
                </div>
            </div><!-- End Performance Page -->

            <!-- PHC PERFORMANCE COMPARISON PAGE -->
            <div id="phc-compare-page" class="content-page">
                <div class="d-flex flex-wrap justify-content-between align-items-center mb-4">
                    <div>
                        <h5 class="fw-bold mb-1"><i class="fas fa-hospital text-danger me-2"></i>PHC Performance Comparison</h5>
                        <p class="text-muted mb-0">Compare performance across all PHCs and Sub-Centers</p>
                    </div>
                    <button class="btn btn-outline-danger btn-sm" id="refreshPhcBtn">
                        <i class="fas fa-sync-alt me-1"></i>Refresh
                    </button>
                </div>

                <!-- Summary Stats -->
                <div class="row g-3 mb-4">
                    <div class="col-6 col-md-4 col-lg">
                        <div class="card border-0 shadow-sm text-center py-3">
                            <div class="h4 fw-bold text-primary mb-0" id="phcTotalPHC">--</div>
                            <small class="text-muted">🏥 PHCs</small>
                        </div>
                    </div>
                    <div class="col-6 col-md-4 col-lg">
                        <div class="card border-0 shadow-sm text-center py-3">
                            <div class="h4 fw-bold text-info mb-0" id="phcTotalSC">--</div>
                            <small class="text-muted">🏠 Sub-Centers</small>
                        </div>
                    </div>
                    <div class="col-6 col-md-4 col-lg">
                        <div class="card border-0 shadow-sm text-center py-3" style="background:#d4edda;">
                            <div class="h4 fw-bold text-success mb-0" id="phcAvgScore">--</div>
                            <small class="text-muted">📊 Avg Score</small>
                        </div>
                    </div>
                    <div class="col-6 col-md-4 col-lg">
                        <div class="card border-0 shadow-sm text-center py-3" style="background:#f8d7da;">
                            <div class="h4 fw-bold text-danger mb-0" id="phcNeedsSupport">--</div>
                            <small class="text-muted">⚠️ Needs Support</small>
                        </div>
                    </div>
                    <div class="col-6 col-md-4 col-lg">
                        <div class="card border-0 shadow-sm text-center py-3" style="background:#fff3cd;">
                            <div class="h4 fw-bold mb-0" style="color:#856404;" id="phcCriticalStock">--</div>
                            <small class="text-muted">💊 Critical Stock</small>
                        </div>
                    </div>
                </div>

                <div class="row g-4">
                    <!-- PHC Table -->
                    <div class="col-lg-8">
                        <div class="card border-0 shadow-sm">
                            <div class="card-header bg-white py-2">
                                <h6 class="mb-0 fw-bold"><i class="fas fa-table text-danger me-2"></i>Performance Comparison Table</h6>
                            </div>
                            <div class="card-body p-0">
                                <div class="table-responsive">
                                    <table class="table table-hover table-sm mb-0">
                                        <thead class="table-light">
                                            <tr>
                                                <th>PHC/SC</th>
                                                <th>Coverage %</th>
                                                <th>High Risk</th>
                                                <th>Staff</th>
                                                <th>Vaccine</th>
                                                <th>Alerts</th>
                                                <th>Score</th>
                                            </tr>
                                        </thead>
                                        <tbody id="phcTableBody"></tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- AI Recommendations -->
                    <div class="col-lg-4">
                        <div class="card border-0 shadow-sm mb-3">
                            <div class="card-header bg-danger text-white py-2">
                                <h6 class="mb-0"><i class="fas fa-life-ring me-2"></i>Needs Support</h6>
                            </div>
                            <div class="card-body p-0" id="phcNeedsSupportList" style="max-height:180px;overflow-y:auto;"></div>
                        </div>

                        <div class="card border-0 shadow-sm mb-3">
                            <div class="card-header bg-success text-white py-2">
                                <h6 class="mb-0"><i class="fas fa-trophy me-2"></i>Best Performers</h6>
                            </div>
                            <div class="card-body p-0" id="phcBestPerformers" style="max-height:120px;overflow-y:auto;"></div>
                        </div>

                        <div class="card border-0 shadow-sm">
                            <div class="card-header bg-warning py-2">
                                <h6 class="mb-0"><i class="fas fa-exchange-alt me-2"></i>Supply Redistribution</h6>
                            </div>
                            <div class="card-body p-0" id="phcSupplyRedist" style="max-height:150px;overflow-y:auto;"></div>
                        </div>
                    </div>
                </div>
            </div><!-- End PHC Compare Page -->

            <!-- COMMUNICATION & BROADCAST CENTER PAGE -->
            <div id="communication-page" class="content-page">
                <div class="d-flex flex-wrap justify-content-between align-items-center mb-4">
                    <div>
                        <h5 class="fw-bold mb-1"><i class="fas fa-broadcast-tower text-danger me-2"></i>Communication & Broadcast Center</h5>
                        <p class="text-muted mb-0">Send SMS, notifications, reminders & emergency alerts</p>
                    </div>
                    <button class="btn btn-outline-danger btn-sm" id="refreshCommBtn">
                        <i class="fas fa-sync-alt me-1"></i>Refresh
                    </button>
                </div>

                <!-- Stats -->
                <div class="row g-3 mb-4">
                    <div class="col-6 col-md-4 col-lg">
                        <div class="card border-0 shadow-sm text-center py-3">
                            <div class="h4 fw-bold text-success mb-0" id="commSentToday">--</div>
                            <small class="text-muted">📤 Sent Today</small>
                        </div>
                    </div>
                    <div class="col-6 col-md-4 col-lg">
                        <div class="card border-0 shadow-sm text-center py-3">
                            <div class="h4 fw-bold text-primary mb-0" id="commSentWeek">--</div>
                            <small class="text-muted">📊 This Week</small>
                        </div>
                    </div>
                    <div class="col-6 col-md-4 col-lg">
                        <div class="card border-0 shadow-sm text-center py-3">
                            <div class="h4 fw-bold text-info mb-0" id="commSentMonth">--</div>
                            <small class="text-muted">📅 This Month</small>
                        </div>
                    </div>
                    <div class="col-6 col-md-4 col-lg">
                        <div class="card border-0 shadow-sm text-center py-3" style="background:#d4edda;">
                            <div class="h4 fw-bold text-success mb-0" id="commDeliveryRate">--%</div>
                            <small class="text-muted">✅ Delivery Rate</small>
                        </div>
                    </div>
                    <div class="col-6 col-md-4 col-lg">
                        <div class="card border-0 shadow-sm text-center py-3" style="background:#fff3cd;">
                            <div class="h4 fw-bold mb-0" style="color:#856404;" id="commPending">--</div>
                            <small class="text-muted">⏰ Scheduled</small>
                        </div>
                    </div>
                </div>

                <div class="row g-4">
                    <!-- Compose Message -->
                    <div class="col-lg-5">
                        <div class="card border-0 shadow-sm h-100">
                            <div class="card-header bg-danger text-white py-2">
                                <h6 class="mb-0"><i class="fas fa-paper-plane me-2"></i>Compose New Message</h6>
                            </div>
                            <div class="card-body">
                                <form id="composeMessageForm">
                                    <div class="mb-3">
                                        <label class="form-label fw-bold">Message Type</label>
                                        <div class="btn-group w-100" id="msgTypeSelector">
                                            <button type="button" class="btn btn-outline-secondary active" data-type="sms">📱 SMS</button>
                                            <button type="button" class="btn btn-outline-secondary" data-type="push">🔔 Push</button>
                                            <button type="button" class="btn btn-outline-secondary" data-type="reminder">⏰ Reminder</button>
                                            <button type="button" class="btn btn-outline-danger" data-type="emergency">🚨 Emergency</button>
                                        </div>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label fw-bold">Recipients</label>
                                        <select class="form-select" id="msgRecipients" required>
                                            <option value="">Select recipients...</option>
                                        </select>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label fw-bold">Message</label>
                                        <textarea class="form-control" id="msgContent" rows="4" placeholder="Type your message..." required></textarea>
                                        <small class="text-muted"><span id="msgCharCount">0</span>/160 characters</small>
                                    </div>
                                    <div class="d-grid gap-2">
                                        <button type="submit" class="btn btn-danger"><i class="fas fa-paper-plane me-1"></i>Send Now</button>
                                        <button type="button" class="btn btn-outline-secondary"><i class="fas fa-clock me-1"></i>Schedule</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>

                    <!-- Templates & History -->
                    <div class="col-lg-7">
                        <!-- Templates -->
                        <div class="card border-0 shadow-sm mb-3">
                            <div class="card-header bg-white py-2">
                                <h6 class="mb-0 fw-bold"><i class="fas fa-file-alt text-danger me-2"></i>Quick Templates</h6>
                            </div>
                            <div class="card-body p-0">
                                <div class="d-flex flex-wrap gap-2 p-2" id="templatesList"></div>
                            </div>
                        </div>

                        <!-- Recent Broadcasts -->
                        <div class="card border-0 shadow-sm">
                            <div class="card-header bg-white py-2">
                                <h6 class="mb-0 fw-bold"><i class="fas fa-history text-danger me-2"></i>Recent Broadcasts</h6>
                            </div>
                            <div class="card-body p-0">
                                <div class="table-responsive" style="max-height:300px;">
                                    <table class="table table-hover table-sm mb-0">
                                        <thead class="table-light sticky-top">
                                            <tr><th>Type</th><th>Message</th><th>Recipients</th><th>Sent</th><th>Status</th></tr>
                                        </thead>
                                        <tbody id="broadcastHistory"></tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div><!-- End Communication Page -->

            <!-- EMERGENCY RESPONSE MODULE PAGE -->
            <div id="emergency-response-page" class="content-page">
                <div class="d-flex flex-wrap justify-content-between align-items-center mb-4">
                    <div>
                        <h5 class="fw-bold mb-1"><i class="fas fa-ambulance text-danger me-2"></i>Emergency Response Module</h5>
                        <p class="text-muted mb-0">Real-time emergency alerts & resource coordination</p>
                    </div>
                    <button class="btn btn-outline-danger btn-sm" id="refreshEmergencyBtn">
                        <i class="fas fa-sync-alt me-1"></i>Refresh
                    </button>
                </div>

                <!-- Summary Stats -->
                <div class="row g-3 mb-4">
                    <div class="col-6 col-md-4 col-lg">
                        <div class="card border-0 shadow-sm text-center py-3" style="background:linear-gradient(135deg,#dc3545,#ff6b6b);color:white;">
                            <div class="h3 fw-bold mb-0" id="emgActiveCount">--</div>
                            <small class="text-white-50">🚨 Active Emergencies</small>
                        </div>
                    </div>
                    <div class="col-6 col-md-4 col-lg">
                        <div class="card border-0 shadow-sm text-center py-3" style="background:#f8d7da;">
                            <div class="h4 fw-bold text-danger mb-0" id="emgCriticalCount">--</div>
                            <small class="text-muted">⚠️ Critical</small>
                        </div>
                    </div>
                    <div class="col-6 col-md-4 col-lg">
                        <div class="card border-0 shadow-sm text-center py-3" style="background:#d4edda;">
                            <div class="h4 fw-bold text-success mb-0" id="emgRespondingCount">--</div>
                            <small class="text-muted">✅ Responding</small>
                        </div>
                    </div>
                    <div class="col-6 col-md-4 col-lg">
                        <div class="card border-0 shadow-sm text-center py-3">
                            <div class="h4 fw-bold text-info mb-0" id="emgAvgResponse">--</div>
                            <small class="text-muted">⏱️ Avg Response</small>
                        </div>
                    </div>
                </div>

                <!-- Resource Availability -->
                <div class="card border-0 shadow-sm mb-4">
                    <div class="card-header bg-white py-2">
                        <h6 class="mb-0 fw-bold"><i class="fas fa-hands-helping text-danger me-2"></i>Resource Availability</h6>
                    </div>
                    <div class="card-body py-2">
                        <div class="row text-center">
                            <div class="col">
                                <div class="fw-bold text-primary" id="resAmbulances">--</div>
                                <small>🚑 Ambulances</small>
                            </div>
                            <div class="col">
                                <div class="fw-bold text-success" id="resPHCs">--</div>
                                <small>🏥 PHCs Operational</small>
                            </div>
                            <div class="col">
                                <div class="fw-bold text-info" id="resASHAs">--</div>
                                <small>👩‍⚕️ ASHAs Available</small>
                            </div>
                            <div class="col">
                                <div class="fw-bold text-warning" id="resDoctors">--</div>
                                <small>👨‍⚕️ Doctors On-Duty</small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Emergency Alerts List -->
                <div class="card border-0 shadow-sm">
                    <div class="card-header bg-danger text-white py-2 d-flex justify-content-between align-items-center">
                        <h6 class="mb-0"><i class="fas fa-bell me-2"></i>Active Emergency Alerts</h6>
                        <span class="badge bg-light text-danger" id="emgAlertCount">0</span>
                    </div>
                    <div class="card-body p-0" id="emergencyAlertsContainer" style="max-height:500px;overflow-y:auto;">
                        <!-- Emergency cards will be rendered here -->
                    </div>
                </div>
            </div><!-- End Emergency Response Page -->

            <!-- DOCUMENTS & REPORTING CENTER PAGE -->
            <div id="reports-page" class="content-page">
                <div class="d-flex flex-wrap justify-content-between align-items-center mb-4">
                    <div>
                        <h5 class="fw-bold mb-1"><i class="fas fa-file-alt text-danger me-2"></i>Documents & Reporting Center</h5>
                        <p class="text-muted mb-0">Generate, export, and manage block-level reports</p>
                    </div>
                    <button class="btn btn-outline-danger btn-sm" id="refreshReportsBtn">
                        <i class="fas fa-sync-alt me-1"></i>Refresh
                    </button>
                </div>

                <!-- Summary Stats -->
                <div class="row g-3 mb-4">
                    <div class="col-6 col-md-4 col-lg">
                        <div class="card border-0 shadow-sm text-center py-3">
                            <div class="h4 fw-bold text-primary mb-0" id="rptTotalGenerated">--</div>
                            <small class="text-muted">📊 Total Reports</small>
                        </div>
                    </div>
                    <div class="col-6 col-md-4 col-lg">
                        <div class="card border-0 shadow-sm text-center py-3" style="background:#d4edda;">
                            <div class="h4 fw-bold text-success mb-0" id="rptThisMonth">--</div>
                            <small class="text-muted">📅 This Month</small>
                        </div>
                    </div>
                    <div class="col-6 col-md-4 col-lg">
                        <div class="card border-0 shadow-sm text-center py-3">
                            <div class="h4 fw-bold text-info mb-0" id="rptScheduled">--</div>
                            <small class="text-muted">⏰ Scheduled</small>
                        </div>
                    </div>
                    <div class="col-6 col-md-4 col-lg">
                        <div class="card border-0 shadow-sm text-center py-3" style="background:#fff3cd;">
                            <div class="h4 fw-bold mb-0" style="color:#856404;" id="rptPending">--</div>
                            <small class="text-muted">⏳ Pending</small>
                        </div>
                    </div>
                    <div class="col-6 col-md-4 col-lg">
                        <div class="card border-0 shadow-sm text-center py-3">
                            <div class="h5 fw-bold text-secondary mb-0" id="rptStorage">--</div>
                            <small class="text-muted">💾 Storage Used</small>
                        </div>
                    </div>
                </div>

                <div class="row g-4">
                    <!-- Generate Report Section -->
                    <div class="col-lg-5">
                        <div class="card border-0 shadow-sm h-100">
                            <div class="card-header bg-danger text-white py-2">
                                <h6 class="mb-0"><i class="fas fa-plus-circle me-2"></i>Generate New Report</h6>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <label class="form-label fw-bold">Select Report Type</label>
                                    <div id="reportTypesList" class="d-flex flex-column gap-2"></div>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label fw-bold">Export Format</label>
                                    <div class="btn-group w-100" id="exportFormatSelector">
                                        <button type="button" class="btn btn-outline-danger active" data-format="pdf"><i class="fas fa-file-pdf me-1"></i>PDF</button>
                                        <button type="button" class="btn btn-outline-success" data-format="excel"><i class="fas fa-file-excel me-1"></i>Excel</button>
                                        <button type="button" class="btn btn-outline-info" data-format="api"><i class="fas fa-code me-1"></i>API</button>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label fw-bold">Date Range</label>
                                    <div class="row g-2">
                                        <div class="col-6"><input type="date" class="form-control" id="rptStartDate"></div>
                                        <div class="col-6"><input type="date" class="form-control" id="rptEndDate"></div>
                                    </div>
                                </div>
                                <button class="btn btn-danger w-100" id="generateReportBtn">
                                    <i class="fas fa-cog me-1"></i>Generate Report
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Recent Reports & Scheduled -->
                    <div class="col-lg-7">
                        <!-- Recent Reports -->
                        <div class="card border-0 shadow-sm mb-3">
                            <div class="card-header bg-white py-2">
                                <h6 class="mb-0 fw-bold"><i class="fas fa-history text-danger me-2"></i>Recent Reports</h6>
                            </div>
                            <div class="card-body p-0">
                                <div class="table-responsive" style="max-height:200px;">
                                    <table class="table table-hover table-sm mb-0">
                                        <thead class="table-light sticky-top">
                                            <tr><th>Report</th><th>Generated</th><th>Format</th><th>Size</th><th>Action</th></tr>
                                        </thead>
                                        <tbody id="recentReportsBody"></tbody>
                                    </table>
                                </div>
                            </div>
                        </div>

                        <!-- Scheduled Reports -->
                        <div class="card border-0 shadow-sm mb-3">
                            <div class="card-header bg-white py-2 d-flex justify-content-between align-items-center">
                                <h6 class="mb-0 fw-bold"><i class="fas fa-clock text-danger me-2"></i>Scheduled Reports</h6>
                                <button class="btn btn-sm btn-outline-danger"><i class="fas fa-plus me-1"></i>Add</button>
                            </div>
                            <div class="card-body p-0">
                                <div class="table-responsive">
                                    <table class="table table-sm mb-0">
                                        <thead class="table-light">
                                            <tr><th>Report</th><th>Schedule</th><th>Next Run</th><th>Format</th></tr>
                                        </thead>
                                        <tbody id="scheduledReportsBody"></tbody>
                                    </table>
                                </div>
                            </div>
                        </div>

                        <!-- API Endpoints -->
                        <div class="card border-0 shadow-sm">
                            <div class="card-header bg-info text-white py-2">
                                <h6 class="mb-0"><i class="fas fa-code me-2"></i>API Endpoints (National/State)</h6>
                            </div>
                            <div class="card-body p-0">
                                <div class="table-responsive">
                                    <table class="table table-sm mb-0">
                                        <thead class="table-light">
                                            <tr><th>API</th><th>Endpoint</th><th>Method</th><th>Last Called</th></tr>
                                        </thead>
                                        <tbody id="apiEndpointsBody"></tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div><!-- End Reports Page -->

            <!-- ADMIN TEAM PAGE (Phase 15: Multi-Admin Support) -->
            <div id="admin-team-page" class="content-page">
                <div class="d-flex flex-wrap justify-content-between align-items-center mb-4">
                    <div>
                        <h5 class="fw-bold mb-1"><i class="fas fa-users-cog text-danger me-2"></i>Admin Team Management</h5>
                        <p class="text-muted mb-0">Manage multiple admins for this block - assign roles and permissions</p>
                    </div>
                    <button class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#addAdminModal">
                        <i class="fas fa-user-plus me-2"></i>Add Admin
                    </button>
                </div>

                <!-- Summary Stats -->
                <div class="row g-3 mb-4">
                    <div class="col-6 col-md-3">
                        <div class="card border-0 shadow-sm text-center py-3">
                            <div class="h4 fw-bold text-danger mb-0" id="teamTotalAdmins">--</div>
                            <small class="text-muted">👥 Total Admins</small>
                        </div>
                    </div>
                    <div class="col-6 col-md-3">
                        <div class="card border-0 shadow-sm text-center py-3" style="background:#d4edda;">
                            <div class="h4 fw-bold text-success mb-0" id="teamActiveAdmins">--</div>
                            <small class="text-muted">✅ Active</small>
                        </div>
                    </div>
                    <div class="col-6 col-md-3">
                        <div class="card border-0 shadow-sm text-center py-3" style="background:#fff3cd;">
                            <div class="h4 fw-bold mb-0" style="color:#856404;" id="teamPrimaryAdmin">--</div>
                            <small class="text-muted">👑 Primary</small>
                        </div>
                    </div>
                    <div class="col-6 col-md-3">
                        <div class="card border-0 shadow-sm text-center py-3">
                            <div class="h4 fw-bold text-info mb-0" id="teamRolesCount">--</div>
                            <small class="text-muted">🎭 Roles</small>
                        </div>
                    </div>
                </div>

                <!-- Current Block Info -->
                <div class="card border-0 shadow-sm mb-4">
                    <div class="card-header bg-danger text-white py-2">
                        <h6 class="mb-0"><i class="fas fa-map-marker-alt me-2"></i>Current Block</h6>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-4">
                                <strong>Block ID:</strong> <span id="currentBlockId">{{ user.block_id or 'Not Assigned' }}</span>
                            </div>
                            <div class="col-md-4">
                                <strong>Block Name:</strong> <span id="currentBlockName">{{ user.jurisdiction or 'N/A' }}</span>
                            </div>
                            <div class="col-md-4">
                                <strong>Your Role:</strong> <span class="badge bg-danger">Primary Admin</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Admin Team Table -->
                <div class="card border-0 shadow-sm">
                    <div class="card-header bg-white border-0 py-3 d-flex justify-content-between align-items-center">
                        <h6 class="mb-0 fw-bold"><i class="fas fa-users text-danger me-2"></i>Block Admins</h6>
                        <button class="btn btn-sm btn-outline-danger" id="refreshTeamBtn">
                            <i class="fas fa-sync-alt me-1"></i>Refresh
                        </button>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th>Admin</th>
                                        <th>Email</th>
                                        <th>Role</th>
                                        <th>Status</th>
                                        <th>Assigned On</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="adminTeamTableBody">
                                    <tr>
                                        <td colspan="6" class="text-center text-muted py-4">
                                            <i class="fas fa-spinner fa-spin me-2"></i>Loading team members...
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Available Roles Card -->
                <div class="card border-0 shadow-sm mt-4">
                    <div class="card-header bg-white border-0 py-3">
                        <h6 class="mb-0 fw-bold"><i class="fas fa-user-tag text-danger me-2"></i>Available Roles</h6>
                    </div>
                    <div class="card-body">
                        <div class="row g-3" id="rolesContainer">
                            <div class="col-md-4">
                                <div class="border rounded p-3">
                                    <h6 class="fw-bold text-danger"><i class="fas fa-crown me-2"></i>Primary Admin</h6>
                                    <p class="small text-muted mb-0">Full control over block. Can manage all admins, workers, and settings.</p>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="border rounded p-3">
                                    <h6 class="fw-bold text-warning"><i class="fas fa-user-shield me-2"></i>Deputy Admin</h6>
                                    <p class="small text-muted mb-0">Can manage workers and view reports. Cannot modify primary admin.</p>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="border rounded p-3">
                                    <h6 class="fw-bold text-info"><i class="fas fa-eye me-2"></i>Viewer</h6>
                                    <p class="small text-muted mb-0">Read-only access to all data. Cannot make any modifications.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div><!-- End Admin Team Page -->

            <!-- Add Admin Modal -->
            <div class="modal fade" id="addAdminModal" tabindex="-1">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header bg-danger text-white">
                            <h5 class="modal-title"><i class="fas fa-user-plus me-2"></i>Add Admin to Block</h5>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <form id="addAdminForm">
                                <div class="mb-3">
                                    <label class="form-label fw-bold">User ID *</label>
                                    <input type="number" class="form-control" id="newAdminUserId" placeholder="Enter user ID" required>
                                    <small class="text-muted">User must already be registered in the system</small>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label fw-bold">Role *</label>
                                    <select class="form-select" id="newAdminRole" required>
                                        <option value="deputy_admin">Deputy Admin</option>
                                        <option value="data_entry">Data Entry</option>
                                        <option value="viewer">Viewer</option>
                                        <option value="supervisor">Supervisor</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label fw-bold">Notes</label>
                                    <textarea class="form-control" id="newAdminNotes" rows="2" placeholder="Optional notes"></textarea>
                                </div>
                            </form>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            <button type="button" class="btn btn-danger" id="submitAddAdmin">
                                <i class="fas fa-user-plus me-1"></i>Add Admin
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ADMIN CONTROLS PAGE -->
            <div id="admin-controls-page" class="content-page">
                <div class="d-flex flex-wrap justify-content-between align-items-center mb-4">
                    <div>
                        <h5 class="fw-bold mb-1"><i class="fas fa-cogs text-danger me-2"></i>Admin Controls</h5>
                        <p class="text-muted mb-0">Manage workers, villages, PHCs, programs, and settings</p>
                    </div>
                    <button class="btn btn-outline-danger btn-sm" id="refreshAdminBtn">
                        <i class="fas fa-sync-alt me-1"></i>Refresh
                    </button>
                </div>

                <!-- Summary Stats -->
                <div class="row g-3 mb-4">
                    <div class="col-6 col-md-4 col-lg">
                        <div class="card border-0 shadow-sm text-center py-3">
                            <div class="h4 fw-bold text-primary mb-0" id="adminTotalWorkers">--</div>
                            <small class="text-muted">👥 Health Workers</small>
                        </div>
                    </div>
                    <div class="col-6 col-md-4 col-lg">
                        <div class="card border-0 shadow-sm text-center py-3" style="background:#d4edda;">
                            <div class="h4 fw-bold text-success mb-0" id="adminActiveWorkers">--</div>
                            <small class="text-muted">✅ Active</small>
                        </div>
                    </div>
                    <div class="col-6 col-md-4 col-lg">
                        <div class="card border-0 shadow-sm text-center py-3">
                            <div class="h4 fw-bold text-info mb-0" id="adminVillages">--</div>
                            <small class="text-muted">🏘️ Villages</small>
                        </div>
                    </div>
                    <div class="col-6 col-md-4 col-lg">
                        <div class="card border-0 shadow-sm text-center py-3" style="background:#fff3cd;">
                            <div class="h4 fw-bold mb-0" style="color:#856404;" id="adminUnassigned">--</div>
                            <small class="text-muted">⚠️ Unassigned</small>
                        </div>
                    </div>
                    <div class="col-6 col-md-4 col-lg">
                        <div class="card border-0 shadow-sm text-center py-3">
                            <div class="h4 fw-bold text-danger mb-0" id="adminPendingTasks">--</div>
                            <small class="text-muted">📋 Pending Tasks</small>
                        </div>
                    </div>
                </div>

                <!-- Tabs -->
                <ul class="nav nav-tabs mb-3" id="adminTabs">
                    <li class="nav-item"><a class="nav-link active" href="#" data-tab="workers">👩‍⚕️ Workers</a></li>
                    <li class="nav-item"><a class="nav-link" href="#" data-tab="villages">🏘️ Villages</a></li>
                    <li class="nav-item"><a class="nav-link" href="#" data-tab="phcs">🏥 PHCs</a></li>
                    <li class="nav-item"><a class="nav-link" href="#" data-tab="programs">📋 Programs</a></li>
                    <li class="nav-item"><a class="nav-link" href="#" data-tab="roles">🔐 Roles</a></li>
                    <li class="nav-item"><a class="nav-link" href="#" data-tab="geo">🗺️ Geo Config</a></li>
                </ul>

                <!-- Tab Content -->
                <div id="adminTabContent">
                    <!-- Workers Tab -->
                    <div id="adminWorkersTab" class="admin-tab-pane">
                        <div class="d-flex justify-content-between mb-2">
                            <h6 class="fw-bold">ASHA/ANM Accounts</h6>
                            <button class="btn btn-sm btn-danger" data-bs-toggle="modal" data-bs-target="#addWorkerModal"><i class="fas fa-plus me-1"></i>Add Worker</button>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-hover table-sm">
                                <thead class="table-light"><tr><th>ID</th><th>Name</th><th>Role</th><th>Phone</th><th>Village</th><th>Status</th><th>Actions</th></tr></thead>
                                <tbody id="adminWorkersBody"></tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Villages Tab -->
                    <div id="adminVillagesTab" class="admin-tab-pane" style="display:none;">
                        <div class="d-flex justify-content-between mb-2">
                            <h6 class="fw-bold">Village Assignments</h6>
                            <button class="btn btn-sm btn-danger" data-bs-toggle="modal" data-bs-target="#addVillageModal"><i class="fas fa-plus me-1"></i>Add Village</button>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-hover table-sm">
                                <thead class="table-light"><tr><th>ID</th><th>Village</th><th>Population</th><th>Households</th><th>ASHA</th><th>ANM</th><th>Actions</th></tr></thead>
                                <tbody id="adminVillagesBody"></tbody>
                            </table>
                        </div>
                    </div>

                    <!-- PHCs Tab -->
                    <div id="adminPHCsTab" class="admin-tab-pane" style="display:none;">
                        <div class="d-flex justify-content-between mb-2">
                            <h6 class="fw-bold">PHC & Sub-Center Data</h6>
                            <button class="btn btn-sm btn-danger" data-bs-toggle="modal" data-bs-target="#addFacilityModal"><i class="fas fa-plus me-1"></i>Add Facility</button>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-hover table-sm">
                                <thead class="table-light"><tr><th>ID</th><th>Name</th><th>Type</th><th>Beds</th><th>Staff</th><th>Contact</th><th>Status</th><th>Actions</th></tr></thead>
                                <tbody id="adminPHCsBody"></tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Programs Tab -->
                    <div id="adminProgramsTab" class="admin-tab-pane" style="display:none;">
                        <div class="d-flex justify-content-between mb-2">
                            <h6 class="fw-bold">Community Health Programs</h6>
                            <button class="btn btn-sm btn-danger"><i class="fas fa-plus me-1"></i>Add Program</button>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-hover table-sm">
                                <thead class="table-light"><tr><th>ID</th><th>Program Name</th><th>Status</th><th>Beneficiaries</th><th>Start Date</th><th>Actions</th></tr></thead>
                                <tbody id="adminProgramsBody"></tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Roles Tab -->
                    <div id="adminRolesTab" class="admin-tab-pane" style="display:none;">
                        <div class="d-flex justify-content-between mb-2">
                            <h6 class="fw-bold">Local Roles & Permissions</h6>
                            <button class="btn btn-sm btn-danger"><i class="fas fa-plus me-1"></i>Add Role</button>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-hover table-sm">
                                <thead class="table-light"><tr><th>ID</th><th>Role Name</th><th>Permissions</th><th>Users</th><th>Actions</th></tr></thead>
                                <tbody id="adminRolesBody"></tbody>
                            </table>
                        </div>
                        <div class="mt-3">
                            <button class="btn btn-warning"><i class="fas fa-redo me-1"></i>Reset All Tasks</button>
                        </div>
                    </div>

                    <!-- Geo Config Tab -->
                    <div id="adminGeoTab" class="admin-tab-pane" style="display:none;">
                        <h6 class="fw-bold mb-3">Geo Boundary Configuration</h6>
                        <p class="text-muted small mb-3">Enter your block's center coordinates. After saving, the map will display this location.</p>
                        <div class="row g-3">
                            <div class="col-md-4"><label class="form-label">Block Name</label><input class="form-control" id="geoBlockName" readonly></div>
                            <div class="col-md-4"><label class="form-label">District</label><input class="form-control" id="geoDistrict" readonly></div>
                            <div class="col-md-4"><label class="form-label">State</label><input class="form-control" id="geoState" readonly></div>
                            <div class="col-md-4"><label class="form-label">Center Latitude *</label><input type="number" step="0.0001" class="form-control" id="geoCenterLat" placeholder="e.g., 28.6694" required></div>
                            <div class="col-md-4"><label class="form-label">Center Longitude *</label><input type="number" step="0.0001" class="form-control" id="geoCenterLng" placeholder="e.g., 75.0354" required></div>
                            <div class="col-md-4"><label class="form-label">Total Area</label><input class="form-control" id="geoTotalArea" placeholder="e.g., 250 sq km"></div>
                        </div>
                        <div class="mt-3">
                            <button class="btn btn-danger" id="btnSaveGeoConfig"><i class="fas fa-save me-1"></i>Save & Update Map</button>
                        </div>
                    </div>
                </div>
            </div><!-- End Admin Controls Page -->
            
        </div>

    <!-- Add Worker Modal -->
    <div class="modal fade" id="addWorkerModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title"><i class="fas fa-user-plus me-2"></i>Add New Health Worker</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="addWorkerForm">
                        <div class="mb-3">
                            <label class="form-label fw-bold">Full Name *</label>
                            <input type="text" class="form-control" id="workerName" placeholder="Enter full name" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-bold">Email *</label>
                            <input type="email" class="form-control" id="workerEmail" placeholder="Enter email address" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-bold">Mobile Number *</label>
                            <input type="tel" class="form-control" id="workerMobile" placeholder="10-digit mobile" pattern="[0-9]{10}" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-bold">Worker Type *</label>
                            <select class="form-select" id="workerType" required>
                                <option value="ASHA">ASHA Worker</option>
                                <option value="ANM">ANM (Auxiliary Nurse Midwife)</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-bold">Initial Password *</label>
                            <input type="password" class="form-control" id="workerPassword" placeholder="Minimum 6 characters" minlength="6" required>
                        </div>
                        <div class="alert alert-info small">
                            <i class="fas fa-info-circle me-1"></i>
                            Login credentials will be sent to the worker's email.
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" id="submitAddWorker">
                        <i class="fas fa-user-plus me-1"></i>Create Worker
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Facility/PHC Modal -->
    <div class="modal fade" id="addFacilityModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title"><i class="fas fa-hospital me-2"></i>Create New Facility (PHC/Sub-Center)</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="addFacilityForm">
                        <div class="row g-3">
                            <div class="col-md-8">
                                <label class="form-label fw-bold">Facility Name *</label>
                                <input type="text" class="form-control" id="facilityName" placeholder="e.g., PHC Rampur" required>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label fw-bold">Facility Type *</label>
                                <select class="form-select" id="facilityType" required>
                                    <option value="PHC">Primary Health Center (PHC)</option>
                                    <option value="Sub-Center">Sub-Center</option>
                                    <option value="CHC">Community Health Center (CHC)</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-bold">In-Charge Name *</label>
                                <input type="text" class="form-control" id="facilityInCharge" placeholder="Enter in-charge name" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-bold">Phone Number *</label>
                                <input type="tel" class="form-control" id="facilityPhone" placeholder="10-digit mobile" pattern="[0-9]{10}" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-bold">Email Address *</label>
                                <input type="email" class="form-control" id="facilityEmail" placeholder="facility@example.com" required>
                                <small class="text-muted">Login credentials will be sent here</small>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-bold">Login Password *</label>
                                <input type="password" class="form-control" id="facilityPassword" placeholder="Minimum 6 characters" minlength="6" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-bold">Village/Location *</label>
                                <input type="text" class="form-control" id="facilityVillage" placeholder="Village name" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-bold">Beds Count</label>
                                <input type="number" class="form-control" id="facilityBeds" value="0" min="0">
                            </div>
                            <div class="col-12">
                                <label class="form-label fw-bold">Full Address</label>
                                <textarea class="form-control" id="facilityAddress" rows="2" placeholder="Complete facility address"></textarea>
                            </div>
                        </div>
                        <div class="alert alert-info small mt-3">
                            <i class="fas fa-info-circle me-1"></i>
                            Login credentials will be sent to the facility email. They can use these to access the Facility Dashboard.
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" id="submitAddFacility">
                        <i class="fas fa-hospital me-1"></i>Create Facility
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Village Modal -->
    <div class="modal fade" id="addVillageModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title"><i class="fas fa-map-marker-alt me-2"></i>Add New Village</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="addVillageForm">
                        <div class="mb-3">
                            <label class="form-label fw-bold">Village Name *</label>
                            <input type="text" class="form-control" id="villageName" placeholder="Enter village name" required>
                        </div>
                        <div class="row g-3">
                            <div class="col-6">
                                <label class="form-label fw-bold">Population (est.)</label>
                                <input type="number" class="form-control" id="villagePopulation" placeholder="e.g., 1500" min="0">
                            </div>
                            <div class="col-6">
                                <label class="form-label fw-bold">Households (est.)</label>
                                <input type="number" class="form-control" id="villageHouseholds" placeholder="e.g., 300" min="0">
                            </div>
                        </div>
                        <div class="mb-3 mt-3">
                            <label class="form-label fw-bold">Pincode</label>
                            <input type="text" class="form-control" id="villagePincode" placeholder="6-digit pincode" maxlength="6">
                        </div>
                        <div class="row g-3">
                            <div class="col-6">
                                <label class="form-label">Latitude</label>
                                <input type="number" step="0.0001" class="form-control" id="villageLatitude" placeholder="e.g., 26.9124">
                            </div>
                            <div class="col-6">
                                <label class="form-label">Longitude</label>
                                <input type="number" step="0.0001" class="form-control" id="villageLongitude" placeholder="e.g., 75.7873">
                            </div>
                        </div>
                        <div class="alert alert-info small mt-3 mb-0">
                            <i class="fas fa-info-circle me-1"></i>
                            Village will be added to your block. You can assign ASHA/ANM workers later.
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" id="submitAddVillage">
                        <i class="fas fa-plus me-1"></i>Add Village
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Assign Village Workers Modal -->
    <div class="modal fade" id="assignVillageModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title"><i class="fas fa-user-plus me-2"></i>Assign Workers: <span id="assignVillageTitle">Village</span></h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="assignVillageId">
                    <div class="mb-3">
                        <label class="form-label fw-bold">ASHA</label>
                        <select class="form-select" id="assignVillageAsha">
                            <option value="">-- Unassigned --</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-bold">ANM</label>
                        <select class="form-select" id="assignVillageAnm">
                            <option value="">-- Unassigned --</option>
                        </select>
                    </div>
                    <div class="alert alert-info small mb-0">
                        <i class="fas fa-info-circle me-1"></i>
                        Only workers in your block are shown here.
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" id="submitAssignVillage">
                        <i class="fas fa-save me-1"></i>Save Assignment
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Village Modal -->
    <div class="modal fade" id="editVillageModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-secondary text-white">
                    <h5 class="modal-title"><i class="fas fa-edit me-2"></i>Edit Village</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editVillageForm">
                        <input type="hidden" id="editVillageId">
                        <div class="mb-3">
                            <label class="form-label fw-bold">Village Name *</label>
                            <input type="text" class="form-control" id="editVillageName" required>
                        </div>
                        <div class="row g-3">
                            <div class="col-6">
                                <label class="form-label fw-bold">Population</label>
                                <input type="number" class="form-control" id="editVillagePopulation" min="0">
                            </div>
                            <div class="col-6">
                                <label class="form-label fw-bold">Households</label>
                                <input type="number" class="form-control" id="editVillageHouseholds" min="0">
                            </div>
                        </div>
                        <div class="mb-3 mt-3">
                            <label class="form-label fw-bold">Pincode</label>
                            <input type="text" class="form-control" id="editVillagePincode" maxlength="6">
                        </div>
                        <div class="row g-3">
                            <div class="col-6">
                                <label class="form-label">Latitude</label>
                                <input type="number" step="0.0001" class="form-control" id="editVillageLatitude">
                            </div>
                            <div class="col-6">
                                <label class="form-label">Longitude</label>
                                <input type="number" step="0.0001" class="form-control" id="editVillageLongitude">
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-secondary" id="submitEditVillage">
                        <i class="fas fa-save me-1"></i>Save Changes
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Facility Modal -->
    <div class="modal fade" id="editFacilityModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title"><i class="fas fa-hospital me-2"></i>Edit Facility</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editFacilityForm">
                        <input type="hidden" id="editFacilityId">
                        <div class="row g-3">
                            <div class="col-md-8">
                                <label class="form-label fw-bold">Facility Name</label>
                                <input type="text" class="form-control" id="editFacilityName">
                            </div>
                            <div class="col-md-4">
                                <label class="form-label fw-bold">Type</label>
                                <select class="form-select" id="editFacilityType">
                                    <option value="PHC">PHC</option>
                                    <option value="Sub-Center">Sub-Center</option>
                                    <option value="CHC">CHC</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-bold">In-Charge Name</label>
                                <input type="text" class="form-control" id="editFacilityInCharge">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-bold">Phone</label>
                                <input type="tel" class="form-control" id="editFacilityPhone" pattern="[0-9]{10}">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-bold">Email (login)</label>
                                <input type="email" class="form-control" id="editFacilityEmail" readonly>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-bold">Beds</label>
                                <input type="number" class="form-control" id="editFacilityBeds" min="0">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-bold">Village/Location</label>
                                <input type="text" class="form-control" id="editFacilityVillage">
                            </div>
                            <div class="col-md-6 d-flex align-items-end">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="editFacilityActive">
                                    <label class="form-check-label fw-bold" for="editFacilityActive">Operational / Active</label>
                                </div>
                            </div>
                            <div class="col-12">
                                <label class="form-label fw-bold">Address</label>
                                <textarea class="form-control" id="editFacilityAddress" rows="2"></textarea>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="submitEditFacility">
                        <i class="fas fa-save me-1"></i>Save Changes
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Worker Modal -->
    <div class="modal fade" id="editWorkerModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title"><i class="fas fa-edit me-2"></i>Edit Health Worker</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editWorkerForm">
                        <input type="hidden" id="editWorkerUid">
                        <div class="mb-3">
                            <label class="form-label fw-bold">Full Name</label>
                            <input type="text" class="form-control" id="editWorkerName" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-bold">Mobile Number</label>
                            <input type="tel" class="form-control" id="editWorkerMobile" pattern="[0-9]{10}">
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-bold">Worker Type</label>
                            <select class="form-select" id="editWorkerType">
                                <option value="ASHA">ASHA Worker</option>
                                <option value="ANM">ANM</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-bold">Status</label>
                            <select class="form-select" id="editWorkerStatus">
                                <option value="active">Active</option>
                                <option value="pending">Pending/Inactive</option>
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="submitEditWorker">
                        <i class="fas fa-save me-1"></i>Save Changes
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Create Task Modal -->
    <div class="modal fade" id="createTaskModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title"><i class="fas fa-plus-circle me-2"></i>Create New Task</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="createTaskForm">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label fw-bold">Task Type</label>
                                <select class="form-select" id="newTaskType" required>
                                    <option value="">Select task type...</option>
                                    <optgroup label="Manual Tasks">
                                        <option value="new_survey">Add New Survey</option>
                                        <option value="phc_activity">PHC Level Activity</option>
                                        <option value="medicine_delivery">Schedule Medicine Delivery</option>
                                        <option value="asha_visit_cycle">Assign ASHA Visit Cycle</option>
                                    </optgroup>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-bold">Priority</label>
                                <select class="form-select" id="newTaskPriority" required>
                                    <option value="high">High</option>
                                    <option value="medium" selected>Medium</option>
                                    <option value="routine">Routine</option>
                                </select>
                            </div>
                            <div class="col-12">
                                <label class="form-label fw-bold">Task Title</label>
                                <input type="text" class="form-control" id="newTaskTitle" placeholder="Enter task title" required>
                            </div>
                            <div class="col-12">
                                <label class="form-label fw-bold">Description</label>
                                <textarea class="form-control" id="newTaskDescription" rows="2" placeholder="Task details..."></textarea>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-bold">Assign To</label>
                                <select class="form-select" id="newTaskWorker" required>
                                    <option value="">Select worker...</option>
                                    <!-- Workers will be populated dynamically -->
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-bold">Village</label>
                                <select class="form-select" id="newTaskVillage" required>
                                    <option value="Rampur">Rampur</option>
                                    <option value="Shivnagar">Shivnagar</option>
                                    <option value="Krishnapuram">Krishnapuram</option>
                                    <option value="Ganeshpur">Ganeshpur</option>
                                    <option value="Sitapur">Sitapur</option>
                                    <option value="Radhanagar">Radhanagar</option>
                                    <option value="Govindpur">Govindpur</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-bold">Deadline Date</label>
                                <input type="date" class="form-control" id="newTaskDeadline" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-bold">Deadline Time</label>
                                <input type="time" class="form-control" id="newTaskTime" value="17:00">
                            </div>
                            <div class="col-12">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="newTaskReminder" checked>
                                    <label class="form-check-label" for="newTaskReminder">
                                        Send SMS reminder 1 day before deadline
                                    </label>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" id="submitNewTask">
                        <i class="fas fa-check me-1"></i>Create Task
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Worker Detail Modal -->
    <div class="modal fade" id="workerDetailModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title"><i class="fas fa-user-circle me-2"></i><span id="workerModalName">Worker Profile</span></h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row g-4">
                        <!-- Left Column: Profile & Performance -->
                        <div class="col-lg-4">
                            <div class="text-center mb-4">
                                <div class="rounded-circle mx-auto d-flex align-items-center justify-content-center" 
                                     style="width:80px;height:80px;background:linear-gradient(135deg,#dc3545,#ff6b6b);color:white;font-size:2rem;">
                                    <i class="fas fa-user"></i>
                                </div>
                                <h5 class="mt-2 mb-0" id="workerDetailName">--</h5>
                                <span class="badge bg-info" id="workerDetailRole">--</span>
                            </div>
                            <div class="card border-0 shadow-sm mb-3">
                                <div class="card-body text-center">
                                    <h4 class="mb-0" id="workerPerfScore">--</h4>
                                    <small class="text-muted">Performance Score</small>
                                    <div class="progress mt-2" style="height:8px;">
                                        <div class="progress-bar bg-success" id="workerPerfBar" style="width:0%"></div>
                                    </div>
                                </div>
                            </div>
                            <ul class="list-group list-group-flush small">
                                <li class="list-group-item d-flex justify-content-between"><span>Phone:</span><strong id="workerPhone">--</strong></li>
                                <li class="list-group-item d-flex justify-content-between"><span>Area:</span><strong id="workerArea">--</strong></li>
                                <li class="list-group-item d-flex justify-content-between"><span>Pending Visits:</span><strong id="workerPending">--</strong></li>
                                <li class="list-group-item d-flex justify-content-between"><span>Coverage:</span><strong id="workerCoverage">--%</strong></li>
                                <li class="list-group-item d-flex justify-content-between"><span>Training Completed:</span><strong id="workerTraining">--/6</strong></li>
                            </ul>
                        </div>
                        <!-- Right Column: Tabs -->
                        <div class="col-lg-8">
                            <ul class="nav nav-tabs" id="workerTabs">
                                <li class="nav-item"><a class="nav-link active" data-bs-toggle="tab" href="#tabTasks">Weekly Tasks</a></li>
                                <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#tabTraining">Training</a></li>
                                <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#tabMissed">Missed HH</a></li>
                                <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#tabAI">AI Insights</a></li>
                            </ul>
                            <div class="tab-content pt-3">
                                <div class="tab-pane fade show active" id="tabTasks">
                                    <div id="workerTasksList" style="max-height:300px;overflow-y:auto;">
                                        <!-- Tasks will be rendered here -->
                                    </div>
                                </div>
                                <div class="tab-pane fade" id="tabTraining">
                                    <div id="workerTrainingList">
                                        <!-- Training modules will be rendered here -->
                                    </div>
                                </div>
                                <div class="tab-pane fade" id="tabMissed">
                                    <div id="workerMissedList" style="max-height:300px;overflow-y:auto;">
                                        <!-- Missed households will be rendered here -->
                                    </div>
                                </div>
                                <div class="tab-pane fade" id="tabAI">
                                    <div id="workerAIList">
                                        <!-- AI recommendations will be rendered here -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-outline-secondary"><i class="fas fa-map-marker-alt me-1"></i>View GPS Trail</button>
                    <button class="btn btn-outline-primary"><i class="fas fa-phone me-1"></i>Call Worker</button>
                    <button class="btn btn-danger"><i class="fas fa-tasks me-1"></i>Assign Task</button>
                </div>
            </div>
        </div>
    </div>

    <!-- SECURITY CENTER PAGE -->
    <div id="security-center-page" class="content-page">
        <!-- Security KPIs -->
        <div class="card border-0 shadow-sm mb-4">
            <div class="card-header bg-white border-0 py-3 d-flex justify-content-between align-items-center">
                <h6 class="mb-0 fw-bold"><i class="fas fa-shield-alt me-2 text-danger"></i>Security Overview</h6>
                <button class="btn btn-sm btn-outline-danger" id="refreshSecurityBtn">
                    <i class="fas fa-sync-alt me-1"></i>Refresh
                </button>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-2">
                        <div class="stat-card text-center p-3 border rounded">
                            <div class="fs-3 fw-bold text-primary" id="secLogins24h">0</div>
                            <div class="small text-muted">Logins (24h)</div>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="stat-card text-center p-3 border rounded">
                            <div class="fs-3 fw-bold text-danger" id="secFailed24h">0</div>
                            <div class="small text-muted">Failed (24h)</div>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="stat-card text-center p-3 border rounded">
                            <div class="fs-3 fw-bold text-success" id="secActiveSessions">0</div>
                            <div class="small text-muted">Active Sessions</div>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="stat-card text-center p-3 border rounded">
                            <div class="fs-3 fw-bold text-warning" id="secBlockedIPs">0</div>
                            <div class="small text-muted">Blocked IPs</div>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="stat-card text-center p-3 border rounded">
                            <div class="fs-3 fw-bold text-info" id="secApiCalls1h">0</div>
                            <div class="small text-muted">API Calls (1h)</div>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="stat-card text-center p-3 border rounded">
                            <div class="fs-3 fw-bold text-secondary" id="secUniqueDevices">0</div>
                            <div class="small text-muted">Devices (7d)</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Login Logs Table -->
        <div class="card border-0 shadow-sm mb-4">
            <div class="card-header bg-white border-0 py-3">
                <h6 class="mb-0 fw-bold"><i class="fas fa-sign-in-alt me-2 text-primary"></i>Login History (Last 7 Days)</h6>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>Time</th>
                                <th>User</th>
                                <th>Status</th>
                                <th>IP Address</th>
                                <th>Device</th>
                                <th>Reason</th>
                            </tr>
                        </thead>
                        <tbody id="loginLogsTable">
                            <tr><td colspan="6" class="text-center text-muted py-4">Loading...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Active Sessions -->
        <div class="card border-0 shadow-sm mb-4">
            <div class="card-header bg-white border-0 py-3">
                <h6 class="mb-0 fw-bold"><i class="fas fa-users me-2 text-success"></i>Active Sessions</h6>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>User</th>
                                <th>Role</th>
                                <th>Status</th>
                                <th>IP Address</th>
                                <th>Device</th>
                                <th>Last Activity</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="activeSessionsTable">
                            <tr><td colspan="7" class="text-center text-muted py-4">Loading...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Failed Login Attempts -->
        <div class="card border-0 shadow-sm mb-4">
            <div class="card-header bg-white border-0 py-3">
                <h6 class="mb-0 fw-bold"><i class="fas fa-exclamation-triangle me-2 text-danger"></i>Failed Login Attempts</h6>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>Time</th>
                                <th>Email</th>
                                <th>IP Address</th>
                                <th>Reason</th>
                                <th>Status</th>
                                <th>Blocked Until</th>
                            </tr>
                        </thead>
                        <tbody id="failedAttemptsTable">
                            <tr><td colspan="6" class="text-center text-muted py-4">Loading...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <script>
        // ==================== GLOBAL VARIABLES ====================
        let geoHealthMap = null;
        let villageMarkers = [];
        let geoHealthData = null;
        let activeLayers = {
            maternal: true,
            tb: true,
            fever: true,
            immunization: true,
            waterborne: true
        };

        // ==================== PAGE NAVIGATION ====================
        function showPage(pageId) {
            // Hide all pages
            document.querySelectorAll('.content-page').forEach(page => {
                page.classList.remove('active');
            });
            // Show selected page
            const targetPage = document.getElementById(`${pageId}-page`);
            if (targetPage) {
                targetPage.classList.add('active');
            }
            // Update nav links
            document.querySelectorAll('.nav-link[data-page]').forEach(link => {
                link.classList.remove('active');
            });
            document.querySelector(`.nav-link[data-page="${pageId}"]`)?.classList.add('active');
            
            // Initialize map when geo-health page is shown
            if (pageId === 'geo-health' && !geoHealthMap) {
                setTimeout(initGeoHealthMap, 100);
            }
            
            // Load admin team when page is shown
            if (pageId === 'admin-team') {
                setTimeout(loadAdminTeam, 100);
            }
            
            // Load security center when page is shown
            if (pageId === 'security-center') {
                setTimeout(loadSecurityCenter, 100);
            }
        }

        // Navigation click handlers
        document.querySelectorAll('.nav-link[data-page]').forEach(link => {
            link.addEventListener('click', function(e) {
                e.preventDefault();
                showPage(this.dataset.page);
            });
        });

        // ==================== SIDEBAR TOGGLE ====================
        const sidebar = document.querySelector('.sidebar');
        const sidebarToggle = document.getElementById('sidebarToggle');
        
        // Load saved state from localStorage
        if (localStorage.getItem('sidebarCollapsed') === 'true') {
            sidebar.classList.add('collapsed');
        }
        
        sidebarToggle?.addEventListener('click', function() {
            sidebar.classList.toggle('collapsed');
            // Save state to localStorage
            localStorage.setItem('sidebarCollapsed', sidebar.classList.contains('collapsed'));
        });

        // ==================== DATE & DASHBOARD ====================
        function updateCurrentDate() {
            const now = new Date();
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            document.getElementById('currentDate').textContent = now.toLocaleDateString('en-IN', options);
        }
        
        async function loadDashboardStats() {
            try {
                const response = await fetch('/api/block-admin/dashboard-stats');
                const data = await response.json();
                
                if (data.success) {
                    const stats = data.stats;
                    
                    // KPI 1: Population Coverage
                    document.getElementById('kpiPopulation').textContent = stats.population_coverage.value + '%';
                    document.getElementById('kpiPopEnrolled').textContent = stats.population_coverage.enrolled.toLocaleString();
                    document.getElementById('kpiPopEligible').textContent = stats.population_coverage.eligible.toLocaleString();
                    document.getElementById('kpiPopProgress').style.width = stats.population_coverage.value + '%';
                    const trend = stats.population_coverage.trend;
                    document.getElementById('kpiPopTrend').innerHTML = `<i class="fas fa-arrow-${trend >= 0 ? 'up' : 'down'} me-1"></i>${trend >= 0 ? '+' : ''}${trend}%`;
                    
                    // KPI 2: Active Field Teams
                    document.getElementById('kpiFieldTeams').textContent = stats.active_field_teams.value;
                    document.getElementById('kpiFieldTeamsTotal').textContent = stats.active_field_teams.total;
                    document.getElementById('kpiAshaOnline').textContent = stats.active_field_teams.asha_online;
                    document.getElementById('kpiAnmOnline').textContent = stats.active_field_teams.anm_online;
                    document.getElementById('kpiLastSync').textContent = stats.active_field_teams.last_sync;
                    
                    // KPI 3: High-Risk Patients
                    document.getElementById('kpiHighRisk').textContent = stats.high_risk_patients.value;
                    document.getElementById('kpiHypertension').textContent = stats.high_risk_patients.hypertension;
                    document.getElementById('kpiDiabetes').textContent = stats.high_risk_patients.diabetes;
                    document.getElementById('kpiPregnancy').textContent = stats.high_risk_patients.pregnancy_risk;
                    document.getElementById('kpiTB').textContent = stats.high_risk_patients.tb_suspects;
                    document.getElementById('kpiNewToday').textContent = stats.high_risk_patients.new_today;
                    
                    // KPI 4: Supply Stock Index
                    document.getElementById('kpiSupplyIndex').textContent = stats.supply_stock_index.value + '%';
                    document.getElementById('kpiVaccines').textContent = stats.supply_stock_index.vaccines + '%';
                    document.getElementById('kpiMedicines').textContent = stats.supply_stock_index.medicines + '%';
                    document.getElementById('kpiTestkits').textContent = stats.supply_stock_index.testkits + '%';
                    document.getElementById('kpiCritical').textContent = stats.supply_stock_index.critical_items;
                    
                    // KPI 5: Immunization Defaulters
                    document.getElementById('kpiDefaulters').textContent = stats.immunization_defaulters.value;
                    document.getElementById('kpiBCG').textContent = stats.immunization_defaulters.bcg_pending;
                    document.getElementById('kpiOPV').textContent = stats.immunization_defaulters.opv_pending;
                    document.getElementById('kpiDPT').textContent = stats.immunization_defaulters.dpt_pending;
                    document.getElementById('kpiMeasles').textContent = stats.immunization_defaulters.measles_pending;
                    document.getElementById('kpiOverdue').textContent = stats.immunization_defaulters.overdue_7days;
                    
                    // KPI 6: Emergency Alerts
                    document.getElementById('kpiEmergency').textContent = stats.emergency_alerts.value;
                    document.getElementById('kpiFalls').textContent = stats.emergency_alerts.falls;
                    document.getElementById('kpiSevere').textContent = stats.emergency_alerts.severe_symptoms;
                    document.getElementById('kpiMaternal').textContent = stats.emergency_alerts.maternal_alerts;
                    document.getElementById('kpiResolved').textContent = stats.emergency_alerts.resolved_today;
                    document.getElementById('kpiPending').textContent = stats.emergency_alerts.pending;
                    
                    // Total Registered Clients
                    const kpiTotalClients = document.getElementById('kpiTotalClients');
                    if (kpiTotalClients) {
                        kpiTotalClients.textContent = stats.total_clients || 0;
                    }
                    
                    document.getElementById('lastUpdated').textContent = 'Last updated: ' + new Date().toLocaleTimeString();
                }
            } catch (error) {
                console.error('Error loading dashboard stats:', error);
            }
        }

        // ==================== GEO-HEALTH MAP ====================
        function initGeoHealthMap() {
            if (geoHealthMap) return;
            
            // Initialize with India center as default - will be updated by API if data available
            const defaultLat = 20.5937;
            const defaultLng = 78.9629;
            const defaultZoom = 5;
            
            geoHealthMap = L.map('geoHealthMap').setView([defaultLat, defaultLng], defaultZoom);
            
            // Add OpenStreetMap tiles
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors',
                maxZoom: 18
            }).addTo(geoHealthMap);
            
            // Load village data
            loadGeoHealthData();
        }

        async function loadGeoHealthData() {
            try {
                const response = await fetch('/api/block-admin/geo-health-data');
                const data = await response.json();
                
                if (data.success) {
                    geoHealthData = data;
                    
                    // Update summary stats (use defaults if no data)
                    document.getElementById('mapTotalVillages').textContent = data.summary?.total_villages || 0;
                    document.getElementById('mapHighRisk').textContent = data.summary?.high_risk_villages || 0;
                    document.getElementById('mapModerateRisk').textContent = data.summary?.moderate_risk_villages || 0;
                    document.getElementById('mapStableVillages').textContent = data.summary?.stable_villages || 0;
                    document.getElementById('mapAIAlerts').textContent = (data.summary?.fever_hotspots || 0) + (data.summary?.maternal_clusters || 0);
                    
                    // Try to center map based on available data
                    if (geoHealthMap) {
                        // Priority 1: Use block center coordinates if available
                        if (data.center?.lat && data.center?.lng) {
                            geoHealthMap.setView([data.center.lat, data.center.lng], data.zoom || 12);
                        }
                        // Priority 2: Auto-center on first village with coordinates
                        else if (data.villages?.length > 0) {
                            const firstVillage = data.villages.find(v => v.lat && v.lng);
                            if (firstVillage) {
                                geoHealthMap.setView([firstVillage.lat, firstVillage.lng], 12);
                            }
                        }
                        // Otherwise keep the default India center
                    }
                    
                    // Render village markers if available
                    if (data.villages?.length > 0) {
                        renderVillageMarkers(data.villages);
                    }
                } else {
                    // API returned error but we still show map with defaults
                    document.getElementById('mapTotalVillages').textContent = 0;
                    document.getElementById('mapHighRisk').textContent = 0;
                    document.getElementById('mapModerateRisk').textContent = 0;
                    document.getElementById('mapStableVillages').textContent = 0;
                    document.getElementById('mapAIAlerts').textContent = 0;
                }
            } catch (error) {
                console.error('Error loading geo-health data:', error);
                // Show zeros on error but don't break the map
                document.getElementById('mapTotalVillages').textContent = 0;
                document.getElementById('mapHighRisk').textContent = 0;
                document.getElementById('mapModerateRisk').textContent = 0;
                document.getElementById('mapStableVillages').textContent = 0;
                document.getElementById('mapAIAlerts').textContent = 0;
            }
        }

        function renderVillageMarkers(villages) {
            // Clear existing markers
            villageMarkers.forEach(m => geoHealthMap.removeLayer(m));
            villageMarkers = [];
            
            villages.forEach(village => {
                // Determine marker color based on risk level
                const colors = {
                    high: '#dc3545',
                    moderate: '#fd7e14',
                    stable: '#28a745'
                };
                const color = colors[village.risk_level] || '#6c757d';
                
                // Create custom icon
                const icon = L.divIcon({
                    className: 'custom-marker',
                    html: `<div style="
                        width: 24px; height: 24px; border-radius: 50%;
                        background: ${color}; border: 3px solid white;
                        box-shadow: 0 2px 6px rgba(0,0,0,0.3);
                        display: flex; align-items: center; justify-content: center;
                        font-size: 10px; color: white; font-weight: bold;
                    ">${village.risk_level === 'high' ? '!' : ''}</div>`,
                    iconSize: [24, 24],
                    iconAnchor: [12, 12]
                });
                
                // Create marker
                const marker = L.marker([village.lat, village.lng], { icon: icon });
                
                // Build popup content
                const d = village.details;
                const supplyClass = d.supply_status === 'Critical' ? 'text-danger fw-bold' : 
                                   d.supply_status === 'Low Stock' ? 'text-warning' : 'text-success';
                
                // Indicator badges
                let indicators = '';
                if (village.indicators.maternal_risk) indicators += '<span class="badge bg-danger me-1">Maternal</span>';
                if (village.indicators.tb_cluster) indicators += '<span class="badge me-1" style="background:#9c27b0;">TB</span>';
                if (village.indicators.fever_rise) indicators += '<span class="badge bg-warning text-dark me-1">Fever AI</span>';
                if (village.indicators.immunization_gap) indicators += '<span class="badge bg-info me-1">Immun.</span>';
                if (village.indicators.waterborne_risk) indicators += '<span class="badge bg-primary me-1">Water</span>';
                
                const popupContent = `
                    <div class="village-popup">
                        <h6><i class="fas fa-map-marker-alt me-1"></i>${village.name}</h6>
                        <div class="mb-2">${indicators || '<span class="text-muted small">No active alerts</span>'}</div>
                        <div class="stat-row"><span class="stat-label">Registered Population</span><span class="stat-value">${d.population.toLocaleString()}</span></div>
                        <div class="stat-row"><span class="stat-label">High-Risk Individuals</span><span class="stat-value text-danger">${d.high_risk_count}</span></div>
                        <div class="stat-row"><span class="stat-label">Pending Tasks</span><span class="stat-value">${d.pending_tasks}</span></div>
                        <div class="stat-row"><span class="stat-label">Last Outreach Visit</span><span class="stat-value">${d.last_visit} <small class="text-muted">(${d.last_visit_days}d ago)</small></span></div>
                        <div class="stat-row"><span class="stat-label">Supply Status</span><span class="stat-value ${supplyClass}">${d.supply_status}</span></div>
                        <div class="stat-row"><span class="stat-label">Field Worker</span><span class="stat-value">${d.field_worker}</span></div>
                        <div class="mt-2 pt-2 border-top small text-muted">
                            <i class="fas fa-home me-1"></i>${d.households} households • 
                            <i class="fas fa-baby me-1"></i>${d.children_under_5} children • 
                            <i class="fas fa-user-md me-1"></i>${d.pregnant_women} pregnant
                        </div>
                    </div>
                `;
                
                marker.bindPopup(popupContent, { maxWidth: 320 });
                
                // Store indicator info for layer filtering
                marker.villageData = village;
                
                marker.addTo(geoHealthMap);
                villageMarkers.push(marker);
            });
        }

        // ==================== LAYER TOGGLES ====================
        document.querySelectorAll('.layer-toggle').forEach(btn => {
            btn.addEventListener('click', function() {
                const layer = this.dataset.layer;
                this.classList.toggle('active');
                activeLayers[layer] = this.classList.contains('active');
                
                // Update marker visibility based on active layers
                if (geoHealthData) {
                    filterVillagesByLayers();
                }
            });
        });

        function filterVillagesByLayers() {
            villageMarkers.forEach(marker => {
                const v = marker.villageData;
                let show = true;
                
                // Check if village has any active indicator
                const hasActiveIndicator = 
                    (activeLayers.maternal && v.indicators.maternal_risk) ||
                    (activeLayers.tb && v.indicators.tb_cluster) ||
                    (activeLayers.fever && v.indicators.fever_rise) ||
                    (activeLayers.immunization && v.indicators.immunization_gap) ||
                    (activeLayers.waterborne && v.indicators.waterborne_risk);
                
                // Always show villages, but highlight those with active indicators
                marker.setOpacity(hasActiveIndicator ? 1 : 0.4);
            });
        }

        // ==================== REFRESH HANDLERS ====================
        document.getElementById('refreshBtn').addEventListener('click', function() {
            const btn = this;
            btn.classList.add('spinning');
            btn.querySelector('i').classList.add('fa-spin');
            
            loadDashboardStats().finally(() => {
                setTimeout(() => {
                    btn.classList.remove('spinning');
                    btn.querySelector('i').classList.remove('fa-spin');
                }, 500);
            });
        });

        document.getElementById('refreshMapBtn')?.addEventListener('click', function() {
            this.querySelector('i').classList.add('fa-spin');
            loadGeoHealthData().finally(() => {
                setTimeout(() => {
                    this.querySelector('i').classList.remove('fa-spin');
                }, 500);
            });
        });

        // ==================== AI ALERTS COMMAND CENTER ====================
        let aiAlertsData = null;
        let currentAlertFilter = { type: 'all', severity: 'all' };

        async function loadAIAlerts() {
            try {
                const response = await fetch('/api/block-admin/ai-alerts');
                const data = await response.json();
                
                if (data.success) {
                    aiAlertsData = data;
                    renderAIEngines(data.engines || []);
                    renderAlertTypeTabs(data.alert_types || []);
                    renderAlerts(data.alerts || []);
                    
                    document.getElementById('alertTotalCount').textContent = data.summary?.total || 0;
                    document.getElementById('alertCriticalCount').textContent = data.summary?.critical || 0;
                }
            } catch (error) {
                console.error('Error loading AI alerts:', error);
            }
        }

        function renderAIEngines(engines) {
            const container = document.getElementById('aiEnginesContainer');
            if (!container) return;
            
            if (!engines || engines.length === 0) {
                container.innerHTML = '<div class="col-12 text-center text-muted py-3">No AI engines configured</div>';
                return;
            }
            
            container.innerHTML = engines.map(engine => `
                <div class="col-lg col-md-4 col-sm-6">
                    <div class="card border-0 shadow-sm h-100">
                        <div class="card-body py-3">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <div class="rounded-circle d-flex align-items-center justify-content-center" 
                                     style="width:40px;height:40px;background:linear-gradient(135deg,#dc3545,#ff6b6b);color:white;">
                                    <i class="fas ${engine.icon}"></i>
                                </div>
                                <span class="badge ${engine.status === 'active' ? 'bg-success' : 'bg-secondary'}">
                                    <i class="fas fa-circle" style="font-size:6px;"></i> ${engine.status}
                                </span>
                            </div>
                            <h6 class="fw-bold mb-1" style="font-size:0.85rem;">${engine.name}</h6>
                            <p class="text-muted mb-2" style="font-size:0.7rem;">${engine.description || ''}</p>
                            <div style="font-size:0.75rem;">
                                <span><i class="fas fa-bell ${engine.alerts_count > 0 ? 'text-danger' : 'text-muted'} me-1"></i>${engine.alerts_count} alerts</span>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function renderAlertTypeTabs(types) {
            const container = document.getElementById('alertTypeTabs');
            if (!container) return;
            
            // Keep the "All" button and add type buttons
            const allBtn = container.querySelector('[data-type="all"]');
            
            // Clear existing type buttons except "All"
            container.querySelectorAll('button:not([data-type="all"])').forEach(b => b.remove());
            
            if (types && types.length > 0) {
                types.forEach(type => {
                    const btn = document.createElement('button');
                    btn.className = 'btn btn-sm btn-outline-secondary';
                    btn.dataset.type = type.id;
                    btn.innerHTML = `<i class="fas ${type.icon} me-1"></i>${type.name} <span class="badge bg-secondary ms-1">${type.count}</span>`;
                    container.appendChild(btn);
                });
            }
            
            // Add click handlers
            container.querySelectorAll('button').forEach(btn => {
                btn.addEventListener('click', function() {
                    container.querySelectorAll('button').forEach(b => b.classList.remove('active', 'btn-danger'));
                    container.querySelectorAll('button').forEach(b => b.classList.add('btn-outline-secondary'));
                    this.classList.remove('btn-outline-secondary');
                    this.classList.add('active', 'btn-danger');
                    currentAlertFilter.type = this.dataset.type;
                    applyAlertFilters();
                });
            });
        }

        function applyAlertFilters() {
            if (!aiAlertsData) return;
            let filtered = aiAlertsData.alerts;
            
            if (currentAlertFilter.type !== 'all') {
                filtered = filtered.filter(a => a.type === currentAlertFilter.type);
            }
            if (currentAlertFilter.severity !== 'all') {
                filtered = filtered.filter(a => a.severity === currentAlertFilter.severity);
            }
            renderAlerts(filtered);
        }

        function renderAlerts(alerts) {
            const container = document.getElementById('alertsListContainer');
            if (!container) return;
            
            if (!alerts || alerts.length === 0) {
                container.innerHTML = '<div class="col-12 text-center py-5"><i class="fas fa-check-circle text-success fa-3x mb-3"></i><h5>No active alerts</h5><p class="text-muted">All systems healthy!</p></div>';
                return;
            }
            
            const typeIcons = {
                'coverage': 'fa-map-marked-alt',
                'supply': 'fa-boxes',
                'health_risk': 'fa-heartbeat',
                'worker': 'fa-user-clock'
            };
            
            const typeColors = {
                'coverage': '#17a2b8',
                'supply': '#fd7e14',
                'health_risk': '#dc3545',
                'worker': '#6f42c1'
            };
            
            const severityColors = {
                'critical': 'bg-danger',
                'high': 'bg-warning text-dark',
                'medium': 'bg-info'
            };
            
            container.innerHTML = alerts.map(alert => `
                <div class="col-lg-6 col-xl-4">
                    <div class="card border-0 shadow-sm h-100">
                        <div style="height:4px;background:${alert.severity === 'critical' ? '#dc3545' : alert.severity === 'high' ? '#ffc107' : '#17a2b8'};"></div>
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <div class="d-flex align-items-center gap-2">
                                    <div class="rounded-circle d-flex align-items-center justify-content-center" 
                                         style="width:32px;height:32px;background:${typeColors[alert.type] || '#6c757d'};color:white;">
                                        <i class="fas ${typeIcons[alert.type] || 'fa-bell'}" style="font-size:0.85rem;"></i>
                                    </div>
                                    <span class="badge ${severityColors[alert.severity] || 'bg-secondary'}">${alert.severity.toUpperCase()}</span>
                                </div>
                                <small class="text-muted">${alert.created_at}</small>
                            </div>
                            
                            <h6 class="fw-bold mb-1" style="font-size:0.9rem;">${alert.title}</h6>
                            <p class="text-muted mb-2" style="font-size:0.8rem;">${alert.description}</p>
                            
                            <div class="mb-2">
                                <small class="text-muted"><i class="fas fa-map-marker-alt text-danger me-1"></i>${alert.village}</small>
                                <span class="badge bg-light text-dark ms-2"><i class="fas fa-users me-1"></i>${alert.affected_count} affected</span>
                            </div>
                            
                            <div class="p-2 bg-light rounded mb-2">
                                <small class="fw-bold text-danger"><i class="fas fa-exclamation-circle me-1"></i>Recommended:</small>
                                <p class="mb-0" style="font-size:0.8rem;">${alert.recommended_action}</p>
                            </div>
                            
                            <div class="d-flex gap-2 mt-3 pt-2 border-top">
                                <button class="btn btn-sm btn-outline-danger flex-fill" onclick="acknowledgeAlert(${alert.id})">
                                    <i class="fas fa-check me-1"></i>Acknowledge
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
        }
        
        function acknowledgeAlert(alertId) {
            // Mark alert as acknowledged (can be extended with API call)
            alert('Alert #' + alertId + ' acknowledged!');
        }

        // Severity filter buttons
        document.querySelectorAll('[data-severity]').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('[data-severity]').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                currentAlertFilter.severity = this.dataset.severity;
                applyAlertFilters();
            });
        });

        // Refresh alerts button
        document.getElementById('refreshAlertsBtn')?.addEventListener('click', function() {
            this.querySelector('i').classList.add('fa-spin');
            loadAIAlerts().finally(() => {
                setTimeout(() => {
                    this.querySelector('i').classList.remove('fa-spin');
                }, 500);
            });
        });

        // ==================== TASK ENGINE ====================
        let taskEngineData = null;
        let currentTaskFilter = { priority: 'all', status: 'all', source: 'all' };

        async function loadTasks() {
            try {
                const response = await fetch('/api/block-admin/task-engine');
                const data = await response.json();
                
                if (data.success) {
                    taskEngineData = data;
                    updateTaskSummary(data.stats);
                    renderTasks(data.tasks || []);
                    populateWorkerDropdown(data.workers || []);
                }
            } catch (error) {
                console.error('Error loading tasks:', error);
            }
        }

        function updateTaskSummary(stats) {
            if (!stats) return;
            document.getElementById('taskTotalCount').textContent = stats.total || 0;
            document.getElementById('taskOverdueCount').textContent = stats.overdue || 0;
            document.getElementById('taskPendingCount').textContent = stats.pending || 0;
            document.getElementById('taskInProgressCount').textContent = stats.in_progress || 0;
            document.getElementById('taskCompletedCount').textContent = stats.completed || 0;
        }

        function populateWorkerDropdown(workers) {
            const select = document.getElementById('newTaskWorker');
            if (!select) return;
            select.innerHTML = '<option value="">Select worker...</option>';
            workers.forEach(w => {
                select.innerHTML += `<option value="${w.id}">${w.name} (${w.type})</option>`;
            });
        }

        function applyTaskFilters() {
            if (!taskEngineData || !taskEngineData.tasks) return;
            let filtered = taskEngineData.tasks;
            
            if (currentTaskFilter.priority !== 'all') {
                filtered = filtered.filter(t => t.priority === currentTaskFilter.priority);
            }
            if (currentTaskFilter.status !== 'all') {
                filtered = filtered.filter(t => t.status === currentTaskFilter.status);
            }
            if (currentTaskFilter.source !== 'all') {
                if (currentTaskFilter.source === 'auto') {
                    filtered = filtered.filter(t => t.is_auto);
                } else {
                    filtered = filtered.filter(t => !t.is_auto);
                }
            }
            renderTasks(filtered);
        }

        function renderTasks(tasks) {
            const container = document.getElementById('tasksListContainer');
            if (!container) return;
            
            if (!tasks || tasks.length === 0) {
                container.innerHTML = `
                    <div class="col-12 text-center py-5">
                        <i class="fas fa-tasks text-muted fa-3x mb-3"></i>
                        <h5 class="text-muted">No Tasks Yet</h5>
                        <p class="text-muted mb-3">Tasks will appear here once created or generated by AI alerts.</p>
                        <button class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#createTaskModal">
                            <i class="fas fa-plus me-2"></i>Create First Task
                        </button>
                    </div>`;
                return;
            }
            
            const priorityColors = {
                'critical': 'bg-danger',
                'high': 'bg-warning text-dark',
                'medium': 'bg-info',
                'routine': 'bg-secondary'
            };
            
            const statusColors = {
                'overdue': 'bg-danger',
                'pending': 'bg-warning text-dark',
                'in_progress': 'bg-primary',
                'completed': 'bg-success'
            };
            
            container.innerHTML = tasks.map(task => `
                <div class="col-lg-6 col-xl-4">
                    <div class="card border-0 shadow-sm h-100">
                        <div style="height:4px;background:${task.priority === 'critical' ? '#dc3545' : task.priority === 'high' ? '#ffc107' : '#17a2b8'};"></div>
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <span class="badge ${priorityColors[task.priority] || 'bg-secondary'}">${task.priority || 'Normal'}</span>
                                <span class="badge ${statusColors[task.status] || 'bg-secondary'}">${(task.status || 'pending').replace('_', ' ')}</span>
                            </div>
                            
                            <h6 class="fw-bold mb-1">${task.title || 'Untitled Task'}</h6>
                            <p class="text-muted small mb-2">${task.description || 'No description'}</p>
                            
                            <div class="small mb-2">
                                <i class="fas fa-user text-muted me-1"></i>${task.assigned_to || 'Unassigned'}
                                ${task.village ? `<span class="ms-2"><i class="fas fa-map-marker-alt text-muted me-1"></i>${task.village}</span>` : ''}
                            </div>
                            
                            ${task.deadline ? `
                            <div class="small text-muted mb-2">
                                <i class="fas fa-clock me-1"></i>Due: ${task.deadline}
                            </div>` : ''}
                            
                            <div class="d-flex gap-2 pt-2 border-top">
                                <button class="btn btn-sm btn-outline-success flex-fill" onclick="completeTask(${task.id})">
                                    <i class="fas fa-check me-1"></i>Complete
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
        }
        
        function completeTask(taskId) {
            // TODO: Implement task completion API
            alert('Task #' + taskId + ' marked as complete!');
        }

        // Task filter handlers
        document.getElementById('taskPriorityFilter')?.querySelectorAll('button').forEach(btn => {
            btn.addEventListener('click', function() {
                this.parentElement.querySelectorAll('button').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                currentTaskFilter.priority = this.dataset.priority;
                applyTaskFilters();
            });
        });

        document.getElementById('taskStatusFilter')?.querySelectorAll('button').forEach(btn => {
            btn.addEventListener('click', function() {
                this.parentElement.querySelectorAll('button').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                currentTaskFilter.status = this.dataset.status;
                applyTaskFilters();
            });
        });

        document.getElementById('taskSourceFilter')?.querySelectorAll('button').forEach(btn => {
            btn.addEventListener('click', function() {
                this.parentElement.querySelectorAll('button').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                currentTaskFilter.source = this.dataset.source;
                applyTaskFilters();
            });
        });

        document.getElementById('refreshTasksBtn')?.addEventListener('click', function() {
            this.querySelector('i').classList.add('fa-spin');
            loadTasks().finally(() => {
                setTimeout(() => {
                    this.querySelector('i').classList.remove('fa-spin');
                }, 500);
            });
        });

        // Create task submit
        document.getElementById('submitNewTask')?.addEventListener('click', function() {
            const form = document.getElementById('createTaskForm');
            if (form.checkValidity()) {
                // In production, this would POST to server
                alert('Task created successfully! (Demo mode)');
                bootstrap.Modal.getInstance(document.getElementById('createTaskModal')).hide();
                form.reset();
            } else {
                form.reportValidity();
            }
        });

        // ==================== PAGE NAVIGATION UPDATE ====================
        function showPage(pageId) {
            document.querySelectorAll('.content-page').forEach(page => page.classList.remove('active'));
            document.getElementById(`${pageId}-page`)?.classList.add('active');
            
            document.querySelectorAll('.nav-link[data-page]').forEach(link => link.classList.remove('active'));
            document.querySelector(`.nav-link[data-page="${pageId}"]`)?.classList.add('active');
            
            // Load data when switching pages
            if (pageId === 'ai-alerts' && !aiAlertsData) {
                loadAIAlerts();
            }
            if (pageId === 'task-engine' && !taskEngineData) {
                loadTasks();
            }
            if (pageId === 'workforce' && !workforceData) {
                loadWorkforce();
            }
            if (pageId === 'supplies' && !supplyChainData) {
                loadSupplyChain();
            }
            if (pageId === 'outreach' && !outreachData) {
                loadOutreach();
            }
            if (pageId === 'performance' && !performanceData) {
                loadPerformance();
            }
            if (pageId === 'phc-compare' && !phcCompareData) {
                loadPhcComparison();
            }
            if (pageId === 'communication' && !communicationData) {
                loadCommunication();
            }
            if (pageId === 'emergency-response' && !emergencyData) {
                loadEmergencyResponse();
            }
            if (pageId === 'reports' && !reportsData) {
                loadReportsCenter();
            }
            if (pageId === 'admin-controls' && !adminControlsData) {
                loadAdminControls();
            }
        }

        // ==================== WORKFORCE DASHBOARD ====================
        let workforceData = null;
        let currentWfFilter = 'all';

        async function loadWorkforce() {
            try {
                const response = await fetch('/api/block-admin/workforce-stats');
                const data = await response.json();
                
                if (data.success) {
                    workforceData = data;
                    updateWorkforceMetrics(data.stats);
                    renderWorkers(data.workers);
                }
            } catch (error) {
                console.error('Error loading workforce:', error);
            }
        }

        function updateWorkforceMetrics(m) {
            if (!m) return;
            document.getElementById('wfActiveToday').textContent = m.active_today || 0;
            document.getElementById('wfVisitsToday').textContent = m.visits_today || 0;
            document.getElementById('wfAvgCoverage').textContent = (m.avg_coverage || 0) + '%';
            document.getElementById('wfAvgVisitTime').textContent = (m.avg_visit_time || 25) + ' min';
            document.getElementById('wfMissed').textContent = m.missed_households || 0;
            document.getElementById('wfHighPerf').textContent = m.high_performers || 0;
            document.getElementById('wfNeedsSupport').textContent = m.needs_support || 0;
        }

        function renderWorkers(workers) {
            if (!workers || workers.length === 0) {
                const tbody = document.getElementById('workersTableBody');
                if (tbody) tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted py-4">No workers found</td></tr>';
                return;
            }
            
            let filtered = workers;
            if (currentWfFilter === 'high') {
                filtered = workers.filter(w => w.performance_level === 'high');
            } else if (currentWfFilter === 'needs_support') {
                filtered = workers.filter(w => w.performance_level === 'low');
            }
            
            const tbody = document.getElementById('workersTableBody');
            if (!tbody) return;
            
            tbody.innerHTML = filtered.map(w => {
                const statusBadge = w.status === 'online' 
                    ? '<span class="badge bg-success">🟢 Online</span>'
                    : '<span class="badge bg-secondary">⚫ Offline</span>';
                
                const perfBadge = w.performance_level === 'high' 
                    ? '<span class="badge bg-success">⭐ High</span>'
                    : w.performance_level === 'medium' 
                        ? '<span class="badge bg-warning text-dark">📊 Medium</span>'
                        : '<span class="badge bg-danger">⚠️ Low</span>';
                
                const coverageBar = `
                    <div class="progress" style="height:6px;width:80px;">
                        <div class="progress-bar ${w.coverage >= 70 ? 'bg-success' : w.coverage >= 40 ? 'bg-warning' : 'bg-danger'}" 
                             style="width:${w.coverage}%"></div>
                    </div>
                    <small>${w.coverage}%</small>
                `;
                
                return `
                <tr>
                    <td>
                        <div class="d-flex align-items-center">
                            <div class="rounded-circle bg-danger text-white d-flex align-items-center justify-content-center me-2" 
                                 style="width:36px;height:36px;font-size:0.8rem;">${w.name ? w.name.charAt(0) : '?'}</div>
                            <div>
                                <div class="fw-bold" style="font-size:0.85rem;">${w.name || 'Unknown'}</div>
                                <small class="text-muted">${w.worker_type || 'ASHA'} · ${w.village || 'N/A'}</small>
                            </div>
                        </div>
                    </td>
                    <td>${statusBadge}</td>
                    <td class="text-center"><span class="badge bg-primary">${w.visits_today || 0}</span></td>
                    <td>${coverageBar}</td>
                    <td>${perfBadge}</td>
                    <td><span class="badge ${(w.pending || 0) > 5 ? 'bg-danger' : 'bg-warning text-dark'}">${w.pending || 0}</span></td>
                    <td>
                        <button class="btn btn-sm btn-outline-danger" onclick="showWorkerDetail(${w.id})">
                            <i class="fas fa-eye"></i>
                        </button>
                    </td>
                </tr>
            `}).join('');
        }

        function showWorkerDetail(workerId) {
            const w = workforceData.workers.find(x => x.id === workerId);
            if (!w) return;
            
            // Populate modal
            document.getElementById('workerModalName').textContent = w.name;
            document.getElementById('workerDetailName').textContent = w.name;
            document.getElementById('workerDetailRole').textContent = w.role;
            document.getElementById('workerPerfScore').textContent = w.performance_score;
            document.getElementById('workerPerfBar').style.width = w.performance_score + '%';
            document.getElementById('workerPerfBar').className = `progress-bar ${w.performance_score >= 85 ? 'bg-success' : (w.performance_score >= 70 ? 'bg-warning' : 'bg-danger')}`;
            document.getElementById('workerPhone').textContent = w.phone;
            document.getElementById('workerArea').textContent = w.area.join(', ');
            document.getElementById('workerPending').textContent = w.pending_visits;
            document.getElementById('workerCoverage').textContent = w.coverage_percent + '%';
            document.getElementById('workerTraining').textContent = `${w.training_completion}/6`;
            
            // Weekly Tasks
            document.getElementById('workerTasksList').innerHTML = w.weekly_tasks.map(t => {
                const statusBadge = t.status === 'completed' ? 'bg-success' : (t.status === 'in_progress' ? 'bg-primary' : 'bg-secondary');
                return `<div class="d-flex justify-content-between align-items-center p-2 border-bottom">
                    <span style="font-size:0.85rem;">${t.task}</span>
                    <div><span class="badge ${statusBadge}">${t.status}</span><small class="ms-2 text-muted">${t.deadline}</small></div>
                </div>`;
            }).join('');
            
            // Training
            document.getElementById('workerTrainingList').innerHTML = w.training_status.map(t => {
                const icon = t.status === 'completed' ? 'fa-check-circle text-success' : (t.status === 'in_progress' ? 'fa-spinner text-primary' : 'fa-circle text-muted');
                return `<div class="d-flex justify-content-between align-items-center p-2 border-bottom">
                    <span><i class="fas ${icon} me-2"></i>${t.module}</span>
                    <small class="text-muted">${t.completed_date || t.status}</small>
                </div>`;
            }).join('');
            
            // Missed Households
            if (w.missed_households.length === 0) {
                document.getElementById('workerMissedList').innerHTML = '<div class="text-center text-success py-4"><i class="fas fa-check-circle fa-2x mb-2"></i><br>No missed households!</div>';
            } else {
                document.getElementById('workerMissedList').innerHTML = w.missed_households.map(m => `
                    <div class="d-flex justify-content-between align-items-center p-2 border-bottom">
                        <div><strong>${m.household}</strong> - ${m.member}</div>
                        <div><span class="badge bg-warning text-dark">${m.reason}</span><small class="ms-2 text-muted">${m.last_attempt}</small></div>
                    </div>`).join('');
            }
            
            // AI Recommendations
            if (w.ai_recommendations.length === 0) {
                document.getElementById('workerAIList').innerHTML = '<div class="text-center text-muted py-4"><i class="fas fa-robot fa-2x mb-2"></i><br>No AI insights at this time</div>';
            } else {
                document.getElementById('workerAIList').innerHTML = w.ai_recommendations.map(r => {
                    const colors = { warning: 'border-danger bg-danger-subtle', training: 'border-info bg-info-subtle', alert: 'border-warning bg-warning-subtle', positive: 'border-success bg-success-subtle' };
                    const icons = { warning: 'fa-exclamation-triangle text-danger', training: 'fa-graduation-cap text-info', alert: 'fa-bell text-warning', positive: 'fa-star text-success' };
                    return `<div class="p-3 mb-2 border rounded ${colors[r.type] || ''}">
                        <i class="fas ${icons[r.type] || 'fa-robot'} me-2"></i>${r.text}
                    </div>`;
                }).join('');
            }
            
            new bootstrap.Modal(document.getElementById('workerDetailModal')).show();
        }

        // Workforce filter
        document.getElementById('wfFilterGroup')?.querySelectorAll('button').forEach(btn => {
            btn.addEventListener('click', function() {
                this.parentElement.querySelectorAll('button').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                currentWfFilter = this.dataset.filter;
                if (workforceData) renderWorkers(workforceData.workers);
            });
        });

        document.getElementById('refreshWorkforceBtn')?.addEventListener('click', function() {
            this.querySelector('i').classList.add('fa-spin');
            loadWorkforce().finally(() => {
                setTimeout(() => this.querySelector('i').classList.remove('fa-spin'), 500);
            });
        });

        // ==================== SUPPLY CHAIN INTELLIGENCE ====================
        let supplyChainData = null;
        let currentScCategory = 'all';
        let currentScFacility = 'all';
        let currentScStatus = 'all';

        async function loadSupplyChain() {
            try {
                const response = await fetch('/api/block-admin/supply-stats');
                const data = await response.json();
                
                if (data.success) {
                    supplyChainData = data;
                    updateScSummary(data.stats);
                    renderScAlerts(data.alerts || []);
                    populateFacilityFilter(data.facilities || []);
                    renderStockTable(data.items || []);
                    renderDemandForecast(data.forecast || []);
                }
            } catch (error) {
                console.error('Error loading supply chain:', error);
            }
        }

        function updateScSummary(s) {
            if (!s) return;
            document.getElementById('scCritical').textContent = s.critical || 0;
            document.getElementById('scLow').textContent = s.low || 0;
            document.getElementById('scOverstock').textContent = s.overstock || 0;
            document.getElementById('scExpiring').textContent = s.expiring || 0;
            document.getElementById('scExpired').textContent = s.expired || 0;
            document.getElementById('scAlerts').textContent = s.alerts || 0;
        }

        function renderScAlerts(alerts) {
            const container = document.getElementById('scAlertsContainer');
            if (!container) return;
            if (!alerts || alerts.length === 0) {
                container.innerHTML = '<div class="text-center text-success py-4"><i class="fas fa-check-circle fa-2x"></i><br>No alerts!</div>';
                return;
            }
            
            container.innerHTML = alerts.map(a => {
                const colors = { critical: 'border-start border-danger border-3 bg-danger-subtle', warning: 'border-start border-warning border-3 bg-warning-subtle', info: 'border-start border-info border-3' };
                return `
                <div class="p-2 ${colors[a.type] || ''}" style="font-size:0.8rem;">
                    <div class="d-flex align-items-start gap-2">
                        <span class="mt-1">${a.icon || '🔔'}</span>
                        <div>
                            <div>${a.message}</div>
                            <div class="badge bg-secondary mt-1">${a.action}</div>
                        </div>
                    </div>
                </div>`;
            }).join('');
        }

        function renderCategoryTabs(categories) {
            const container = document.getElementById('stockCategoryTabs');
            const allBtn = container.querySelector('[data-category="all"]');
            
            categories.forEach(cat => {
                const btn = document.createElement('button');
                btn.className = 'btn btn-sm btn-outline-secondary';
                btn.dataset.category = cat.id;
                btn.innerHTML = `<i class="fas ${cat.icon} me-1"></i>${cat.name}`;
                btn.addEventListener('click', function() {
                    container.querySelectorAll('button').forEach(b => b.classList.remove('active', 'btn-danger'));
                    container.querySelectorAll('button').forEach(b => b.classList.add('btn-outline-secondary'));
                    this.classList.remove('btn-outline-secondary');
                    this.classList.add('active', 'btn-danger');
                    currentScCategory = this.dataset.category;
                    applyScFilters();
                });
                container.appendChild(btn);
            });
            
            allBtn.addEventListener('click', function() {
                container.querySelectorAll('button').forEach(b => b.classList.remove('active', 'btn-danger'));
                container.querySelectorAll('button').forEach(b => b.classList.add('btn-outline-secondary'));
                this.classList.remove('btn-outline-secondary');
                this.classList.add('active', 'btn-danger');
                currentScCategory = 'all';
                applyScFilters();
            });
        }

        function populateFacilityFilter(facilities) {
            const select = document.getElementById('scFacilityFilter');
            facilities.forEach(f => {
                select.innerHTML += `<option value="${f.id}">${f.name}</option>`;
            });
        }

        function applyScFilters() {
            if (!supplyChainData || !supplyChainData.items) return;
            let filtered = supplyChainData.items;
            
            if (currentScCategory !== 'all') {
                filtered = filtered.filter(s => s.category === currentScCategory);
            }
            if (currentScFacility !== 'all') {
                filtered = filtered.filter(s => s.facility_id == currentScFacility);
            }
            if (currentScStatus !== 'all') {
                filtered = filtered.filter(s => s.status === currentScStatus);
            }
            renderStockTable(filtered);
        }

        function renderStockTable(stockData) {
            const tbody = document.getElementById('stockTableBody');
            if (!tbody) return;
            if (!stockData || stockData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center py-4">No items found</td></tr>';
                return;
            }
            
            tbody.innerHTML = stockData.slice(0, 50).map(s => {
                const statusColors = { critical: 'bg-danger', low: 'bg-warning text-dark', overstock: 'bg-info', adequate: 'bg-success', expired: 'bg-dark' };
                const expiryClass = s.days_left !== null && s.days_left <= 0 ? 'text-danger fw-bold' : (s.days_left !== null && s.days_left <= 30 ? 'text-warning' : '');
                
                return `
                <tr>
                    <td><strong>${s.name}</strong><br><small class="text-muted">${s.category || 'General'}</small></td>
                    <td><small>${s.facility}</small></td>
                    <td>
                        <div class="progress" style="height:6px;width:60px;">
                            <div class="progress-bar ${statusColors[s.status] || 'bg-secondary'}" style="width:${Math.min(s.stock_pct || 0, 100)}%"></div>
                        </div>
                        <small>${s.current_qty}/${s.max_qty}</small>
                    </td>
                    <td><span class="badge ${statusColors[s.status] || 'bg-secondary'}">${s.status}</span></td>
                    <td>${s.days_left !== null ? (s.days_left > 100 ? '100+' : s.days_left) + ' days' : 'N/A'}</td>
                    <td class="${expiryClass}">${s.expiry}</td>
                </tr>`;
            }).join('');
        }

        function renderDemandForecast(forecast) {
            const tbody = document.getElementById('demandForecastBody');
            if (!tbody) return;
            if (!forecast || forecast.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center py-4">No forecast data</td></tr>';
                return;
            }
            
            const trendIcons = { stable: '➡️', up: '📈', down: '📉' };
            const trendColors = { stable: '', up: 'text-warning', down: 'text-success' };
            
            tbody.innerHTML = forecast.map(f => `
                <tr>
                    <td class="fw-bold">${f.period}</td>
                    <td>${f.fever}</td>
                    <td>${f.anc}</td>
                    <td>${f.immunization}</td>
                    <td class="${trendColors[f.trend] || ''}">${trendIcons[f.trend] || '➡️'} ${f.trend}</td>
                </tr>`).join('');
        }

        // Supply Chain filters
        document.getElementById('scFacilityFilter')?.addEventListener('change', function() {
            currentScFacility = this.value;
            applyScFilters();
        });

        document.getElementById('scStatusFilter')?.addEventListener('change', function() {
            currentScStatus = this.value;
            applyScFilters();
        });

        document.getElementById('refreshSupplyBtn')?.addEventListener('click', function() {
            this.querySelector('i').classList.add('fa-spin');
            loadSupplyChain().finally(() => {
                setTimeout(() => this.querySelector('i').classList.remove('fa-spin'), 500);
            });
        });

        // ==================== OUTREACH INTELLIGENCE ====================
        let outreachData = null;

        async function loadOutreach() {
            try {
                const response = await fetch('/api/block-admin/outreach-stats');
                const data = await response.json();
                
                if (data.success) {
                    outreachData = data;
                    updateOutreachSummary(data.summary);
                    renderUpcomingCamps(data.upcoming_camps || []);
                    renderCoverage(data.coverage_30_days || []);
                    renderCampPerformance(data.past_camps || []);
                    renderCompliance(data.compliance_data || []);
                    renderAISuggestions(data.ai_suggestions || {});
                }
            } catch (error) {
                console.error('Error loading outreach:', error);
            }
        }

        function updateOutreachSummary(s) {
            document.getElementById('orUpcomingCamps').textContent = s.upcoming_camps;
            document.getElementById('orVillagesCovered').textContent = s.villages_covered_30_days;
            document.getElementById('orNotVisited').textContent = s.villages_not_visited_14_days;
            document.getElementById('orHouseholdCoverage').textContent = s.avg_household_coverage + '%';
            document.getElementById('orCompliance').textContent = s.avg_report_compliance + '%';
            document.getElementById('orAISuggestions').textContent = s.total_ai_suggestions;
        }

        function renderUpcomingCamps(camps) {
            const tbody = document.getElementById('upcomingCampsBody');
            const statusColors = { scheduled: 'bg-primary', confirmed: 'bg-success', pending: 'bg-warning text-dark' };
            tbody.innerHTML = camps.map(c => `
                <tr>
                    <td><strong>${c.name}</strong></td>
                    <td>${c.village}</td>
                    <td>${c.date}<br><small class="text-muted">${c.time}</small></td>
                    <td><span class="badge bg-secondary">${c.assigned_team}</span></td>
                    <td>${c.expected_beneficiaries}</td>
                    <td><span class="badge ${statusColors[c.status]}">${c.status}</span></td>
                </tr>`).join('');
        }

        function renderCoverage(coverage) {
            const tbody = document.getElementById('coverageTableBody');
            tbody.innerHTML = coverage.map(v => {
                const statusBadge = v.not_visited_14_days ? '<span class="badge bg-danger">Not Visited 14d+</span>' : '<span class="badge bg-success">Active</span>';
                return `
                <tr class="${v.not_visited_14_days ? 'table-danger' : ''}">
                    <td><strong>${v.village}</strong></td>
                    <td>
                        <div class="progress" style="height:6px;width:80px;">
                            <div class="progress-bar bg-info" style="width:${v.coverage_percent}%"></div>
                        </div>
                        <small>${v.coverage_percent}% (${v.visited_households}/${v.total_households})</small>
                    </td>
                    <td><span class="badge bg-primary">${v.visits_in_30_days}</span></td>
                    <td>${v.last_visit_date}<br><small class="text-muted">${v.days_since_visit}d ago</small></td>
                    <td>${statusBadge}</td>
                </tr>`}).join('');
        }

        function renderCampPerformance(camps) {
            const tbody = document.getElementById('campPerformanceBody');
            tbody.innerHTML = camps.map(c => {
                const scoreColor = c.performance_score >= 85 ? 'bg-success' : (c.performance_score >= 70 ? 'bg-warning text-dark' : 'bg-danger');
                return `
                <tr>
                    <td><strong>${c.name}</strong></td>
                    <td>${c.village}</td>
                    <td>${c.date}</td>
                    <td>${c.actual_attendance}/${c.expected_beneficiaries} (${c.attendance_rate}%)</td>
                    <td>${c.services_rendered}</td>
                    <td><span class="badge ${scoreColor}">${c.performance_score}</span></td>
                </tr>`}).join('');
        }

        function renderCompliance(data) {
            const tbody = document.getElementById('complianceTableBody');
            tbody.innerHTML = data.map(c => {
                const compColor = c.compliance_percent >= 90 ? 'bg-success' : (c.compliance_percent >= 70 ? 'bg-warning text-dark' : 'bg-danger');
                return `
                <tr>
                    <td><strong>${c.worker}</strong></td>
                    <td><span class="badge bg-info">${c.role}</span></td>
                    <td>${c.reports_due}</td>
                    <td>${c.reports_submitted}</td>
                    <td><span class="badge ${compColor}">${c.compliance_percent}%</span></td>
                    <td>${c.last_submission}</td>
                </tr>`}).join('');
        }

        function renderAISuggestions(ai) {
            if (!ai) ai = {};
            
            // Focus Areas
            const focusContainer = document.getElementById('focusAreasContainer');
            if (focusContainer) {
                const focusAreas = ai.focus_areas || [];
                focusContainer.innerHTML = focusAreas.length > 0 ? focusAreas.map(f => `
                    <div class="p-2 border-bottom">
                        <div class="d-flex justify-content-between">
                            <strong>${f.village}</strong>
                            <span class="badge ${f.priority === 'high' ? 'bg-danger' : 'bg-warning text-dark'}">${f.priority}</span>
                        </div>
                        <small class="text-muted">${f.reason}</small><br>
                        <small class="badge bg-secondary">${f.recommended_action}</small>
                    </div>`).join('') : '<div class="text-center text-muted py-3">No focus areas</div>';
            }
            
            // Supply Drops
            const supplyContainer = document.getElementById('supplyDropsContainer');
            if (supplyContainer) {
                const supplyDrops = ai.supply_drops || [];
                supplyContainer.innerHTML = supplyDrops.length > 0 ? supplyDrops.map(s => `
                    <div class="p-2 border-bottom">
                        <div class="d-flex justify-content-between">
                            <strong>${s.village}</strong>
                            <span class="badge ${s.urgency === 'high' ? 'bg-danger' : 'bg-warning text-dark'}">${s.urgency}</span>
                        </div>
                        <small>${(s.items || []).join(', ')}</small>
                    </div>`).join('') : '<div class="text-center text-muted py-3">No supply drops needed</div>';
            }
            
            // Health Awareness
            const awarenessContainer = document.getElementById('awarenessContainer');
            if (awarenessContainer) {
                const awareness = ai.awareness || [];
                awarenessContainer.innerHTML = awareness.length > 0 ? awareness.map(h => `
                    <div class="p-2 border-bottom">
                        <strong>${h.village}</strong> - ${h.topic}<br>
                        <small class="text-muted">${h.reason}</small>
                    </div>`).join('') : '<div class="text-center text-muted py-3">No awareness campaigns needed</div>';
            }
            
            // Rising Risk
            const riskContainer = document.getElementById('risingRiskContainer');
            if (riskContainer) {
                const risks = ai.rising_risk || [];
                riskContainer.innerHTML = risks.length > 0 ? risks.map(r => `
                    <div class="p-2 border-bottom bg-danger-subtle">
                        <div class="d-flex justify-content-between">
                            <strong class="text-danger">${r.village}</strong>
                            <span class="badge bg-danger">${r.confidence}%</span>
                        </div>
                        <div>${r.risk} <small class="text-muted">· ${r.trend}</small></div>
                    </div>`).join('') : '<div class="text-center text-success py-3"><i class="fas fa-check-circle"></i> No rising risks</div>';
            }
        }

        document.getElementById('refreshOutreachBtn')?.addEventListener('click', function() {
            this.querySelector('i').classList.add('fa-spin');
            loadOutreach().finally(() => {
                setTimeout(() => this.querySelector('i').classList.remove('fa-spin'), 500);
            });
        });

        // ==================== BLOCK PERFORMANCE DASHBOARD ====================
        let performanceData = null;

        async function loadPerformance() {
            try {
                const response = await fetch('/api/block-admin/block-performance');
                const data = await response.json();
                
                if (data.success) {
                    performanceData = data;
                    updatePerformanceKPIs(data.kpis || {});
                    renderMaternalBreakdown(data.maternal || {});
                    renderChildBreakdown(data.child || {});
                    renderOutreachBreakdown(data.outreach || {});
                }
            } catch (error) {
                console.error('Error loading performance:', error);
            }
        }

        function updatePerformanceKPIs(kpis) {
            const healthIndex = document.getElementById('kpiHealthIndex');
            if (healthIndex) healthIndex.textContent = kpis.health_index || '--';
            
            const healthTrend = document.getElementById('kpiHealthTrend');
            if (healthTrend) healthTrend.textContent = kpis.health_trend || '--';
            
            const maternal = document.getElementById('kpiMaternal');
            if (maternal) maternal.textContent = kpis.maternal || '--';
            
            const child = document.getElementById('kpiChild');
            if (child) child.textContent = kpis.child || '--';
            
            const disease = document.getElementById('kpiDisease');
            if (disease) disease.textContent = kpis.disease || '--';
            
            const outreach = document.getElementById('kpiOutreach');
            if (outreach) outreach.textContent = (kpis.outreach || 0) + '%';
            
            const medicine = document.getElementById('kpiMedicine');
            if (medicine) medicine.textContent = (kpis.medicine || 0) + '%';
            
            const immunization = document.getElementById('kpiImmunization');
            if (immunization) immunization.textContent = (kpis.immunization || 0) + '%';
        }

        function renderMaternalBreakdown(maternal) {
            const container = document.getElementById('maternalBreakdown');
            if (!container) return;
            
            container.innerHTML = `
                <div class="mb-2">
                    <div class="d-flex justify-content-between"><small>Total Pregnant</small><strong>${maternal.total_pregnant || 0}</strong></div>
                </div>
                <div class="mb-2">
                    <div class="d-flex justify-content-between"><small>Total Lactating</small><strong>${maternal.total_lactating || 0}</strong></div>
                </div>
                <div class="mb-2">
                    <div class="d-flex justify-content-between"><small>High Risk</small><strong class="text-danger">${maternal.high_risk || 0}</strong></div>
                </div>
            `;
        }

        function renderChildBreakdown(child) {
            const container = document.getElementById('childBreakdown');
            if (!container) return;
            
            container.innerHTML = `
                <div class="mb-2">
                    <div class="d-flex justify-content-between"><small>Under 1 Year</small><strong>${child.under_1 || 0}</strong></div>
                </div>
                <div class="mb-2">
                    <div class="d-flex justify-content-between"><small>1-5 Years</small><strong>${child.under_5 || 0}</strong></div>
                </div>
                <div class="mb-2">
                    <div class="d-flex justify-content-between"><small>Total Children</small><strong>${child.total || 0}</strong></div>
                </div>
            `;
        }

        function renderOutreachBreakdown(outreach) {
            const container = document.getElementById('outreachBreakdown');
            if (!container) return;
            
            const coverage = outreach.coverage_pct || 0;
            container.innerHTML = `
                <div class="mb-2">
                    <div class="d-flex justify-content-between"><small>Total Households</small><strong>${outreach.total_households || 0}</strong></div>
                </div>
                <div class="mb-2">
                    <div class="d-flex justify-content-between"><small>Visited (30d)</small><strong class="text-success">${outreach.visited_30d || 0}</strong></div>
                </div>
                <div class="mb-2">
                    <div class="d-flex justify-content-between"><small>Not Visited</small><strong class="text-danger">${outreach.not_visited || 0}</strong></div>
                </div>
                <div class="mb-2">
                    <div class="d-flex justify-content-between"><small>Coverage</small><strong>${coverage}%</strong></div>
                    <div class="progress mt-1" style="height:6px;">
                        <div class="progress-bar bg-success" style="width:${coverage}%"></div>
                    </div>
                </div>
            `;
        }

        document.getElementById('refreshPerformanceBtn')?.addEventListener('click', function() {
            this.querySelector('i').classList.add('fa-spin');
            loadPerformance().finally(() => {
                setTimeout(() => this.querySelector('i').classList.remove('fa-spin'), 500);
            });
        });

        // ==================== PHC PERFORMANCE COMPARISON ====================
        let phcCompareData = null;

        async function loadPhcComparison() {
            try {
                const response = await fetch('/api/block-admin/phc-comparison');
                const data = await response.json();
                
                if (data.success) {
                    phcCompareData = data;
                    updatePhcSummary(data.summary || {});
                    renderPhcTable(data.phcs || []);
                    renderPhcSidePanels(data);
                }
            } catch (error) {
                console.error('Error loading PHC comparison:', error);
            }
        }

        function updatePhcSummary(s) {
            const phcTotal = document.getElementById('phcTotalPHC');
            if (phcTotal) phcTotal.textContent = s.total_phcs || 0;
            
            const scTotal = document.getElementById('phcTotalSC');
            if (scTotal) scTotal.textContent = s.total_subcenters || 0;
            
            const avgScore = document.getElementById('phcAvgScore');
            if (avgScore) avgScore.textContent = s.avg_score || 0;
            
            const needsSupport = document.getElementById('phcNeedsSupport');
            if (needsSupport) needsSupport.textContent = s.needs_support || 0;
            
            const criticalStock = document.getElementById('phcCriticalStock');
            if (criticalStock) criticalStock.textContent = s.critical_stock || 0;
        }

        function renderPhcTable(phcs) {
            const tbody = document.getElementById('phcTableBody');
            if (!tbody) return;
            
            if (!phcs || phcs.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center py-4 text-muted">No facilities found</td></tr>';
                return;
            }
            
            const stockColors = { adequate: 'bg-success', low: 'bg-warning text-dark', critical: 'bg-danger' };
            
            tbody.innerHTML = phcs.map(p => {
                const scoreColor = p.score >= 85 ? 'bg-success' : (p.score >= 70 ? 'bg-warning text-dark' : 'bg-danger');
                const rowClass = p.needs_support ? 'table-danger' : '';
                return `
                <tr class="${rowClass}">
                    <td>
                        <strong>${p.name}</strong>
                        <span class="badge bg-${p.type === 'PHC' ? 'primary' : 'info'} ms-1">${p.type}</span>
                    </td>
                    <td>
                        <div class="progress" style="height:6px;width:60px;">
                            <div class="progress-bar bg-info" style="width:${p.coverage_percent}%"></div>
                        </div>
                        <small>${p.coverage_percent}%</small>
                    </td>
                    <td><span class="badge bg-secondary">${p.high_risk_cases}</span></td>
                    <td>${p.staff_active}/${p.staff_total}</td>
                    <td><span class="badge ${stockColors[p.vaccine_stock] || 'bg-secondary'}">${p.vaccine_stock}</span></td>
                    <td>${p.alerts > 0 ? `<span class="badge bg-danger">${p.alerts}</span>` : '0'}</td>
                    <td><span class="badge ${scoreColor}">${p.score}</span></td>
                </tr>`}).join('');
        }

        function renderPhcSidePanels(data) {
            // Needs Support
            const needsSupportList = document.getElementById('phcNeedsSupportList');
            if (needsSupportList) {
                const needs = data.needs_support || [];
                needsSupportList.innerHTML = needs.length ? 
                    needs.map(p => `
                        <div class="p-2 border-bottom">
                            <strong>${p.name}</strong><br>
                            <small class="text-muted">${p.reason}</small><br>
                            <span class="badge bg-secondary">${p.action}</span>
                        </div>`).join('') : '<div class="p-3 text-success text-center">All PHCs performing well</div>';
            }
            
            // Best Performers
            const bestPerformers = document.getElementById('phcBestPerformers');
            if (bestPerformers) {
                const best = data.best_performers || [];
                bestPerformers.innerHTML = best.length ?
                    best.map(p => `
                        <div class="p-2 border-bottom d-flex justify-content-between align-items-center">
                            <strong>${p.name}</strong>
                            <span class="badge bg-success">${p.score} ↑</span>
                        </div>`).join('') : '<div class="p-3 text-muted text-center">No standout performers</div>';
            }
            
            // Supply Redistribution (empty for now - no real data)
            const supplyRedist = document.getElementById('phcSupplyRedist');
            if (supplyRedist) {
                supplyRedist.innerHTML = '<div class="p-3 text-muted text-center">No redistribution needed</div>';
            }
        }

        document.getElementById('refreshPhcBtn')?.addEventListener('click', function() {
            this.querySelector('i').classList.add('fa-spin');
            loadPhcComparison().finally(() => {
                setTimeout(() => this.querySelector('i').classList.remove('fa-spin'), 500);
            });
        });

        // ==================== COMMUNICATION & BROADCAST CENTER ====================
        let communicationData = null;
        let currentMsgType = 'sms';

        async function loadCommunication() {
            try {
                const response = await fetch('/api/block-admin/broadcast-center');
                const data = await response.json();
                
                if (data.success) {
                    communicationData = data;
                    updateCommStats(data.stats || {});
                    populateRecipients(data.recipient_groups || []);
                    renderTemplates(data.templates || []);
                    renderBroadcastHistory(data.recent_broadcasts || []);
                }
            } catch (error) {
                console.error('Error loading communication:', error);
            }
        }

        function updateCommStats(s) {
            const sentToday = document.getElementById('commSentToday');
            if (sentToday) sentToday.textContent = s.total_sent_today || 0;
            
            const sentWeek = document.getElementById('commSentWeek');
            if (sentWeek) sentWeek.textContent = s.total_sent_week || 0;
            
            const sentMonth = document.getElementById('commSentMonth');
            if (sentMonth) sentMonth.textContent = s.total_sent_month || 0;
            
            const deliveryRate = document.getElementById('commDeliveryRate');
            if (deliveryRate) deliveryRate.textContent = (s.avg_delivery_rate || 0) + '%';
            
            const pending = document.getElementById('commPending');
            if (pending) pending.textContent = s.pending_scheduled || 0;
        }

        function populateRecipients(groups) {
            const select = document.getElementById('msgRecipients');
            if (!select) return;
            select.innerHTML = '<option value="">Select recipients...</option>';
            groups.forEach(g => {
                select.innerHTML += `<option value="${g.id}">${g.name} (${g.count})</option>`;
            });
        }

        function renderTemplates(templates) {
            const container = document.getElementById('templatesList');
            if (!container) return;
            
            if (!templates || templates.length === 0) {
                container.innerHTML = '<span class="text-muted">No templates available</span>';
                return;
            }
            
            const typeColors = { 'Bulk SMS': 'primary', 'Push Notification': 'info', 'Emergency Alert': 'danger', 'Task Reminder': 'warning' };
            container.innerHTML = templates.map(t => `
                <button class="btn btn-sm btn-outline-${typeColors[t.type] || 'secondary'}" onclick="useTemplate('${t.content.replace(/'/g, "\\'")}')">
                    ${t.name}
                </button>`).join('');
        }

        function useTemplate(content) {
            const msgContent = document.getElementById('msgContent');
            if (msgContent) {
                msgContent.value = content;
                const charCount = document.getElementById('msgCharCount');
                if (charCount) charCount.textContent = content.length;
            }
        }

        function renderBroadcastHistory(broadcasts) {
            const tbody = document.getElementById('broadcastHistory');
            if (!tbody) return;
            
            if (!broadcasts || broadcasts.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center py-4 text-muted">No broadcasts sent yet</td></tr>';
                return;
            }
            
            const typeIcons = { 'Bulk SMS': '📱', 'Push Notification': '🔔', 'Task Reminder': '⏰', 'Emergency Alert': '🚨' };
            const statusColors = { delivered: 'bg-success', partial: 'bg-warning text-dark', failed: 'bg-danger' };
            
            tbody.innerHTML = broadcasts.map(b => `
                <tr>
                    <td><span title="${b.type}">${typeIcons[b.type] || '📨'}</span></td>
                    <td><small>${b.title}</small></td>
                    <td><small>${b.recipients}<br>(${b.recipient_count})</small></td>
                    <td><small>${b.sent_at}</small></td>
                    <td><span class="badge ${statusColors[b.status] || 'bg-secondary'}">${b.delivery_rate}%</span></td>
                </tr>`).join('');
        }

        // Message type selector
        document.getElementById('msgTypeSelector')?.querySelectorAll('button').forEach(btn => {
            btn.addEventListener('click', function() {
                this.parentElement.querySelectorAll('button').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                currentMsgType = this.dataset.type;
            });
        });

        // Character counter
        document.getElementById('msgContent')?.addEventListener('input', function() {
            const charCount = document.getElementById('msgCharCount');
            if (charCount) charCount.textContent = this.value.length;
        });

        // Compose form submit
        document.getElementById('composeMessageForm')?.addEventListener('submit', function(e) {
            e.preventDefault();
            const recipients = document.getElementById('msgRecipients').value;
            const content = document.getElementById('msgContent').value;
            if (recipients && content) {
                alert(`Message queued for sending!\n\nType: ${currentMsgType.toUpperCase()}\nRecipients: ${recipients}\nMessage: ${content.substring(0, 50)}...`);
                this.reset();
                const charCount = document.getElementById('msgCharCount');
                if (charCount) charCount.textContent = '0';
            }
        });

        document.getElementById('refreshCommBtn')?.addEventListener('click', function() {
            this.querySelector('i').classList.add('fa-spin');
            loadCommunication().finally(() => {
                setTimeout(() => this.querySelector('i').classList.remove('fa-spin'), 500);
            });
        });

        // ==================== EMERGENCY RESPONSE MODULE ====================
        let emergencyData = null;

        async function loadEmergencyResponse() {
            try {
                const response = await fetch('/api/block-admin/emergency-response');
                const data = await response.json();
                
                if (data.success) {
                    emergencyData = data;
                    updateEmergencySummary(data.summary || {});
                    updateEmergencyResources(data.resources || {});
                    renderEmergencyAlerts(data.active_emergencies || []);
                }
            } catch (error) {
                console.error('Error loading emergency response:', error);
            }
        }

        function updateEmergencySummary(s) {
            const activeCount = document.getElementById('emgActiveCount');
            if (activeCount) activeCount.textContent = s.active_emergencies || 0;
            
            const criticalCount = document.getElementById('emgCriticalCount');
            if (criticalCount) criticalCount.textContent = s.critical_count || 0;
            
            const respondingCount = document.getElementById('emgRespondingCount');
            if (respondingCount) respondingCount.textContent = s.responding || 0;
            
            const avgResponse = document.getElementById('emgAvgResponse');
            if (avgResponse) avgResponse.textContent = s.avg_response_time || '-- min';
            
            const alertCount = document.getElementById('emgAlertCount');
            if (alertCount) alertCount.textContent = s.active_emergencies || 0;
        }

        function updateEmergencyResources(r) {
            const ambulances = document.getElementById('resAmbulances');
            if (ambulances) ambulances.textContent = `${r.ambulances_available || 0}/${r.total_ambulances || 0}`;
            
            const phcs = document.getElementById('resPHCs');
            if (phcs) phcs.textContent = r.phcs_operational || 0;
            
            const ashas = document.getElementById('resASHAs');
            if (ashas) ashas.textContent = r.ashas_available || 0;
            
            const doctors = document.getElementById('resDoctors');
            if (doctors) doctors.textContent = r.doctors_on_duty || 0;
        }

        function renderEmergencyAlerts(emergencies) {
            const container = document.getElementById('emergencyAlertsContainer');
            if (!container) return;
            
            if (!emergencies || emergencies.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-5">
                        <i class="fas fa-check-circle text-success" style="font-size:3rem;"></i>
                        <div class="mt-3 fw-bold text-success">No Active Emergencies</div>
                        <small class="text-muted">All clear in your block</small>
                    </div>`;
                return;
            }
            
            const priorityBorders = { critical: 'border-start border-danger border-4', high: 'border-start border-warning border-4' };
            const statusBadges = { active: 'bg-danger', responding: 'bg-warning text-dark', en_route: 'bg-info' };
            
            container.innerHTML = emergencies.map(e => `
                <div class="p-3 border-bottom ${priorityBorders[e.priority] || ''}">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <div>
                            <span class="badge bg-danger">${e.type || 'Emergency'}</span>
                            <span class="badge ${statusBadges[e.status] || 'bg-secondary'} ms-1">${e.status || 'active'}</span>
                        </div>
                        <small class="text-danger fw-bold">${e.minutes_ago || 0} min ago</small>
                    </div>
                    <div class="mb-2">
                        <strong>${e.patient_name || 'Unknown'}</strong> • 📍 ${e.village || 'Unknown'}
                    </div>
                    <div class="mt-2 d-flex gap-2">
                        <button class="btn btn-sm btn-success"><i class="fas fa-check me-1"></i>Mark Responded</button>
                        <button class="btn btn-sm btn-primary"><i class="fas fa-phone me-1"></i>Call PHC</button>
                        <button class="btn btn-sm btn-danger"><i class="fas fa-ambulance me-1"></i>Dispatch</button>
                    </div>
                </div>
            `).join('');
        }

        document.getElementById('refreshEmergencyBtn')?.addEventListener('click', function() {
            this.querySelector('i').classList.add('fa-spin');
            loadEmergencyResponse().finally(() => {
                setTimeout(() => this.querySelector('i').classList.remove('fa-spin'), 500);
            });
        });

        // ==================== DOCUMENTS & REPORTING CENTER ====================
        let reportsData = null;
        let selectedReportType = null;
        let selectedExportFormat = 'pdf';

        async function loadReportsCenter() {
            try {
                const response = await fetch('/api/block-admin/reports-center');
                const data = await response.json();
                
                if (data.success) {
                    reportsData = data;
                    updateReportsSummary(data.summary || {});
                    renderReportTypes(data.report_types || []);
                    renderRecentReports(data.recent_reports || []);
                    renderScheduledReports(data.scheduled_reports || []);
                    renderApiEndpoints(data.api_endpoints || []);
                }
            } catch (error) {
                console.error('Error loading reports:', error);
            }
        }

        function updateReportsSummary(s) {
            const totalGen = document.getElementById('rptTotalGenerated');
            if (totalGen) totalGen.textContent = s.total_reports_generated || 0;
            
            const thisMonth = document.getElementById('rptThisMonth');
            if (thisMonth) thisMonth.textContent = s.reports_this_month || 0;
            
            const scheduled = document.getElementById('rptScheduled');
            if (scheduled) scheduled.textContent = s.scheduled_reports || 0;
            
            const pending = document.getElementById('rptPending');
            if (pending) pending.textContent = s.pending_exports || 0;
            
            const storage = document.getElementById('rptStorage');
            if (storage) storage.textContent = s.storage_used || '0 MB';
        }

        function renderReportTypes(types) {
            const container = document.getElementById('reportTypesList');
            if (!container) return;
            
            if (!types || types.length === 0) {
                container.innerHTML = '<span class="text-muted">No report types available</span>';
                return;
            }
            
            container.innerHTML = types.map(t => `
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="reportType" id="rpt_${t.id}" value="${t.id}">
                    <label class="form-check-label d-flex align-items-center" for="rpt_${t.id}">
                        <i class="fas ${t.icon} me-2" style="color:${t.color};"></i>
                        ${t.name}
                        <span class="badge bg-secondary ms-2">${t.frequency}</span>
                    </label>
                </div>
            `).join('');
            
            // Add click handlers
            document.querySelectorAll('input[name="reportType"]').forEach(radio => {
                radio.addEventListener('change', () => selectedReportType = radio.value);
            });
        }

        function renderRecentReports(reports) {
            const tbody = document.getElementById('recentReportsBody');
            if (!tbody) return;
            
            if (!reports || reports.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center py-4 text-muted">No reports generated yet</td></tr>';
                return;
            }
            
            const formatIcons = { PDF: 'fa-file-pdf text-danger', Excel: 'fa-file-excel text-success', API: 'fa-code text-info' };
            tbody.innerHTML = reports.slice(0, 8).map(r => `
                <tr>
                    <td><i class="fas ${r.type_icon || 'fa-file'} me-1" style="color:${r.type_color || '#6c757d'};"></i><small>${r.type_name}</small></td>
                    <td><small>${r.generated_at}</small></td>
                    <td><i class="fas ${formatIcons[r.export_format] || 'fa-file'}"></i> ${r.export_format}</td>
                    <td><small>${r.file_size}</small></td>
                    <td><button class="btn btn-sm btn-outline-primary"><i class="fas fa-download"></i></button></td>
                </tr>
            `).join('');
        }

        function renderScheduledReports(scheduled) {
            const tbody = document.getElementById('scheduledReportsBody');
            if (!tbody) return;
            
            if (!scheduled || scheduled.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="text-center py-3 text-muted">No scheduled reports</td></tr>';
                return;
            }
            
            tbody.innerHTML = scheduled.map(s => `
                <tr>
                    <td><strong>${s.report}</strong></td>
                    <td><small>${s.schedule}</small></td>
                    <td><span class="badge bg-info">${s.next_run}</span></td>
                    <td><span class="badge bg-secondary">${s.format}</span></td>
                </tr>
            `).join('');
        }

        function renderApiEndpoints(endpoints) {
            const tbody = document.getElementById('apiEndpointsBody');
            if (!tbody) return;
            
            if (!endpoints || endpoints.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="text-center py-3 text-muted">No API endpoints</td></tr>';
                return;
            }
            
            tbody.innerHTML = endpoints.map(e => `
                <tr>
                    <td><strong>${e.name}</strong></td>
                    <td><code class="small">${e.endpoint}</code></td>
                    <td><span class="badge bg-primary">${e.method}</span></td>
                    <td><small class="text-muted">${e.last_called}</small></td>
                </tr>
            `).join('');
        }

        // Export format selector
        document.getElementById('exportFormatSelector')?.querySelectorAll('button').forEach(btn => {
            btn.addEventListener('click', function() {
                this.parentElement.querySelectorAll('button').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                selectedExportFormat = this.dataset.format;
            });
        });

        // Generate report button
        document.getElementById('generateReportBtn')?.addEventListener('click', function() {
            if (!selectedReportType) {
                alert('Please select a report type');
                return;
            }
            const reportName = reportsData?.report_types?.find(r => r.id === selectedReportType)?.name || selectedReportType;
            alert(`Generating ${reportName} as ${selectedExportFormat.toUpperCase()}...\n\nReport will be available in Recent Reports shortly.`);
        });

        document.getElementById('refreshReportsBtn')?.addEventListener('click', function() {
            this.querySelector('i').classList.add('fa-spin');
            loadReportsCenter().finally(() => {
                setTimeout(() => this.querySelector('i').classList.remove('fa-spin'), 500);
            });
        });

        // ==================== ADMIN CONTROLS ====================
        let adminControlsData = null;
        let currentAdminTab = 'workers';

        async function loadAdminControls() {
            try {
                const response = await fetch('/api/block-admin/admin-controls');
                const data = await response.json();
                console.log('[DEBUG] Admin controls response:', data);
                console.log('[DEBUG] Villages from API:', data.villages);
                
                if (data.success) {
                    adminControlsData = data;
                    updateAdminSummary(data.summary || {});
                    renderAdminWorkers(data.workers || []);
                    renderAdminVillages(data.villages || []);
                    renderAdminPHCs(data.phcs || []);
                    renderAdminPrograms(data.programs || []);
                    renderAdminRoles(data.roles || []);
                    populateGeoConfig(data.geo_config || {});
                }
            } catch (error) {
                console.error('Error loading admin controls:', error);
            }
        }

        function updateAdminSummary(s) {
            const totalWorkers = document.getElementById('adminTotalWorkers');
            if (totalWorkers) totalWorkers.textContent = s.total_workers || 0;
            
            const activeWorkers = document.getElementById('adminActiveWorkers');
            if (activeWorkers) activeWorkers.textContent = s.active_workers || 0;
            
            const villages = document.getElementById('adminVillages');
            if (villages) villages.textContent = s.total_villages || 0;
            
            const unassigned = document.getElementById('adminUnassigned');
            if (unassigned) unassigned.textContent = s.unassigned_villages || 0;
            
            const pendingTasks = document.getElementById('adminPendingTasks');
            if (pendingTasks) pendingTasks.textContent = s.pending_tasks || 0;
        }

        function renderAdminWorkers(workers) {
            const tbody = document.getElementById('adminWorkersBody');
            if (!tbody) return;
            
            if (!workers || workers.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center py-4 text-muted">No workers found. Click "Add Worker" to create one.</td></tr>';
                return;
            }
            
            const statusColors = { active: 'bg-success', inactive: 'bg-secondary', pending: 'bg-warning text-dark', on_leave: 'bg-warning text-dark' };
            tbody.innerHTML = workers.map(w => {
                const payload = encodeURIComponent(JSON.stringify({
                    uid: w.uid,
                    name: w.name,
                    phone: w.phone,
                    role: w.role,
                    status: w.status
                }));
                const shortId = String(w.uid || w.id || '').slice(0, 8);
                return `
                <tr>
                    <td><small title="${String(w.uid || w.id || '')}">${shortId}${shortId ? '…' : ''}</small></td>
                    <td><strong>${w.name}</strong></td>
                    <td><span class="badge bg-${w.role === 'ASHA' ? 'info' : 'primary'}">${w.role}</span></td>
                    <td><small>${w.phone}</small></td>
                    <td>${w.village}</td>
                    <td><span class="badge ${statusColors[(w.status || '').toLowerCase()] || 'bg-secondary'}">${(w.status || '').toString().toUpperCase()}</span></td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary" data-action="edit-worker" data-payload="${payload}" title="Edit">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger" data-action="delete-worker" data-payload="${payload}" title="Delete">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>`;
            }).join('');
        }

        function renderAdminVillages(villages) {
            const tbody = document.getElementById('adminVillagesBody');
            if (!tbody) return;
            
            if (!villages || villages.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center py-4 text-muted">No villages found</td></tr>';
                return;
            }
            
            tbody.innerHTML = villages.map(v => {
                const payload = encodeURIComponent(JSON.stringify({
                    id: v.id,
                    name: v.name,
                    population: v.population || 0,
                    households: v.households || 0,
                    pincode: v.pincode || '',
                    latitude: v.latitude ?? null,
                    longitude: v.longitude ?? null,
                    assigned_asha_uid: v.assigned_asha_uid ?? null,
                    assigned_anm_uid: v.assigned_anm_uid ?? null,
                    assigned_asha: v.assigned_asha || null,
                    assigned_anm: v.assigned_anm || null
                }));
                return `
                <tr class="${!v.assigned_asha || !v.assigned_anm ? 'table-warning' : ''}">
                    <td><small>${v.id}</small></td>
                    <td><strong>${v.name}</strong></td>
                    <td>${(v.population || 0).toLocaleString()}</td>
                    <td>${v.households || 0}</td>
                    <td>${v.assigned_asha || '<span class="text-danger">Unassigned</span>'}</td>
                    <td>${v.assigned_anm || '<span class="text-danger">Unassigned</span>'}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary" data-action="assign-village" data-payload="${payload}" title="Assign ASHA/ANM">
                            <i class="fas fa-user-plus"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-secondary" data-action="edit-village" data-payload="${payload}" title="Edit village">
                            <i class="fas fa-edit"></i>
                        </button>
                    </td>
                </tr>`;
            }).join('');
        }

        function renderAdminPHCs(phcs) {
            const tbody = document.getElementById('adminPHCsBody');
            if (!tbody) return;
            
            if (!phcs || phcs.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="text-center py-4 text-muted">No facilities found. Click "Add Facility" to create one.</td></tr>';
                return;
            }
            
            const statusColors = { operational: 'bg-success', under_maintenance: 'bg-warning text-dark', inactive: 'bg-secondary' };
            tbody.innerHTML = phcs.map(p => {
                const payload = encodeURIComponent(JSON.stringify({
                    id: p.id,
                    name: p.name,
                    facility_type: p.type,
                    beds: p.beds || 0,
                    phone: p.phone || '',
                    email: p.email || '',
                    village: p.village || '',
                    address: p.address || '',
                    in_charge_name: p.in_charge_name || '',
                    is_active: p.is_active ?? (p.status !== 'inactive')
                }));
                return `
                <tr>
                    <td><small>${p.id}</small></td>
                    <td><strong>${p.name}</strong></td>
                    <td><span class="badge bg-${p.type === 'PHC' ? 'primary' : 'info'}">${p.type}</span></td>
                    <td>${p.beds || 0}</td>
                    <td>${p.staff || 0}</td>
                    <td><small>${p.contact}</small></td>
                    <td><span class="badge ${statusColors[p.status] || 'bg-success'}">${p.status || 'operational'}</span></td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary" data-action="edit-facility" data-payload="${payload}" title="Edit facility">
                            <i class="fas fa-edit"></i>
                        </button>
                    </td>
                </tr>`;
            }).join('');
        }

        function renderAdminPrograms(programs) {
            const tbody = document.getElementById('adminProgramsBody');
            if (!tbody) return;
            
            if (!programs || programs.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center py-4 text-muted">No programs found</td></tr>';
                return;
            }
            
            const statusColors = { active: 'bg-success', seasonal: 'bg-info', inactive: 'bg-secondary' };
            tbody.innerHTML = programs.map(p => `
                <tr>
                    <td><small>${p.id}</small></td>
                    <td><strong>${p.name}</strong></td>
                    <td><span class="badge ${statusColors[p.status] || 'bg-success'}">${p.status}</span></td>
                    <td>${(p.beneficiaries || 0).toLocaleString()}</td>
                    <td>${p.start_date}</td>
                    <td><button class="btn btn-sm btn-outline-primary"><i class="fas fa-edit"></i></button></td>
                </tr>`).join('');
        }

        function renderAdminRoles(roles) {
            const tbody = document.getElementById('adminRolesBody');
            if (!tbody) return;
            
            if (!roles || roles.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center py-4 text-muted">No roles defined</td></tr>';
                return;
            }
            
            tbody.innerHTML = roles.map(r => `
                <tr>
                    <td><small>${r.id}</small></td>
                    <td><strong>${r.name}</strong></td>
                    <td><span class="badge bg-secondary">${r.permissions} permissions</span></td>
                    <td>${r.users || 0}</td>
                    <td><button class="btn btn-sm btn-outline-primary"><i class="fas fa-edit"></i></button></td>
                </tr>`).join('');
        }

        function populateGeoConfig(geo) {
            const blockName = document.getElementById('geoBlockName');
            if (blockName) blockName.value = geo.block_name || '';
            
            const district = document.getElementById('geoDistrict');
            if (district) district.value = geo.district || '';
            
            const state = document.getElementById('geoState');
            if (state) state.value = geo.state || '';
            
            const centerLat = document.getElementById('geoCenterLat');
            if (centerLat) centerLat.value = geo.center_lat || '';
            
            const centerLng = document.getElementById('geoCenterLng');
            if (centerLng) centerLng.value = geo.center_lng || '';
            
            const totalArea = document.getElementById('geoTotalArea');
            if (totalArea) totalArea.value = geo.total_area || '';
        }

        // Tab switching
        document.getElementById('adminTabs')?.querySelectorAll('a').forEach(tab => {
            tab.addEventListener('click', function(e) {
                e.preventDefault();
                document.querySelectorAll('#adminTabs a').forEach(t => t.classList.remove('active'));
                this.classList.add('active');
                currentAdminTab = this.dataset.tab;
                
                // Hide all, show selected
                document.querySelectorAll('.admin-tab-pane').forEach(p => p.style.display = 'none');
                const tabMap = { workers: 'adminWorkersTab', villages: 'adminVillagesTab', phcs: 'adminPHCsTab', programs: 'adminProgramsTab', roles: 'adminRolesTab', geo: 'adminGeoTab' };
                const tabEl = document.getElementById(tabMap[currentAdminTab]);
                if (tabEl) tabEl.style.display = 'block';
            });
        });

        document.getElementById('refreshAdminBtn')?.addEventListener('click', function() {
            this.querySelector('i').classList.add('fa-spin');
            loadAdminControls().finally(() => {
                setTimeout(() => this.querySelector('i').classList.remove('fa-spin'), 500);
            });
        });

        // ==================== ADD WORKER FUNCTIONALITY ====================
        document.getElementById('submitAddWorker')?.addEventListener('click', async function() {
            const form = document.getElementById('addWorkerForm');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }

            const btn = this;
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Creating...';
            btn.disabled = true;

            try {
                const response = await fetch('/api/block-admin/create-health-worker', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        name: document.getElementById('workerName').value,
                        email: document.getElementById('workerEmail').value,
                        mobile: document.getElementById('workerMobile').value,
                        worker_type: document.getElementById('workerType').value,
                        password: document.getElementById('workerPassword').value
                    })
                });

                const data = await response.json();

                if (data.success) {
                    // Close modal
                    const modal = bootstrap.Modal.getInstance(document.getElementById('addWorkerModal'));
                    modal.hide();

                    // Reset form
                    form.reset();

                    // Reload workers list
                    await loadAdminControls();

                    // Show success alert
                    alert(`Health Worker created successfully!\n\nUID: ${data.worker.uid}\nEmail notification sent: ${data.email_sent ? 'Yes' : 'No'}`);
                } else {
                    alert('Error: ' + (data.error || 'Failed to create worker'));
                }
            } catch (error) {
                console.error('Error creating worker:', error);
                alert('Error creating worker. Please try again.');
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        });

        // ==================== EDIT WORKER FUNCTIONALITY ====================
        function openEditWorkerModal(uid, name, phone, role, status) {
            document.getElementById('editWorkerUid').value = uid;
            document.getElementById('editWorkerName').value = name;
            document.getElementById('editWorkerMobile').value = phone === 'N/A' ? '' : phone;
            document.getElementById('editWorkerType').value = role;
            document.getElementById('editWorkerStatus').value = status;
            
            const modal = new bootstrap.Modal(document.getElementById('editWorkerModal'));
            modal.show();
        }

        document.getElementById('submitEditWorker')?.addEventListener('click', async function() {
            const uid = document.getElementById('editWorkerUid').value;
            const btn = this;
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Saving...';
            btn.disabled = true;

            try {
                const response = await fetch(`/api/block-admin/workers/${uid}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        name: document.getElementById('editWorkerName').value,
                        mobile: document.getElementById('editWorkerMobile').value,
                        worker_type: document.getElementById('editWorkerType').value,
                        status: document.getElementById('editWorkerStatus').value
                    })
                });

                const data = await response.json();

                if (data.success) {
                    const modal = bootstrap.Modal.getInstance(document.getElementById('editWorkerModal'));
                    modal.hide();
                    await loadAdminControls();
                    alert('Worker updated successfully!');
                } else {
                    alert('Error: ' + (data.error || 'Failed to update worker'));
                }
            } catch (error) {
                console.error('Error updating worker:', error);
                alert('Error updating worker. Please try again.');
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        });

        // ==================== DELETE WORKER FUNCTIONALITY ====================
        async function deleteWorker(uid, name) {
            if (!confirm(`Are you sure you want to delete ${name}?\n\nThis will deactivate the account.`)) {
                return;
            }

            try {
                const response = await fetch(`/api/block-admin/workers/${uid}`, {
                    method: 'DELETE'
                });

                const data = await response.json();

                if (data.success) {
                    await loadAdminControls();
                    alert('Worker deleted successfully!');
                } else {
                    alert('Error: ' + (data.error || 'Failed to delete worker'));
                }
            } catch (error) {
                console.error('Error deleting worker:', error);
                alert('Error deleting worker. Please try again.');
            }
        }

        // ==================== ADMIN CONTROLS: BUTTON WIRING ====================
        function _decodePayloadFromButton(btn) {
            try {
                return JSON.parse(decodeURIComponent(btn.dataset.payload || ''));
            } catch (e) {
                console.error('Bad payload', e);
                return null;
            }
        }

        document.getElementById('adminWorkersBody')?.addEventListener('click', function(e) {
            const btn = e.target.closest('button[data-action]');
            if (!btn) return;
            const action = btn.dataset.action;
            const p = _decodePayloadFromButton(btn);
            if (!p) return;

            if (action === 'edit-worker') {
                openEditWorkerModal(p.uid, p.name, p.phone, p.role, (p.status || 'pending').toLowerCase());
            } else if (action === 'delete-worker') {
                deleteWorker(p.uid, p.name);
            }
        });

        document.getElementById('adminVillagesBody')?.addEventListener('click', function(e) {
            const btn = e.target.closest('button[data-action]');
            if (!btn) return;
            const action = btn.dataset.action;
            const p = _decodePayloadFromButton(btn);
            if (!p) return;

            if (action === 'assign-village') {
                openAssignVillageModal(p);
            } else if (action === 'edit-village') {
                openEditVillageModal(p);
            }
        });

        document.getElementById('adminPHCsBody')?.addEventListener('click', function(e) {
            const btn = e.target.closest('button[data-action]');
            if (!btn) return;
            const action = btn.dataset.action;
            const p = _decodePayloadFromButton(btn);
            if (!p) return;

            if (action === 'edit-facility') {
                openEditFacilityModal(p);
            }
        });

        // ==================== VILLAGE ASSIGNMENT ====================
        function openAssignVillageModal(v) {
            if (!v || !v.id) {
                alert('This village is inferred from household data (no Village record yet). Please click "Add Village" first to create it, then you can assign ASHA/ANM.');
                return;
            }
            document.getElementById('assignVillageId').value = v.id;
            document.getElementById('assignVillageTitle').textContent = v.name || 'Village';

            const ashaSel = document.getElementById('assignVillageAsha');
            const anmSel = document.getElementById('assignVillageAnm');

            const workers = adminControlsData?.workers || [];
            const ashas = workers.filter(w => String(w.role || '').toUpperCase() === 'ASHA');
            const anms = workers.filter(w => String(w.role || '').toUpperCase() === 'ANM');

            ashaSel.innerHTML = `<option value="">-- Unassigned --</option>` + ashas.map(w =>
                `<option value="${w.uid}">${w.name} (${w.uid})</option>`
            ).join('');
            anmSel.innerHTML = `<option value="">-- Unassigned --</option>` + anms.map(w =>
                `<option value="${w.uid}">${w.name} (${w.uid})</option>`
            ).join('');

            ashaSel.value = v.assigned_asha_uid || '';
            anmSel.value = v.assigned_anm_uid || '';

            new bootstrap.Modal(document.getElementById('assignVillageModal')).show();
        }

        document.getElementById('submitAssignVillage')?.addEventListener('click', async function() {
            const btn = this;
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Saving...';

            try {
                const villageId = document.getElementById('assignVillageId').value;
                const asha_uid = document.getElementById('assignVillageAsha').value || null;
                const anm_uid = document.getElementById('assignVillageAnm').value || null;

                const response = await fetch(`/api/block-admin/villages/${villageId}/assign`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ asha_uid, anm_uid })
                });

                const data = await response.json();
                if (data.success) {
                    bootstrap.Modal.getInstance(document.getElementById('assignVillageModal')).hide();
                    await loadAdminControls();
                    alert('Village assignment saved!');
                } else {
                    alert('Error: ' + (data.error || 'Failed to assign workers'));
                }
            } catch (error) {
                console.error('Error assigning village:', error);
                alert('Error saving assignment. Please try again.');
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        });

        // ==================== VILLAGE EDIT ====================
        function openEditVillageModal(v) {
            if (!v || !v.id) {
                alert('This village is inferred from household data (no Village record yet). Please click "Add Village" first to create it, then you can edit it.');
                return;
            }
            document.getElementById('editVillageId').value = v.id;
            document.getElementById('editVillageName').value = v.name || '';
            document.getElementById('editVillagePopulation').value = v.population || 0;
            document.getElementById('editVillageHouseholds').value = v.households || 0;
            document.getElementById('editVillagePincode').value = v.pincode || '';
            document.getElementById('editVillageLatitude').value = v.latitude ?? '';
            document.getElementById('editVillageLongitude').value = v.longitude ?? '';

            new bootstrap.Modal(document.getElementById('editVillageModal')).show();
        }

        document.getElementById('submitEditVillage')?.addEventListener('click', async function() {
            const form = document.getElementById('editVillageForm');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }

            const btn = this;
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Saving...';

            try {
                const villageId = document.getElementById('editVillageId').value;
                const response = await fetch(`/api/block-admin/villages/${villageId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        name: document.getElementById('editVillageName').value,
                        population: parseInt(document.getElementById('editVillagePopulation').value) || 0,
                        households: parseInt(document.getElementById('editVillageHouseholds').value) || 0,
                        pincode: document.getElementById('editVillagePincode').value,
                        latitude: document.getElementById('editVillageLatitude').value || null,
                        longitude: document.getElementById('editVillageLongitude').value || null
                    })
                });

                const data = await response.json();
                if (data.success) {
                    bootstrap.Modal.getInstance(document.getElementById('editVillageModal')).hide();
                    await loadAdminControls();
                    alert('Village updated successfully!');
                } else {
                    alert('Error: ' + (data.error || 'Failed to update village'));
                }
            } catch (error) {
                console.error('Error updating village:', error);
                alert('Error updating village. Please try again.');
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        });

        // ==================== FACILITY EDIT ====================
        function openEditFacilityModal(f) {
            document.getElementById('editFacilityId').value = f.id;
            document.getElementById('editFacilityName').value = f.name || '';
            document.getElementById('editFacilityType').value = f.facility_type || 'PHC';
            document.getElementById('editFacilityInCharge').value = f.in_charge_name || '';
            document.getElementById('editFacilityPhone').value = f.phone || '';
            document.getElementById('editFacilityEmail').value = f.email || '';
            document.getElementById('editFacilityBeds').value = f.beds || 0;
            document.getElementById('editFacilityVillage').value = f.village || '';
            document.getElementById('editFacilityAddress').value = f.address || '';
            document.getElementById('editFacilityActive').checked = !!f.is_active;

            new bootstrap.Modal(document.getElementById('editFacilityModal')).show();
        }

        document.getElementById('submitEditFacility')?.addEventListener('click', async function() {
            const btn = this;
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Saving...';

            try {
                const facilityId = document.getElementById('editFacilityId').value;
                const response = await fetch(`/api/block-admin/facilities/${facilityId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        name: document.getElementById('editFacilityName').value,
                        facility_type: document.getElementById('editFacilityType').value,
                        in_charge_name: document.getElementById('editFacilityInCharge').value,
                        phone: document.getElementById('editFacilityPhone').value,
                        beds_count: parseInt(document.getElementById('editFacilityBeds').value) || 0,
                        village: document.getElementById('editFacilityVillage').value,
                        address: document.getElementById('editFacilityAddress').value,
                        is_active: document.getElementById('editFacilityActive').checked
                    })
                });

                const data = await response.json();
                if (data.success) {
                    bootstrap.Modal.getInstance(document.getElementById('editFacilityModal')).hide();
                    await loadAdminControls();
                    alert('Facility updated successfully!');
                } else {
                    alert('Error: ' + (data.error || 'Failed to update facility'));
                }
            } catch (error) {
                console.error('Error updating facility:', error);
                alert('Error updating facility. Please try again.');
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        });

        // ==================== GEO CONFIG SAVE ====================
        document.getElementById('btnSaveGeoConfig')?.addEventListener('click', async function() {
            const btn = this;
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Saving...';
            btn.disabled = true;

            try {
                const lat = parseFloat(document.getElementById('geoCenterLat').value);
                const lng = parseFloat(document.getElementById('geoCenterLng').value);
                
                if (isNaN(lat) || isNaN(lng)) {
                    alert('Please enter valid latitude and longitude values');
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                    return;
                }

                if (lat < -90 || lat > 90) {
                    alert('Latitude must be between -90 and 90');
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                    return;
                }

                if (lng < -180 || lng > 180) {
                    alert('Longitude must be between -180 and 180');
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                    return;
                }

                const response = await fetch('/api/block-admin/update-geo-config', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        latitude: lat,
                        longitude: lng
                    })
                });

                const data = await response.json();
                if (data.success) {
                    alert('Location saved successfully! Go to the Dashboard page and click on the map area to see your location.');
                    
                    // Close all popups and reset map
                    if (geoHealthMap) {
                        geoHealthMap.closePopup();
                        // Clear existing markers
                        villageMarkers.forEach(m => geoHealthMap.removeLayer(m));
                        villageMarkers = [];
                        // Set the new view
                        geoHealthMap.setView([lat, lng], 11);
                        // Add a center marker
                        const centerMarker = L.marker([lat, lng]).addTo(geoHealthMap)
                            .bindPopup('<b>Block Center</b><br>Your block headquarters').openPopup();
                        villageMarkers.push(centerMarker);
                    }
                    
                    // Reload geo data
                    loadGeoHealthData();
                } else {
                    alert('Error: ' + (data.error || 'Failed to save'));
                }
            } catch (error) {
                console.error(error);
                alert('Error saving configuration. Please try again.');
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        });

        // ==================== FACILITY CREATION ====================
        document.getElementById('submitAddFacility')?.addEventListener('click', async function() {
            const btn = this;
            const form = document.getElementById('addFacilityForm');
            
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }
            
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Creating...';
            btn.disabled = true;
            
            try {
                const response = await fetch('/api/block-admin/facilities', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        name: document.getElementById('facilityName').value,
                        facility_type: document.getElementById('facilityType').value,
                        in_charge_name: document.getElementById('facilityInCharge').value,
                        phone: document.getElementById('facilityPhone').value,
                        email: document.getElementById('facilityEmail').value,
                        password: document.getElementById('facilityPassword').value,
                        village: document.getElementById('facilityVillage').value,
                        beds_count: parseInt(document.getElementById('facilityBeds').value) || 0,
                        address: document.getElementById('facilityAddress').value
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert(`Facility created successfully!\n\nUID: ${data.facility.admin_uid}\nEmail notification sent: ${data.email_sent ? 'Yes' : 'No'}`);
                    bootstrap.Modal.getInstance(document.getElementById('addFacilityModal')).hide();
                    form.reset();
                    loadAdminControls(); // Refresh the PHC list
                } else {
                    alert('Error: ' + (data.error || 'Failed to create facility'));
                }
            } catch (error) {
                console.error('Error creating facility:', error);
                alert('Error creating facility. Please try again.');
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        });

        // ==================== PHASE 12: INVENTORY & ASSETS SUMMARY ====================
        async function loadInventorySummary() {
            try {
                const res = await fetch('/api/admin/inventory-summary');
                const data = await res.json();
                
                if (data.success) {
                    // Update Supply Stock Index on dashboard
                    const inv = data.inventory;
                    const assets = data.assets;
                    
                    // Calculate overall supply index (percentage of items in stock)
                    const totalItems = inv.total || 1;
                    const inStockItems = totalItems - (inv.low_stock || 0) - (inv.out_of_stock || 0);
                    const supplyIndex = Math.round((inStockItems / totalItems) * 100);
                    
                    // Update KPI if elements exist
                    const kpiSupplyIndex = document.getElementById('kpiSupplyIndex');
                    if (kpiSupplyIndex) kpiSupplyIndex.textContent = supplyIndex + '%';
                    
                    const kpiCritical = document.getElementById('kpiCritical');
                    if (kpiCritical) kpiCritical.textContent = inv.out_of_stock || 0;
                    
                    // Update category counts if elements exist
                    const kpiVaccines = document.getElementById('kpiVaccines');
                    if (kpiVaccines) kpiVaccines.textContent = (inv.by_category?.vaccine || 0) + ' items';
                    
                    const kpiMedicines = document.getElementById('kpiMedicines');
                    if (kpiMedicines) kpiMedicines.textContent = (inv.by_category?.medicine || 0) + ' items';
                    
                    const kpiTestkits = document.getElementById('kpiTestkits');
                    if (kpiTestkits) kpiTestkits.textContent = (inv.by_category?.test_kit || 0) + ' items';
                    
                    console.log('Inventory summary loaded:', data);
                }
            } catch (e) {
                console.error('Inventory summary error:', e);
            }
        }

        // ==================== ADD VILLAGE HANDLER ====================
        document.getElementById('submitAddVillage')?.addEventListener('click', async function() {
            const btn = this;
            const form = document.getElementById('addVillageForm');
            
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }
            
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Adding...';
            btn.disabled = true;
            
            try {
                const response = await fetch('/api/block-admin/villages', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        name: document.getElementById('villageName').value,
                        population: parseInt(document.getElementById('villagePopulation').value) || 0,
                        households: parseInt(document.getElementById('villageHouseholds').value) || 0,
                        pincode: document.getElementById('villagePincode').value,
                        latitude: parseFloat(document.getElementById('villageLatitude').value) || null,
                        longitude: parseFloat(document.getElementById('villageLongitude').value) || null
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert(data.message || 'Village added successfully!');
                    form.reset();
                    bootstrap.Modal.getInstance(document.getElementById('addVillageModal')).hide();
                    loadAdminControls(); // Refresh the villages table
                } else {
                    alert('Error: ' + (data.error || 'Failed to add village'));
                }
            } catch (error) {
                console.error('Error adding village:', error);
                alert('Error adding village. Please try again.');
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        });

        // ==================== ADMIN TEAM MANAGEMENT (Phase 15) ====================
        async function loadAdminTeam() {
            const blockId = document.getElementById('currentBlockId')?.textContent || '';
            
            // Show loading state
            document.getElementById('adminTeamTableBody').innerHTML = `
                <tr><td colspan="6" class="text-center text-muted py-4">
                    <i class="fas fa-spinner fa-spin me-2"></i>Loading team members...
                </td></tr>`;
            
            try {
                const response = await fetch(`/api/admin/entity-admins/block/${encodeURIComponent(blockId)}`);
                const data = await response.json();
                
                if (data.success) {
                    renderAdminTeamTable(data.admins);
                    
                    // Update stats
                    document.getElementById('teamTotalAdmins').textContent = data.count || 0;
                    document.getElementById('teamActiveAdmins').textContent = data.count || 0;
                    const primaryCount = data.admins?.filter(a => a.is_primary).length || 0;
                    document.getElementById('teamPrimaryAdmin').textContent = primaryCount;
                    
                    // Load roles count
                    const rolesResponse = await fetch('/api/admin/roles');
                    const rolesData = await rolesResponse.json();
                    if (rolesData.success) {
                        document.getElementById('teamRolesCount').textContent = rolesData.roles?.length || 0;
                    }
                } else {
                    document.getElementById('adminTeamTableBody').innerHTML = `
                        <tr><td colspan="6" class="text-center text-muted py-4">
                            <i class="fas fa-exclamation-circle text-warning me-2"></i>${data.error || 'Failed to load team'}
                        </td></tr>`;
                }
            } catch (error) {
                console.error('Error loading admin team:', error);
                document.getElementById('adminTeamTableBody').innerHTML = `
                    <tr><td colspan="6" class="text-center text-muted py-4">
                        <i class="fas fa-exclamation-circle text-danger me-2"></i>Error loading team
                    </td></tr>`;
            }
        }
        
        function renderAdminTeamTable(admins) {
            const tbody = document.getElementById('adminTeamTableBody');
            
            if (!admins || admins.length === 0) {
                tbody.innerHTML = `
                    <tr><td colspan="6" class="text-center text-muted py-4">
                        <i class="fas fa-users me-2"></i>No admins assigned to this block yet. Click "Add Admin" to get started.
                    </td></tr>`;
                return;
            }
            
            tbody.innerHTML = admins.map(admin => `
                <tr>
                    <td>
                        <div class="d-flex align-items-center">
                            <div class="bg-danger text-white rounded-circle d-flex align-items-center justify-content-center me-2" style="width:35px;height:35px;font-size:0.8rem;">
                                ${(admin.name || 'U').charAt(0).toUpperCase()}
                            </div>
                            <div>
                                <div class="fw-bold">${admin.name || 'Unknown'}</div>
                                <small class="text-muted">${admin.mobile || 'No phone'}</small>
                            </div>
                        </div>
                    </td>
                    <td><small>${admin.email || 'N/A'}</small></td>
                    <td>
                        ${admin.is_primary 
                            ? '<span class="badge bg-danger"><i class="fas fa-crown me-1"></i>Primary</span>' 
                            : `<span class="badge bg-secondary">${admin.role_name || 'Admin'}</span>`}
                    </td>
                    <td><span class="badge bg-success">Active</span></td>
                    <td><small class="text-muted">${admin.assigned_at || 'N/A'}</small></td>
                    <td>
                        ${!admin.is_primary ? `
                            <button class="btn btn-sm btn-outline-danger" onclick="removeAdmin(${admin.id})" title="Remove">
                                <i class="fas fa-trash"></i>
                            </button>
                        ` : '<span class="badge bg-light text-muted">Protected</span>'}
                    </td>
                </tr>
            `).join('');
        }
        
        async function removeAdmin(assignmentId) {
            if (!confirm('Are you sure you want to remove this admin from the block?')) return;
            
            try {
                const response = await fetch(`/api/admin/assignments/${assignmentId}`, {
                    method: 'DELETE'
                });
                const data = await response.json();
                
                if (data.success) {
                    alert('Admin removed successfully');
                    loadAdminTeam();
                } else {
                    alert('Failed to remove admin: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error removing admin:', error);
                alert('Error removing admin');
            }
        }
        
        // Add Admin Form Handler
        document.getElementById('submitAddAdmin')?.addEventListener('click', async function() {
            const userId = document.getElementById('newAdminUserId')?.value;
            const role = document.getElementById('newAdminRole')?.value;
            const notes = document.getElementById('newAdminNotes')?.value;
            const blockId = document.getElementById('currentBlockId')?.textContent || '';
            const blockName = document.getElementById('currentBlockName')?.textContent || '';
            
            if (!userId) {
                alert('Please enter a user ID');
                return;
            }
            
            try {
                const response = await fetch('/api/admin/assignments', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        user_id: parseInt(userId),
                        entity_type: 'block',
                        entity_id: blockId,
                        entity_name: blockName,
                        role_name: role,
                        notes: notes,
                        is_primary: false
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert('Admin added successfully!');
                    bootstrap.Modal.getInstance(document.getElementById('addAdminModal'))?.hide();
                    document.getElementById('addAdminForm').reset();
                    loadAdminTeam();
                } else {
                    alert('Failed to add admin: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error adding admin:', error);
                alert('Error adding admin');
            }
        });
        
        // Refresh team button
        document.getElementById('refreshTeamBtn')?.addEventListener('click', loadAdminTeam);

        // ==================== SECURITY CENTER ====================
        async function safeFetchJson(url, options) {
            try {
                const res = await fetch(url, options);
                const text = await res.text();
                let data = null;
                try {
                    data = text ? JSON.parse(text) : null;
                } catch (e) {
                    data = null;
                }
                if (!res.ok) {
                    return data && typeof data === 'object'
                        ? data
                        : { success: false, error: `HTTP ${res.status} (${res.statusText})` };
                }
                return data && typeof data === 'object'
                    ? data
                    : { success: false, error: 'Invalid JSON response' };
            } catch (e) {
                return { success: false, error: e?.message || String(e) };
            }
        }

        async function loadSecurityCenter() {
            try {
                // Load security summary
                const summaryData = await safeFetchJson('/api/admin/security/summary');
                
                if (summaryData.success) {
                    const s = summaryData.summary;
                    document.getElementById('secLogins24h').textContent = s.logins_24h || 0;
                    document.getElementById('secFailed24h').textContent = s.failed_24h || 0;
                    document.getElementById('secActiveSessions').textContent = s.active_sessions || 0;
                    document.getElementById('secBlockedIPs').textContent = s.blocked_ips || 0;
                    document.getElementById('secApiCalls1h').textContent = s.api_calls_1h || 0;
                    document.getElementById('secUniqueDevices').textContent = s.unique_devices_7d || 0;
                } else {
                    // Keep KPIs but avoid leaving stale numbers from previous view
                    document.getElementById('secLogins24h').textContent = '0';
                    document.getElementById('secFailed24h').textContent = '0';
                    document.getElementById('secActiveSessions').textContent = '0';
                    document.getElementById('secBlockedIPs').textContent = '0';
                    document.getElementById('secApiCalls1h').textContent = '0';
                    document.getElementById('secUniqueDevices').textContent = '0';
                }
                
                // Load login logs
                const logsData = await safeFetchJson('/api/admin/security/login-logs?days=7&per_page=20');
                
                const logsTable = document.getElementById('loginLogsTable');
                if (logsData.success && (logsData.logs || []).length > 0) {
                    logsTable.innerHTML = logsData.logs.map(log => `
                        <tr>
                            <td class="small">${log.created_at ? new Date(log.created_at).toLocaleString() : '-'}</td>
                            <td>${log.user_name || log.email || '-'}</td>
                            <td><span class="badge ${log.status === 'success' ? 'bg-success' : 'bg-danger'}">${log.status}</span></td>
                            <td><small>${log.ip_address || '-'}</small></td>
                            <td><i class="fas fa-${log.device_type === 'mobile' ? 'mobile-alt' : 'desktop'}"></i> ${log.browser || '-'}</td>
                            <td>${log.failure_reason || '-'}</td>
                        </tr>
                    `).join('');
                } else {
                    const msg = logsData?.error ? `No login logs (${logsData.error})` : 'No login logs found';
                    logsTable.innerHTML = `<tr><td colspan="6" class="text-center text-muted py-4">${msg}</td></tr>`;
                }
                
                // Load active sessions
                const sessionsData = await safeFetchJson('/api/admin/security/sessions?status=active&per_page=15');
                
                const sessionsTable = document.getElementById('activeSessionsTable');
                if (sessionsData.success && (sessionsData.sessions || []).length > 0) {
                    sessionsTable.innerHTML = sessionsData.sessions.map(s => `
                        <tr>
                            <td>${s.user_name || 'Unknown'}</td>
                            <td><span class="badge bg-secondary">${s.user_type || '-'}</span></td>
                            <td><span class="badge bg-success">${s.status}</span></td>
                            <td><small>${s.ip_address || '-'}</small></td>
                            <td><i class="fas fa-${s.device_type === 'mobile' ? 'mobile-alt' : 'desktop'}"></i> ${s.browser || '-'}</td>
                            <td class="small">${s.last_activity ? new Date(s.last_activity).toLocaleString() : '-'}</td>
                            <td>
                                <button class="btn btn-sm btn-outline-danger" onclick="terminateSession('${s.session_id}')" title="Terminate Session">
                                    <i class="fas fa-times"></i>
                                </button>
                            </td>
                        </tr>
                    `).join('');
                } else {
                    const msg = sessionsData?.error ? `No active sessions (${sessionsData.error})` : 'No active sessions found';
                    sessionsTable.innerHTML = `<tr><td colspan="7" class="text-center text-muted py-4">${msg}</td></tr>`;
                }
                
                // Load failed attempts
                const failedData = await safeFetchJson('/api/admin/security/failed-attempts?days=7&per_page=15');
                
                const failedTable = document.getElementById('failedAttemptsTable');
                if (failedData.success && (failedData.attempts || []).length > 0) {
                    failedTable.innerHTML = failedData.attempts.map(a => `
                        <tr class="${a.is_blocked ? 'table-danger' : ''}">
                            <td class="small">${a.created_at ? new Date(a.created_at).toLocaleString() : '-'}</td>
                            <td>${a.email || '-'}</td>
                            <td><small>${a.ip_address || '-'}</small></td>
                            <td>${a.failure_reason || '-'}</td>
                            <td>
                                ${a.is_blocked 
                                    ? '<span class="badge bg-danger">Blocked</span>' 
                                    : '<span class="badge bg-warning">Warning</span>'}
                            </td>
                            <td class="small">${a.blocked_until ? new Date(a.blocked_until).toLocaleString() : '-'}</td>
                        </tr>
                    `).join('');
                } else {
                    const msg = failedData?.error ? `No failed attempts (${failedData.error})` : 'No failed attempts found';
                    failedTable.innerHTML = `<tr><td colspan="6" class="text-center text-muted py-4">${msg}</td></tr>`;
                }
                
            } catch (error) {
                console.error('Error loading security center:', error);
            }
        }
        
        async function terminateSession(sessionId) {
            if (!confirm('Are you sure you want to terminate this session?')) return;
            
            try {
                const data = await safeFetchJson(`/api/admin/security/sessions/${sessionId}/terminate`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                if (data.success) {
                    alert('Session terminated successfully');
                    loadSecurityCenter();
                } else {
                    alert('Failed to terminate session: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error terminating session:', error);
                alert('Error terminating session');
            }
        }
        
        document.getElementById('refreshSecurityBtn')?.addEventListener('click', loadSecurityCenter);

        // ==================== INITIALIZATION ====================
        document.addEventListener('DOMContentLoaded', function() {
            updateCurrentDate();
            loadDashboardStats();
            loadInventorySummary(); // Load inventory data
            
            // Initialize geo-health map on page load
            setTimeout(initGeoHealthMap, 300);
            
            // Auto-refresh every 30 seconds
            setInterval(loadDashboardStats, 30000);
        });
    </script>
</body>
</html>
